<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.googletagmanager.com https://www.google-analytics.com https://www.gstatic.com https://apis.google.com https://*.firebaseio.com https://firebase.googleapis.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.googletagmanager.com https://www.google-analytics.com https://www.gstatic.com https://apis.google.com https://*.firebaseio.com https://firebase.googleapis.com https://cdn.jsdelivr.net; connect-src 'self' https://ipapi.co https://www.google-analytics.com https://region1.google-analytics.com https://www.googletagmanager.com https://gameist.firebaseio.com https://*.firebaseio.com https://*.firebase.database.com https://*.googleapis.com https://identitytoolkit.googleapis.com https://gameist.firebaseapp.com https://gameist.web.app https://*.firebasedatabase.app https://*.googleapis.com https://*.google.com; font-src 'self' data: https://fonts.gstatic.com https://fonts.googleapis.com https://cdnjs.cloudflare.com; img-src 'self' data: https: blob:; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; frame-src 'self' https://www.youtube.com https://youtube.com https://www.google.com https://*.firebaseio.com; media-src 'self' https://blob:; worker-src 'self' blob:; object-src 'none'; base-uri 'self'; form-action 'self'; manifest-src 'self';">
    <title>Elementist Score Test - Gameist</title>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: all 0.3s ease;
        }
        button:hover {
            background: #3367d6;
            transform: translateY(-2px);
        }
        .status {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .info { color: #60a5fa; }
        .warning { color: #fbbf24; }
        .score-display {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        .score-value {
            font-size: 48px;
            font-weight: bold;
            color: #fbbf24;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ® Elementist Score Sending Test</h1>
        <p>Bu test Elementist oyunundan ana menÃ¼ye skor gÃ¶nderimini simÃ¼le eder.</p>
        
        <div class="score-display">
            <h3>ğŸ¯ Mevcut Skor</h3>
            <div class="score-value" id="currentScore">0</div>
            <p>Skoru artÄ±rmak iÃ§in butona bas</p>
        </div>
        
        <div>
            <button onclick="increaseScore()">ğŸ“ˆ Skoru ArtÄ±r (+1000)</button>
            <button onclick="sendScoreToMain()">ğŸ“¤ Ana MenÃ¼ye GÃ¶nder</button>
            <button onclick="testBroadcastChannel()">ğŸ“¡ BroadcastChannel Test</button>
            <button onclick="testLocalStorage()">ğŸ’¾ localStorage Test</button>
            <button onclick="clearData()">ğŸ—‘ï¸ Verileri Temizle</button>
        </div>
        
        <div id="status" class="status">Test sonuÃ§larÄ± burada gÃ¶rÃ¼necek...</div>
        
        <div id="userInfo" style="display: none; background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin: 20px 0;">
            <h3>ğŸ‘¤ KullanÄ±cÄ± Bilgisi</h3>
            <div id="userDetails"></div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="../auth-component.js?v=2"></script>
    
    <script>
        let currentScore = 0;
        let currentUser = null;
        
        const firebaseConfig = {
            apiKey: "AIzaSyD7ckcqdZWfnUx5r8uKmvu9Ikax1x5Qidk",
            authDomain: "gameist.firebaseapp.com",
            projectId: "gameist",
            storageBucket: "gameist.firebasestorage.app",
            messagingSenderId: "525659299937",
            appId: "1:525659299937:web:1c8343a25be2a994bcca20",
            measurementId: "G-WE9R0GWKM6",
            databaseURL: "https://gameist-default-rtdb.firebaseio.com/"
        };
        
        firebase.initializeApp(firebaseConfig);
        
        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info';
            statusEl.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            statusEl.scrollTop = statusEl.scrollHeight;
        }
        
        function increaseScore() {
            currentScore += 1000;
            document.getElementById('currentScore').textContent = currentScore;
            updateStatus(`ğŸ“ˆ Skor artÄ±rÄ±ldÄ±: ${currentScore}`, 'success');
        }
        
        function sendScoreToMain() {
            updateStatus('ğŸ“¤ Ana menÃ¼ye skor gÃ¶nderimi baÅŸlatÄ±lÄ±yor...', 'info');
            
            // Simulate Elementist score sending
            const user = getCurrentUser();
            
            if (!user) {
                updateStatus('âŒ KullanÄ±cÄ± giriÅŸi gerekli! Ã–nce Google ile giriÅŸ yapÄ±n.', 'error');
                return;
            }
            
            updateStatus(`ğŸ‘¤ KullanÄ±cÄ±: ${user.displayName}`, 'info');
            updateStatus(`ğŸ¯ GÃ¶nderilecek skor: ${currentScore}`, 'info');
            
            // Method 1: Use auth-component saveScore
            if (window.gameistAuth) {
                updateStatus('ğŸ”¥ gameistAuth.saveScore kullanÄ±lÄ±yor...', 'info');
                
                window.gameistAuth.saveScore('elementist', currentScore)
                    .then((result) => {
                        if (result) {
                            updateStatus('âœ… Skor Firestore\'a baÅŸarÄ±yla kaydedildi!', 'success');
                            updateStatus(`ğŸ“„ Document ID: ${result.id}`, 'info');
                        } else {
                            updateStatus('âš ï¸ Firestore baÅŸarÄ±sÄ±z oldu ama localStorage kullanÄ±ldÄ±', 'warning');
                        }
                    })
                    .catch((error) => {
                        updateStatus(`âŒ KayÄ±t hatasÄ±: ${error.message}`, 'error');
                    });
            } else {
                updateStatus('âŒ gameistAuth mevcut deÄŸil', 'error');
            }
            
            // Method 2: Direct BroadcastChannel (simulating Elementist behavior)
            try {
                const channel = new BroadcastChannel('gameist_stats');
                const message = {
                    type: 'statsUpdate',
                    game: 'elementist',
                    score: currentScore,
                    userId: user.uid,
                    displayName: user.displayName,
                    timestamp: Date.now(),
                    firestoreSuccess: true
                };
                
                channel.postMessage(message);
                updateStatus('ğŸ“¡ BroadcastChannel mesajÄ± gÃ¶nderildi', 'success');
                updateStatus(`ğŸ“¨ Mesaj: ${JSON.stringify(message)}`, 'info');
                
            } catch (error) {
                updateStatus(`âŒ BroadcastChannel hatasÄ±: ${error.message}`, 'error');
            }
            
            // Method 3: localStorage fallback
            try {
                localStorage.setItem('gameist_stats_update_needed', JSON.stringify({
                    type: 'statsUpdate',
                    game: 'elementist',
                    score: currentScore,
                    userId: user.uid,
                    displayName: user.displayName,
                    timestamp: Date.now(),
                    firestoreSuccess: true
                }));
                updateStatus('ğŸ’¾ localStorage fallback ayarlandÄ±', 'success');
            } catch (error) {
                updateStatus(`âŒ localStorage hatasÄ±: ${error.message}`, 'error');
            }
        }
        
        function testBroadcastChannel() {
            updateStatus('ğŸ“¡ BroadcastChannel test baÅŸlatÄ±lÄ±yor...', 'info');
            
            try {
                const channel = new BroadcastChannel('gameist_stats');
                
                // Listen for messages
                channel.onmessage = (event) => {
                    updateStatus(`ğŸ“¨ Mesaj alÄ±ndÄ±: ${JSON.stringify(event.data)}`, 'success');
                };
                
                // Send test message
                channel.postMessage({
                    type: 'test',
                    message: 'Elementist test mesajÄ±',
                    timestamp: Date.now()
                });
                
                updateStatus('âœ… BroadcastChannel test mesajÄ± gÃ¶nderildi', 'success');
                
            } catch (error) {
                updateStatus(`âŒ BroadcastChannel test hatasÄ±: ${error.message}`, 'error');
            }
        }
        
        function testLocalStorage() {
            updateStatus('ğŸ’¾ localStorage test baÅŸlatÄ±lÄ±yor...', 'info');
            
            try {
                const testData = {
                    type: 'statsUpdate',
                    game: 'elementist',
                    score: currentScore,
                    userId: currentUser ? currentUser.uid : 'test-user',
                    displayName: currentUser ? currentUser.displayName : 'Test User',
                    timestamp: Date.now(),
                    firestoreSuccess: true
                };
                
                localStorage.setItem('gameist_stats_update_needed', JSON.stringify(testData));
                updateStatus('âœ… Veri localStorage\'a yazÄ±ldÄ±', 'success');
                
                // Read it back
                const stored = localStorage.getItem('gameist_stats_update_needed');
                const parsed = JSON.parse(stored);
                updateStatus(`ğŸ“– Okunan veri: ${JSON.stringify(parsed)}`, 'info');
                
            } catch (error) {
                updateStatus(`âŒ localStorage test hatasÄ±: ${error.message}`, 'error');
            }
        }
        
        function getCurrentUser() {
            // Try Firebase auth first
            const firebaseUser = firebase.auth().currentUser;
            if (firebaseUser) {
                currentUser = firebaseUser;
                return firebaseUser;
            }
            
            // Fallback to localStorage
            const savedUser = localStorage.getItem('gameist_user');
            if (savedUser) {
                try {
                    const user = JSON.parse(savedUser);
                    currentUser = user;
                    return user;
                } catch (error) {
                    updateStatus(`âŒ localStorage kullanÄ±cÄ± okuma hatasÄ±: ${error.message}`, 'error');
                }
            }
            
            return null;
        }
        
        function showUserInfo(user) {
            const userInfoEl = document.getElementById('userInfo');
            const userDetailsEl = document.getElementById('userDetails');
            
            userInfoEl.style.display = 'block';
            userDetailsEl.innerHTML = `
                <p><strong>Ad:</strong> ${user.displayName}</p>
                <p><strong>Email:</strong> ${user.email}</p>
                <p><strong>UID:</strong> ${user.uid}</p>
                ${user.photoURL ? `<img src="${user.photoURL}" style="width: 50px; height: 50px; border-radius: 50%;">` : ''}
            `;
        }
        
        function clearData() {
            updateStatus('ğŸ—‘ï¸ Veriler temizleniyor...', 'info');
            
            try {
                localStorage.removeItem('gameist_stats_update_needed');
                localStorage.removeItem('gameist_local_scores');
                currentScore = 0;
                document.getElementById('currentScore').textContent = '0';
                updateStatus('âœ… Veriler temizlendi', 'success');
            } catch (error) {
                updateStatus(`âŒ Temizleme hatasÄ±: ${error.message}`, 'error');
            }
        }
        
        // Initialize
        window.addEventListener('load', () => {
            updateStatus('ğŸš€ Elementist skor testi baÅŸlatÄ±lÄ±yor...', 'info');
            
            // Check for existing user
            const user = getCurrentUser();
            if (user) {
                updateStatus(`âœ… KullanÄ±cÄ± bulundu: ${user.displayName}`, 'success');
                showUserInfo(user);
            } else {
                updateStatus('âš ï¸ KullanÄ±cÄ± giriÅŸi yapÄ±lmamÄ±ÅŸ', 'warning');
                updateStatus('ğŸ’¡ Google ile giriÅŸ yapmak iÃ§in ana menÃ¼yÃ¼ kullanÄ±n', 'info');
            }
            
            // Check for gameistAuth
            setTimeout(() => {
                if (window.gameistAuth) {
                    updateStatus('âœ… gameistAuth component yÃ¼klendi', 'success');
                } else {
                    updateStatus('âŒ gameistAuth component yÃ¼klenemedi', 'error');
                }
            }, 2000);
            
            // Listen for BroadcastChannel messages
            try {
                const channel = new BroadcastChannel('gameist_stats');
                channel.onmessage = (event) => {
                    updateStatus(`ğŸ“¨ BroadcastChannel mesajÄ±: ${JSON.stringify(event.data)}`, 'success');
                };
                updateStatus('ğŸ“¡ BroadcastChannel dinleyicisi aktif', 'success');
            } catch (error) {
                updateStatus(`âŒ BroadcastChannel dinleyici hatasÄ±: ${error.message}`, 'error');
            }
        });
    </script>
</body>
</html>
