<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    
    <title>Elementist - Neon Arena Action Game | Gameist</title>
    <meta name="description" content="Elementist is an intense action game where you master the power of elements to defeat enemies in a neon arena. Fight waves of enemies, collect power-ups, and survive in this fast-paced arcade battle game." />
    <meta name="robots" content="index,follow" />
    <link rel="canonical" href="./glowlings.html" />
    <meta property="og:site_name" content="Gameist" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Elementist - Neon Arena Action Game" />
    <meta property="og:description" content="Master the elements and survive endless waves of enemies in this intense action game. Play Elementist online for free!" />
    <meta property="og:url" content="./glowlings.html" />
    <meta property="og:image" content="../2048/logo.png" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Elementist - Neon Arena Action Game" />
    <meta
      name="twitter:description"
      content="An intense action game where you master elements, defeat enemies, and survive in a neon arena. Play free on Gameist!"
    />
    <meta name="twitter:image" content="../2048/logo.png" />
    
    <!-- Enhanced CSS Variables for Consistent Design -->
    <style>
        :root {
            /* Neon Color Palette */
            --neon-cyan: #00ffff;
            --neon-cyan-dark: #00cccc;
            --neon-cyan-light: #40ffff;
            --neon-pink: #ff00ff;
            --neon-pink-dark: #cc00cc;
            --neon-pink-light: #ff40ff;
            --neon-green: #22c55e;
            --neon-green-dark: #16a34a;
            --neon-green-light: #4ade80;
            --neon-orange: #fb923c;
            --neon-orange-dark: #ea580c;
            --neon-orange-light: #fdba74;
            --neon-red: #ef4444;
            --neon-red-dark: #dc2626;
            --neon-red-light: #f87171;
            --neon-blue: #3b82f6;
            --neon-blue-dark: #2563eb;
            --neon-blue-light: #60a5fa;
            
            /* Background Colors */
            --bg-primary: #0a0a0f;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #16213e;
            --bg-overlay: rgba(0, 0, 0, 0.85);
            
            /* Text Colors */
            --text-primary: #ffffff;
            --text-secondary: #e5e7eb;
            --text-muted: #94a3b8;
            --text-accent: var(--neon-cyan);
            
            /* Typography */
            --font-family-primary: 'Segoe UI', system-ui, -apple-system, sans-serif;
            --font-family-secondary: 'Courier New', monospace;
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.5rem;
            --font-size-3xl: 1.875rem;
            --font-size-4xl: 2.25rem;
            
            /* Spacing */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
            
            /* Border Radius */
            --radius-sm: 0.25rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
            --shadow-neon: 0 0 20px var(--neon-cyan);
            --shadow-neon-pink: 0 0 20px var(--neon-pink);
            --shadow-neon-green: 0 0 20px var(--neon-green);
            
            /* Transitions */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
        }
    </style>
    <script>
      (function(){
        try{
          var sp = new URLSearchParams(location.search || '');
          var safe = sp.get('safe');
          window.__ELEMENTIST_SAFE_MODE = (safe === '1' || safe === 'true');
          if(!window.__ELEMENTIST_SAFE_MODE) return;

          try{ document.documentElement && document.documentElement.classList.add('safe-mode'); }catch(_){ }

          // Keep the tab responsive by throttling/neutralizing the most common hot-loops.
          try{
            var _si = window.setInterval && window.setInterval.bind(window);
            if(_si){
              window.setInterval = function(fn, ms){
                try{
                  var t = (typeof ms === 'number' && isFinite(ms)) ? ms : 0;
                  if(t < 800) ms = 800;
                }catch(_){ }
                return _si(fn, ms);
              };
            }
          }catch(_){ }
          try{
            var _raf = window.requestAnimationFrame && window.requestAnimationFrame.bind(window);
            if(_raf){
              window.requestAnimationFrame = function(cb){
                return window.setTimeout(function(){ try{ cb(performance.now()); }catch(_){ } }, 120);
              };
            }
          }catch(_){ }
          try{
            if('MutationObserver' in window){
              window.MutationObserver = function(){ return { observe:function(){}, disconnect:function(){}, takeRecords:function(){ return []; } }; };
            }
          }catch(_){ }
        }catch(_){ }
      })();
    </script>
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "WebPage",
        "name": "Elementist - Gameist",
        "url": "https://gameist.fun/Elementist/glowlings.html",
        "isPartOf": {
          "@type": "WebSite",
          "name": "Gameist",
          "url": "https://gameist.fun/"
        }
      }
    </script>
    <script>
      (function(){
        try{
          if(window.__ELEMENTIST_SAFE_MODE) return;
          var s1 = document.createElement('script');
          s1.async = true;
          s1.src = 'https://www.googletagmanager.com/gtag/js?id=G-57L2NFVJYL';
          document.head.appendChild(s1);
          window.dataLayer = window.dataLayer || [];
          function gtag() { dataLayer.push(arguments); }
          gtag('js', new Date());
          gtag('config', 'G-57L2NFVJYL');
        }catch(_){ }
      })();
    </script>
    <script>
      (function(){
        try{
          if(window.__ELEMENTIST_SAFE_MODE) return;
          var s2 = document.createElement('script');
          s2.async = true;
          s2.src = 'https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9478711342689131';
          s2.setAttribute('crossorigin','anonymous');
          document.head.appendChild(s2);
        }catch(_){ }
      })();
    </script>
    <link rel="icon" href="./assets/img/logo.png" type="image/png" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css" />
    <!-- CSS Files (Updated Paths) -->
    <link rel="stylesheet" href="./css/main.css" />
    <link rel="stylesheet" href="./css/ui/shop.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Enhanced Base Styles with CSS Variables */
        html, body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: var(--font-family-primary);
            font-size: var(--font-size-base);
            line-height: 1.6;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Enhanced Typography */
        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-family-primary);
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: var(--spacing-md);
            color: var(--text-primary);
        }

        h1 { font-size: var(--font-size-4xl); }
        h2 { font-size: var(--font-size-3xl); }
        h3 { font-size: var(--font-size-2xl); }
        h4 { font-size: var(--font-size-xl); }
        h5 { font-size: var(--font-size-lg); }
        h6 { font-size: var(--font-size-base); }

        p {
            margin-bottom: var(--spacing-md);
            color: var(--text-secondary);
        }

        /* Enhanced Button Styles */
        .btn {
            font-family: var(--font-family-primary);
            font-weight: 600;
            font-size: var(--font-size-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            border: 2px solid var(--neon-cyan);
            border-radius: var(--radius-md);
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            color: var(--neon-cyan);
            cursor: pointer;
            transition: var(--transition-normal);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            box-shadow: var(--shadow-neon);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 25px var(--neon-cyan-light);
            filter: brightness(1.1);
        }

        .btn:active {
            transform: translateY(0);
            filter: brightness(0.95);
        }

        .btn.btn-green {
            border-color: var(--neon-green);
            color: var(--neon-green);
            box-shadow: var(--shadow-neon-green);
        }

        .btn.btn-green:hover {
            box-shadow: 0 0 25px var(--neon-green-light);
        }

        .btn.btn-red {
            border-color: var(--neon-red);
            color: var(--neon-red);
            box-shadow: 0 0 20px var(--neon-red);
        }

        .btn.btn-red:hover {
            box-shadow: 0 0 25px var(--neon-red-light);
        }

        /* Mobile in-game menu (pause) button styling is applied inline where used inside #touchControls */
        
        body {
            height: 100%;
            font-family: var(--font-family-primary);
            background: radial-gradient(circle at center, #0a0a1a 0%, #000000 100%);
            color: var(--text-primary);
            overflow: hidden;
            /* Use small viewport unit to avoid URL bar shrinking issues on mobile */
            height: 100svh;
            /* Respect device safe areas (iOS notch/home indicator) */
            padding-top: env(safe-area-inset-top);
            padding-right: env(safe-area-inset-right);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
        }
        /* Shop items */
        .shop-blurb {
            color: #e5f4ff; /* higher contrast */
            font-size: 12px; /* do not enlarge */
            font-weight: 600; /* semibold for emphasis */
            letter-spacing: 0.1px;
            text-shadow: 0 0 6px rgba(173, 216, 255, 0.25);
        }
        .shop-desc {
            color: #b6c2d1;
            font-size: 12px;
        }
        .shop-cost {
            color: #7dd3fc;
            font-size: 12px;
            margin-top: 6px;
        }
        .shop-name { font-weight: 700; margin-bottom: 6px; }
        .shop-item {
            padding: 12px;
            background: #1f2937;
            color: #fff;
            border: 1px solid #334155;
            border-radius: 8px;
            cursor: pointer;
            user-select: none;
            transition: border-color .15s ease, box-shadow .15s ease, transform .05s ease, opacity .15s ease, filter .15s ease;
            position: relative; /* anchor for badge */
        }
        .shop-item:hover { border-color: #60a5fa; box-shadow: 0 0 0 2px rgba(96,165,250,0.15) inset; }
        .shop-item:active { transform: translateY(1px); }
        .shop-item small { display: block; }
        .shop-icon {
            display: inline-block;
            width: 20px;
            text-align: center;
            margin-right: 6px;
            filter: drop-shadow(0 0 4px rgba(255,255,255,0.2));
        }
        .shop-title {
            display: block;
            text-align: center;
            font-weight: 700;
            margin-bottom: 8px;
        }
        /* Skin visual preview inside item card */
        .skin-preview {
            position: relative;
            width: 100%;
            height: 96px;
            border-radius: 8px;
            background: radial-gradient(120px 60px at 70% 40%, rgba(148,163,184,0.15), transparent 65%),
                        linear-gradient(180deg, rgba(11,18,32,0.9), rgba(15,23,42,0.9));
            box-shadow: inset 0 0 24px rgba(2,6,23,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            overflow: hidden;
        }
        .skin-stage { width: 140px; height: 84px; display:block; }
        .skin-ambient {
            position:absolute; inset: -10%;
            background: radial-gradient(closest-side, rgba(255,255,255,0.035), transparent 70%);
            filter: blur(8px);
            pointer-events:none;
        }

        /* Affordability states */
        .shop-item.affordable { border-color: #22c55e; box-shadow: 0 0 0 2px rgba(34,197,94,0.12) inset; }
        .shop-item.unaffordable { border-color: #ef4444; opacity: 0.78; filter: saturate(0.9) brightness(0.98); }
        .shop-cost.affordable { color: #22c55e; }
        .shop-cost.unaffordable { color: #ef4444; }

        /* Special badge */
        .shop-badge { position: absolute; top: 8px; right: 8px; padding: 2px 8px; font-size: 12px; border-radius: 999px; pointer-events: none; backdrop-filter: blur(4px); }
        .shop-badge.special { background: rgba(34,197,94,0.12); border: 1px solid #22c55e; color: #22c55e; text-shadow: 0 0 6px rgba(34,197,94,0.25); }

        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh; /* use vh for consistent fullscreen sizing on desktop */
            background: radial-gradient(circle at center, #0a0a1a 0%, #000000 100%);
            cursor: none;
        }

        #ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        /* Debug overlay (F3) */
        #debugOverlay {
            position: absolute;
            top: 16px;
            right: 16px;
            display: none;
            min-width: 220px;
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid rgba(203,213,225,0.35);
            background: rgba(2,6,23,0.75);
            color: #e2e8f0;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 12px;
            line-height: 1.35;
            pointer-events: none;
            box-shadow: 0 0 14px rgba(148,163,184,0.25);
        }
        #debugOverlay .title { color:#93c5fd; font-weight:700; margin-bottom:4px; }
        #debugOverlay .row { display:flex; justify-content: space-between; gap:10px; }
        #debugOverlay .k { color:#a5b4fc; }
        #debugOverlay .v { color:#e5e7eb; }

        

        /* Touch controls */
        #touchControls { display:none; pointer-events: none; position: absolute; inset: 0; z-index: 30; }
        #pauseBtnMobile { backdrop-filter: none !important; -webkit-backdrop-filter: none !important; }
        #joystick {
            position: absolute; bottom: 24px; left: 24px;
            width: 102px; height: 102px; border-radius: 50%;
            background: rgba(255,255,255,0.06);
            border: 2px solid rgba(0,255,255,0.35);
            box-shadow: 0 0 18px rgba(0,255,255,0.25) inset;
            pointer-events: all;
            touch-action: none;
        }
        #joystickNub {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 39px; height: 39px; border-radius: 50%;
            background: rgba(0,255,255,0.4);
            border: 2px solid rgba(0,255,255,0.8);
            box-shadow: 0 0 10px rgba(0,255,255,0.6);
            pointer-events: none;
        }
        #skillBtn {
            position: absolute; bottom: 34px; right: 28px;
            width: 73px; height: 73px; border-radius: 50%;
            background: rgba(76,29,149,0.65);
            color: #e5e7eb; font-weight: 800; letter-spacing: 0.5px;
            border: 2px solid #7c3aed; box-shadow: 0 0 18px rgba(124,58,237,0.5);
            pointer-events: all; touch-action: manipulation; cursor: pointer;
        }

        /* Dodge button mirrors skill style; placed to the left */
        #dodgeBtn {
            position: absolute; bottom: 34px; right: 128px;
            width: 73px; height: 73px; border-radius: 50%;
            background: rgba(2,6,23,0.55);
            border: 2px solid rgba(0,255,255,0.85);
            color: #67e8f9;
            font-weight: 900;
            letter-spacing: 1px;
            box-shadow: 0 0 14px rgba(0,255,255,0.25);
            pointer-events: all;
            touch-action: manipulation;
            cursor: pointer;
        }

        /* Touch QoL: slightly larger HUD controls on touch devices */
        body.touch #joystick { width: 122px; height: 122px; bottom: 22px; left: 18px; }
        body.touch #joystickNub { width: 48px; height: 48px; }
        body.touch #skillBtn { width: 86px; height: 86px; bottom: 28px; right: 22px; }
        body.touch #dodgeBtn { width: 86px; height: 86px; bottom: 28px; right: 130px; }
        body.touch #pauseBtnMobile { width: 52px !important; height: 52px !important; }

        /* Landscape enforcement: show rotate overlay on portrait */
        #rotateOverlay { display:none; position: fixed; inset: 0; background: #000; color:#fff; z-index: 99999; align-items: center; justify-content: center; text-align: center; padding: 24px; }
        #rotateOverlay .box { max-width: 520px; margin:auto; border:2px solid #0ea5e9; border-radius:14px; padding:18px; background:#04131b; box-shadow:0 0 24px rgba(14,165,233,0.35); }
        @media (orientation: portrait) {
            #rotateOverlay { display:flex; }
        }
        body.force-landscape #rotateOverlay { display:none !important; }

        #langToggle {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 8px;
            z-index: 20;
            pointer-events: all;
        }
        .lang-btn {
            padding: 6px 10px;
            border: 1px solid #00ffff;
            border-radius: 6px;
            background: rgba(0,0,0,0.6);
            color: #00ffff;
            cursor: pointer;
        }

        #startScreen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #ffffff;
            background: rgba(0, 0, 0, 0.5);
            padding: clamp(16px, 2.2vw, 28px);
            border-radius: 12px;
            border: 1px solid rgba(0,255,255,0.35);
            pointer-events: all;
            width: min(92vw, 760px);
        }

        #startScreen h1 {
            color: #00ffff;
            font-size: clamp(24px, 4.2vw, 40px);
            margin-bottom: clamp(12px, 1.6vw, 18px);
        }

        /* Ensure comfortable spacing after subtitle on all devices */
        #startSubtitle { margin-bottom: 18px; }

        /* Touch devices: compact the entire start menu */
        body.touch #startScreen { width: min(82vw, 520px); padding: 8px 10px; transform: translate(-50%, -50%) scale(0.80); transform-origin: center; }
        body.touch #startScreen h1 { font-size: clamp(15px, 2.2vw, 22px); margin-bottom: 6px; }
        body.touch #startSubtitle { font-size: clamp(11px, 1.4vw, 13px); margin-bottom: 16px; opacity: 0.9; }
        body.touch #colorLabel, body.touch #shapeLabel { font-size: clamp(13px, 2vw, 15px); }
        body.touch .color-selection { gap: clamp(6px, 1.2vw, 9px); margin: clamp(6px, 1.2vw, 9px) 0; }
        body.touch .color-btn { width: clamp(22px, 3.4vw, 30px); height: clamp(22px, 3.4vw, 30px); }
        body.touch .shape-selection { gap: clamp(8px, 1.6vw, 11px); margin: clamp(8px, 1.6vw, 11px) 0; }
        body.touch .shape-btn { width: clamp(36px, 5vw, 48px); height: clamp(36px, 5vw, 48px); font-size: clamp(14px, 2.4vw, 20px); }
        body.touch #startBtn { margin-top: 6px; }
        body.touch #startScreen .primary-btn { margin-top: 6px !important; }

        /* Never show start screen during gameplay */
        body.playing #startScreen { display: none !important; }
        /* Hide Run Stats panel during gameplay (desktop and mobile) */
        body.playing #statsPanel { display: none !important; }

        .element-selection {
            display: flex;
            justify-content: center;
            gap: clamp(10px, 2vw, 18px);
            margin: clamp(10px, 2vw, 18px) 0;
            flex-wrap: wrap;
        }

        .element-btn {
            padding: clamp(10px, 2.2vw, 14px) clamp(16px, 2.8vw, 22px);
            border: 2px solid;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: clamp(14px, 1.8vw, 16px);
            font-weight: 700;
        }

        .element-btn.fire {
            border-color: #ff4444;
            color: #ff4444;
            text-shadow: none;
        }
        /* Keep fire as outlined even when selected (no filled background) */
        .element-btn.fire.selected {
            background: rgba(0,0,0,0.7) !important;
            color: #ff4444 !important;
            box-shadow: 0 0 20px #ff4444;
        }

        .element-btn.water {
            border-color: #4444ff;
            color: #4444ff;
        }

        .element-btn.air {
            border-color: #44ff44;
            color: #44ff44;
        }

        .element-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px currentColor;
        }

        .element-btn.selected {
            background: currentColor;
            color: black;
        }

        .color-selection {
            display: flex;
            justify-content: center;
            gap: clamp(8px, 1.8vw, 12px);
            margin: clamp(10px, 2vw, 16px) 0;
            flex-wrap: wrap;
        }

        .color-btn {
            width: clamp(28px, 4vw, 40px);
            height: clamp(28px, 4vw, 40px);
            border: 2px solid white;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }

        .color-btn:hover {
            transform: scale(1.2);
            box-shadow: 0 0 15px currentColor;
        }

        .color-btn.selected {
            border-width: 4px;
            transform: scale(1.3);
        }

        .shape-selection {
            display: flex;
            justify-content: center;
            gap: clamp(12px, 2.2vw, 18px);
            margin: clamp(12px, 2.2vw, 18px) 0;
            flex-wrap: wrap;
        }

        .shape-btn {
            width: clamp(44px, 6vw, 60px);
            height: clamp(44px, 6vw, 60px);
            border: 2px solid #00ffff;
            background: rgba(0, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(18px, 3.2vw, 24px);
        }

        .shape-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 15px #00ffff;
        }

        .shape-btn.selected {
            background: rgba(0, 255, 255, 0.3);
            box-shadow: 0 0 20px #00ffff;
        }


        @keyframes playBreath {
            0%, 100% {
              transform: scale(1);
              filter: brightness(1) hue-rotate(0deg);
              box-shadow: 0 0 0 rgba(0,255,255,0);
              background-position: 0% 50%;
            }
            50% {
              transform: scale(1.03);
              filter: brightness(1.08) hue-rotate(20deg);
              box-shadow: 0 0 26px rgba(0,255,255,0.45), 0 0 38px rgba(255,0,255,0.18);
              background-position: 100% 50%;
            }
        }

        #startBtn {
            padding: clamp(12px, 1.8vw, 16px) clamp(18px, 3vw, 28px);
            background: linear-gradient(90deg, #00ffff, #ff00ff, #7c3aed, #00ffff);
            background-size: 300% 300%;
            border: 2px solid rgba(0,255,255,0.65);
            border-radius: 14px;
            color: white;
            font-size: clamp(16px, 2.4vw, 22px);
            font-weight: 800;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.2s ease, filter 0.15s ease;
            display: block;
            width: clamp(190px, 58vw, 320px);
            margin: 0 auto;
            white-space: nowrap;
            text-align: center;
            box-sizing: border-box;
            text-shadow: 0 0 10px rgba(0,255,255,0.25);
            box-shadow: 0 0 18px rgba(0,255,255,0.22);
            animation: playBreath 2.8s ease-in-out infinite;
            will-change: transform;
        }

        /* Mobile: make Play button the most dominant element */
        @media (hover: none) and (pointer: coarse) {
            #startBtn {
                width: min(94vw, 520px);
                font-size: clamp(19px, 5.6vw, 26px);
                padding: 18px 24px;
                border-radius: 16px;
                border-width: 3px;
                box-shadow: 0 0 46px rgba(0,255,255,0.55), 0 0 30px rgba(255,0,255,0.28);
                text-shadow: 0 0 16px rgba(255,255,255,0.18), 0 0 18px rgba(0,255,255,0.35);
            }
        }

        @media (max-width: 380px) {
            #startBtn {
                width: min(96vw, 520px);
                font-size: clamp(20px, 6.2vw, 26px);
                padding: 18px 22px;
            }
        }

        #startBtn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 34px rgba(0,255,255,0.55), 0 0 18px rgba(255,0,255,0.22);
        }

        #startBtn:active {
            transform: scale(0.99);
            filter: brightness(1.10);
        }

        /* Primary action style reused for other buttons */
        .primary-btn {
            padding: clamp(7px, 1.4vw, 10px) clamp(10px, 2.2vw, 18px);
            background: rgba(15, 23, 42, 0.92);
            border: 1px solid rgba(56, 189, 248, 0.55);
            border-radius: 10px;
            color: white;
            font-size: clamp(14px, 2vw, 18px);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: block;
            width: clamp(140px, 38vw, 180px);
            margin: 0 auto;
            white-space: nowrap;
            text-align: center;
            box-sizing: border-box;
        }
        .primary-btn:hover { transform: scale(1.03); box-shadow: 0 0 18px rgba(56,189,248,0.35); background: rgba(15, 23, 42, 0.98); }

        /* Force CLOSE/KAPAT labels to render in uppercase regardless of language mapping */
        .menu-btn[data-lang="close"],
        .primary-btn[data-lang="close"] {
            text-transform: uppercase !important;
            letter-spacing: 0.5px;
        }

        /* Social links */
        .social-links { margin-top: clamp(18px, 3vw, 28px); }
        .social-links h3 { font-size: clamp(14px, 1.8vw, 18px); color:#7dd3fc; margin-bottom: 8px; }
        /* Stylized brand header */
        .social-links .brand-242 {
            display: inline-block;
            font-weight: 800;
            letter-spacing: 1px;
            background: linear-gradient(90deg, #7dd3fc, #a78bfa, #f472b6);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 12px rgba(125,211,252,0.25);
            position: relative;
        }
        .social-links .brand-242::after {
            content: "";
            display: block;
            width: 120px;
            height: 2px;
            margin: 6px auto 0;
            background: linear-gradient(90deg, transparent, rgba(125,211,252,0.85), transparent);
            box-shadow: 0 0 12px rgba(125,211,252,0.5);
            border-radius: 999px;
        }
        .social-icons { display:flex; justify-content:center; gap: clamp(8px, 1.6vw, 14px); flex-wrap: wrap; }
        .social-link { position:relative; overflow:hidden; width: 40px; height: 40px; border-radius: 50%; display:flex; align-items:center; justify-content:center; color:#0ea5e9; border:1px solid rgba(14,165,233,0.6); background: rgba(0,0,0,0.25); box-shadow:0 0 10px rgba(14,165,233,0.25), inset 0 0 10px rgba(14,165,233,0.15); transition: transform .2s, box-shadow .2s, color .2s, border-color .2s; text-decoration: none; }
        .social-link:hover, .social-link:focus, .social-link:active { text-decoration: none; }
        .social-link::before { content:""; position:absolute; inset:0; background: radial-gradient(circle at 50% 45%, currentColor 22%, rgba(0,0,0,0) 70%); opacity: .18; pointer-events:none; }
        .social-link:hover { transform: translateY(-2px); box-shadow:0 0 14px rgba(14,165,233,0.45), inset 0 0 14px rgba(14,165,233,0.2); }
        .social-link.instagram { color:#e1306c; border-color: rgba(225,48,108,.6); }
        .social-link.youtube { color:#ff3333; border-color: rgba(255,51,51,.6); }
        .social-link.twitter { color:#1da1f2; border-color: rgba(29,161,242,.6); }
        .social-link.facebook { color:#1877f2; border-color: rgba(24,119,242,.6); }
        .social-link.discord { color:#5865f2; border-color: rgba(88,101,242,.6); }
        .social-link i { font-size: 18px; color:#ffffff; position: relative; z-index: 1; }

        /* Touch: make icons smaller */
        body.touch .social-link { width: 34px; height: 34px; }
        body.touch .social-link i { font-size: 16px; }

        /* Mobile landscape: ensure menu fits comfortably */
        @media (orientation: landscape) {
            body.touch #startBtn,
            body.touch .primary-btn {
                font-size: clamp(13px, 1.6vw, 16px);
                padding: clamp(9px, 1.6vw, 12px) clamp(16px, 2.6vw, 24px);
            }
        }

        /* Touch-specific proportional sizing */
        @media (orientation: portrait) {
            body.touch #startBtn,
            body.touch .primary-btn {
                width: clamp(120px, 40vw, 150px);
                font-size: clamp(11px, 3.2vw, 14px);
                padding: clamp(6px, 2.8vw, 9px) clamp(9px, 4.2vw, 14px);
            }
        }
        @media (orientation: landscape) {
            body.touch #startBtn,
            body.touch .primary-btn {
                width: clamp(120px, 34vw, 150px);
                font-size: clamp(10px, 1.4vw, 13px);
                padding: clamp(5px, 1.2vw, 8px) clamp(8px, 2.2vw, 12px);
            }
            /* Proportional scale for the whole start screen on touch landscape */
            body.touch #startScreen { transform: translate(-50%, -50%) scale(0.70); }
        }

        #gameUI {
            position: fixed;
            top: 20px;
            right: 20px;
            display: none;
            pointer-events: none;
            z-index: 1005;
        }

        /* Show gameUI when playing */
        body.playing #gameUI {
            display: block !important;
        }

        /* Score is now top-right - larger, more prominent */
        #gameUI .stat { min-width: 140px; }
        #gameUI #score { font-size: 24px; font-weight: 900; color: #22c55e; text-shadow: 0 0 12px rgba(34, 197, 94, 0.6); }
        #scoreLabel { font-size: 12px; color: #94a3b8; }

        /* Smaller HUD on touch devices (joystick/skill excluded) */
        body.touch #gameUI .stat { font-size: 11px; }
        body.touch #gameUI #score { font-size: 18px; }
        body.touch #gameUI #scoreLabel { font-size: 10px; }
        /* Smaller timer box on mobile */
        body.touch #timer { font-size: clamp(12px, 3vw, 16px); padding: 4px 8px; border-width: 1px; border-radius: 8px; }
        body.touch #livesDisplay { font-size: 14px !important; letter-spacing: 2px !important; }
        body.touch .ability-cooldown .ability-icon { width: 44px; height: 44px; font-size: 16px; }
        body.touch .stat { padding: 6px; border-width: 1px; }
        /* On mobile, keep perfect centering and adjust spacing/typography instead of scaling */
        body.touch #inGameMenu {
            transform: translate(-50%, -50%);
            padding: var(--spacing-md);
            width: min(280px, 90vw);
            max-height: min(68vh, 420px);
            overflow: auto;
            border-radius: var(--radius-xl);
        }
        body.touch #inGameMenu .menu-btn { 
            padding: var(--spacing-sm) var(--spacing-md); 
            font-size: var(--font-size-xs); 
            border-radius: var(--radius-md);
        }
        body.touch #inGameMenu h3 { 
            font-size: var(--font-size-lg); 
            margin-bottom: var(--spacing-md); 
        }
        body.touch #inGameMenu label { 
            font-size: var(--font-size-xs); 
        }
        body.touch #inGameMenu input[type="range"] { 
            height: 6px; 
        }
        body.touch #inGameMenu input[type="range"]::-webkit-slider-thumb {
            width: 16px;
            height: 16px;
        }

        @media (max-height: 600px) {
            body.touch #inGameMenu { 
                width: min(92vw, 300px); 
                padding: var(--spacing-sm); 
                border-radius: var(--radius-lg);
            }
            body.touch #inGameMenu .menu-btn { 
                padding: var(--spacing-xs) var(--spacing-sm); 
                font-size: var(--font-size-xs); 
            }
            body.touch #inGameMenu h3 { 
                font-size: var(--font-size-base); 
                margin-bottom: var(--spacing-sm);
            }
            body.touch #inGameMenu label { 
                font-size: var(--font-size-xs); 
            }
        }

        /* Ensure mobile touch buttons are always tappable when playing */
        #touchControls { position: fixed; inset: 0; z-index: 30000; pointer-events: none; }
        #skillBtn, #dodgeBtn {
            pointer-events: auto;
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
            z-index: 30010;
        }
        body.touch #gameOverScreen h2 { font-size: 20px !important; }
        body.touch #gameOverScreen #finalStats { font-size: 12px !important; }
        body.touch #gameOverScreen button { padding: 8px 12px !important; font-size: 14px !important; }
        body.touch #shopOverlay > div { width: 92vw !important; max-width: 92vw !important; font-size: 90%; }

        .stat {
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            border: 1px solid #00ffff;
        }

        #leaderboard {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #00ffff;
            display: none;
        }

        /* Compact Stats Overlay (persistent run history) */
        #statsPanel {
            position: fixed !important;
            top: 52px !important;
            right: 6px !important;
            width: 152px !important;
            padding: 6px !important;
            border-radius: 8px;
            border: 1px solid rgba(148,163,184,0.35);
            background: rgba(2,6,23,0.78);
            box-shadow: 0 0 18px rgba(14,165,233,0.18);
            color: #e5e7eb;
            font-size: 10px !important;
            z-index: 1200;
            pointer-events: auto;
        }
        #statsPanel h3 {
            margin: 0 0 8px 0;
            font-size: 10px !important;
            color: #7dd3fc;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        #statsSummary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px 8px;
            margin-bottom: 8px;
        }
        #statsSummary div { font-size: 8px !important; }
        #statsSummary strong[data-lang="bestScoreLabel"] {
            color: #22c55e !important;
            font-weight: 900 !important;
            text-shadow: 0 0 8px rgba(34, 197, 94, 0.4);
        }
        #statsLastRuns {
            list-style: none;
            margin: 0;
            padding: 0;
            display: grid;
            gap: 4px;
            max-height: 70px !important;
            overflow: auto;
            font-size: 7.6px !important;
            -webkit-overflow-scrolling: touch; /* smooth scrolling on iOS */
            touch-action: pan-y; /* allow vertical touch scroll */
        }
        /* Themed scrollbar for Run Stats (Firefox + WebKit) */
        /* Firefox */
        #statsLastRuns { scrollbar-width: thin; scrollbar-color: #43526b #0b1220; }
        /* Chrome/Edge/Safari */
        #statsLastRuns::-webkit-scrollbar { width: 10px; }
        #statsLastRuns::-webkit-scrollbar-track {
          background: #0b1220;
          border-radius: 8px;
          box-shadow: inset 0 0 0 1px rgba(51,65,85,0.35);
        }
        #statsLastRuns::-webkit-scrollbar-thumb {
          background: linear-gradient(180deg, #334155, #1f2937);
          border-radius: 8px;
          border: 2px solid #0b1220;
          box-shadow: 0 0 10px rgba(14,165,233,0.15);
        }
        #statsLastRuns::-webkit-scrollbar-thumb:hover {
          background: linear-gradient(180deg, #3f5069, #263142);
          box-shadow: 0 0 12px rgba(14,165,233,0.25);
        }
        #statsLastRuns li { opacity: 0.9; }
        /* Phones/tablets: shrink Run Stats panel regardless of width (touch detection) */
        @media (hover: none) and (pointer: coarse) {
            #statsPanel { width: 138px; right: 6px; top: 50px; padding: 4px; }
            #statsPanel h3 { font-size: 10px; }
            #statsSummary { gap: 2px 4px; }
            #statsSummary div { font-size: 8px; }
            #statsLastRuns { max-height: 78px; font-size: 7.8px; }
        }
        /* Extra small touch screens */
        @media (hover: none) and (pointer: coarse) and (max-width: 420px) {
            #statsPanel { width: 128px; right: 6px; top: 48px; padding: 4px; }
            #statsPanel h3 { font-size: 9.5px; }
            #statsSummary div { font-size: 7.8px; }
            #statsLastRuns { max-height: 72px; font-size: 7.6px; }
        }

        /* Compact the start menu for short landscape mobile screens */
        @media (orientation: landscape) and (max-height: 520px) {
            #startScreen { width: min(90vw, 560px); padding: 8px 10px; border-radius: 10px; }
            #startScreen h1 { font-size: clamp(18px, 2.6vw, 26px); margin-bottom: 6px; }
            #startSubtitle { font-size: clamp(11px, 1.4vw, 13px); margin-bottom: 16px; }
            .element-selection { gap: 8px; margin: 8px 0; }
            .element-btn { padding: 6px 12px; font-size: 12px; }
            .color-selection { gap: 6px; margin: 8px 0; }
            .color-btn { width: 24px; height: 24px; }
            .shape-selection { gap: 8px; margin: 8px 0; }
            .shape-btn { width: 36px; height: 36px; font-size: 16px; }
            #playerName { width: min(54vw, 220px); padding: 6px; font-size: 12px; }
            #startBtn { padding: 8px 12px; font-size: 13px; }
            .menu-btn { padding: 6px 10px; font-size: 13px; }
            /* Extra scale on very short screens */
            body.touch #startScreen { transform: translate(-50%, -50%) scale(0.64); }
        }

        #timer {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 20px;
            border-radius: 10px;
            border: 2px solid #ff4444;
            font-size: 24px;
            font-weight: bold;
            color: #ff4444;
            display: none;
            pointer-events: none;
        }

        /* Bottom consumable bar */
        #consumableBar {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            bottom: 18px;
            display: none; /* hidden on menus; JS can toggle via body.playing */
            gap: 10px;
            /* equal top/bottom padding */
            padding: 14px 16px;
            border-radius: 14px;
            background: rgba(2,6,23,0.72);
            border: 1px solid rgba(51,65,85,0.75);
            box-shadow: 0 10px 26px rgba(0,0,0,0.45);
            z-index: 10005;
            align-items: center;
            min-height: 72px; /* 48px slot + vertical padding ensures full containment */
            flex-wrap: nowrap;
            height: 72px;
            max-height: 72px;
            overflow: hidden;
            pointer-events: auto;
        }
        .consumable-slot { pointer-events: auto; }
        body.playing #consumableBar { display: flex; }
        /* Also show bar while the shop is open for reordering/selling and make it clickable above overlay */
        body.shop-open #consumableBar { display: flex; z-index: 10020; bottom: 22px; }
        /* When attached under the shop, slightly adjust visuals to blend */
        body.shop-open #consumableBar.attached-to-shop {
            border-color: rgba(51,65,85,0.85);
            background: rgba(2,6,23,0.62);
            box-shadow: 0 10px 26px rgba(0,0,0,0.45);
            width: max-content; max-width: 92vw;
            padding: 14px 16px; /* equal top/bottom padding while attached */
            min-height: 72px;
        }
        .consumable-slot {
            width: 48px; height: 48px; border-radius: 10px;
            background: rgba(0,0,0,0.6);
            border: 1px solid #334155;
            display: grid; place-items: center; color:#e2e8f0;
            position: relative;
        }
        .consumable-slot.cooldown { filter: grayscale(1) brightness(0.8); }
        .consumable-slot .key {
            position: absolute; top: 4px; left: 6px; font-size: 10px; color:#93c5fd; opacity:.9;
        }
        .consumable-slot .timer {
            position: absolute; top: 4px; right: 6px; font-size: 10px; color:#cbd5e1; opacity:.85;
        }
        .consumable-slot .count {
            position: absolute; bottom: -8px; right: -8px; min-width: 16px; height: 16px; border-radius: 8px; background:#0f172a; border:1px solid #334155; display:flex; align-items:center; justify-content:center; font-size: 10px; color:#e2e8f0;
        }
        @media (max-width: 800px) {
            #consumableBar { bottom: 96px; }
        }

        /* Shop box polish */
        .shop-box {
            background: linear-gradient(180deg, rgba(2,6,23,0.92), rgba(2,8,23,0.96));
            border: 1px solid rgba(51,65,85,0.9) !important;
            box-shadow: 0 12px 34px rgba(0,0,0,0.55), inset 0 0 32px rgba(14,165,233,0.06);
            backdrop-filter: blur(6px);
        }
        #shopTabs button {
            border-radius: 999px;
            background: rgba(15,23,42,0.65);
            border-width: 1px;
        }
        #shopTabs button.active {
            background: linear-gradient(90deg, rgba(56,189,248,0.18), rgba(168,85,247,0.18));
            box-shadow: 0 0 0 1px rgba(148,163,184,0.25) inset;
        }
        #shopTabs button:focus { outline: 2px solid rgba(255,255,255,0.15); outline-offset: 2px; }
        #shopStatPanel { box-shadow: inset 0 0 16px rgba(2,8,23,0.6); }
        .shop-divider { height:1px; background: linear-gradient(90deg, transparent, rgba(148,163,184,0.25), transparent); margin:8px 0; }

        /* Shop item rarity looks */
        .shop-item { position: relative; padding-bottom: 36px; /* reserve space for bottom-right badge */ }
        .shop-item.rarity-common { border-color:#334155; }
        .shop-item.rarity-uncommon { border-color:#22c55e; box-shadow: 0 0 0 1px rgba(34,197,94,0.25) inset; }
        .shop-item.rarity-rare { border-color:#3b82f6; box-shadow: 0 0 0 1px rgba(59,130,246,0.25) inset; }
        .shop-item.rarity-epic { border-color:#a855f7; box-shadow: 0 0 0 1px rgba(168,85,247,0.25) inset; }
        .shop-item .price-badge { position:absolute; bottom:8px; right:8px; font-size:12px; padding:2px 8px; border-radius:999px; background:rgba(15,23,42,0.8); border:1px solid #334155; color:#7dd3fc; pointer-events:none; }
        /* Keep cost text from sliding under the badge */
        .shop-item .shop-cost { padding-right: 76px; white-space: nowrap; }
        .shop-item.locked { filter: grayscale(0.1) brightness(0.95); }
        .shop-item .lock-overlay { position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:rgba(2,6,23,0.55); border-radius:8px; }
        .shop-item.locked .lock-overlay { display:flex; }
        .lock-overlay .chain { color:#93c5fd; text-shadow:0 0 10px rgba(147,197,253,0.35); font-size:18px; }
        
        /* Mobile scaling for shop overlay */
        #shopOverlay > div { max-height: 90vh; overflow: auto; }
        /* Themed scrollbar for the shop overlay (Firefox + WebKit) */
        /* Firefox */
        #shopOverlay > div { scrollbar-width: thin; scrollbar-color: #43526b #0b1220; }
        /* Chrome/Edge/Safari */
        #shopOverlay > div::-webkit-scrollbar { width: 10px; }
        #shopOverlay > div::-webkit-scrollbar-track {
          background: #0b1220;
          border-radius: 8px;
          box-shadow: inset 0 0 0 1px rgba(51,65,85,0.35);
        }
        #shopOverlay > div::-webkit-scrollbar-thumb {
          background: linear-gradient(180deg, #334155, #1f2937);
          border-radius: 8px;
          border: 2px solid #0b1220;
        }
        #shopOverlay > div::-webkit-scrollbar-thumb:hover {
          background: linear-gradient(180deg, #3f5069, #263142);
        }
        @media (max-width: 920px) {
            #shopOverlay > div { width: 92vw !important; }
        }
        @media (max-width: 760px) {
            #shopOverlay > div { width: 94vw !important; font-size: 90% !important; padding: 14px !important; }
            #shopItems { grid-template-columns: repeat(2, 1fr) !important; }
            #shopStatPanel { display: none; }
        }

        /* Keep gameOverScreen hidden by default; runtime styles will handle layout */
        #gameOverScreen { display: none; }

        #inGameMenu {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(10, 10, 15, 0.98), rgba(26, 26, 46, 0.95));
            padding: var(--spacing-xl);
            border-radius: var(--radius-2xl);
            border: 2px solid var(--neon-cyan);
            box-shadow: 0 0 15px var(--neon-cyan), 0 4px 20px rgba(0, 0, 0, 0.3);
            text-align: center;
            display: none;
            pointer-events: all;
            z-index: 20000;
            width: min(520px, 92vw);
            box-sizing: border-box;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        /* While in-game menu is open, keep HUD below and non-interactive */
        body.menu-open #consumableBar { pointer-events: none; z-index: 9999 !important; }
        body.menu-open .ability-cooldown { pointer-events: none; z-index: 9999 !important; }
        body.menu-open #skillBtn,
        body.menu-open #dodgeBtn {
            pointer-events: none !important;
            z-index: 9999 !important;
            filter: grayscale(0.2) opacity(0.85);
        }

        #inGameMenu h3 {
            color: var(--neon-cyan);
            font-size: var(--font-size-2xl);
            font-weight: 700;
            margin-bottom: var(--spacing-lg);
            text-shadow: 0 0 20px var(--neon-cyan);
            letter-spacing: 2px;
        }

        #inGameMenu .menu-btn {
            width: 100%;
            padding: var(--spacing-md) var(--spacing-lg);
            margin: var(--spacing-sm) 0;
            border: 2px solid var(--neon-cyan);
            border-radius: var(--radius-lg);
            background: linear-gradient(135deg, rgba(0, 20, 40, 0.8), rgba(0, 10, 30, 0.8));
            color: var(--neon-cyan);
            font-family: var(--font-family-primary);
            font-weight: 600;
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: var(--transition-normal);
            box-shadow: 0 2px 8px rgba(0, 255, 255, 0.15);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        #inGameMenu .menu-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 255, 255, 0.2);
            filter: brightness(1.1);
            background: linear-gradient(135deg, rgba(0, 30, 60, 0.9), rgba(0, 15, 45, 0.9));
        }

        #inGameMenu .menu-btn:active {
            transform: translateY(0);
            filter: brightness(0.95);
        }

        /* Important action buttons - Resume (green) and Back to Menu (red) */
        #inGameMenu #resumeBtn {
            border-color: var(--neon-green);
            color: var(--neon-green);
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(22, 163, 74, 0.15));
            box-shadow: 0 2px 8px rgba(34, 197, 94, 0.2);
        }

        #inGameMenu #resumeBtn:hover {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(22, 163, 74, 0.25));
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
            filter: brightness(1.1);
        }

        #inGameMenu #backToMenuIngameBtn {
            border-color: var(--neon-red);
            color: var(--neon-red);
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.15));
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);
        }

        #inGameMenu #backToMenuIngameBtn:hover {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.3), rgba(220, 38, 38, 0.25));
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
            filter: brightness(1.1);
        }

        #inGameMenu label {
            color: var(--neon-cyan-light);
            font-size: var(--font-size-sm);
            font-weight: 500;
            margin: var(--spacing-sm) 0 var(--spacing-xs);
            display: block;
        }

        #inGameMenu input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: var(--radius-sm);
            background: linear-gradient(90deg, var(--neon-cyan-dark), var(--neon-cyan));
            outline: none;
            opacity: 0.8;
            transition: var(--transition-fast);
            margin: var(--spacing-sm) 0;
        }

        #inGameMenu input[type="range"]:hover {
            opacity: 1;
        }

        #inGameMenu input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--neon-cyan);
            cursor: pointer;
            box-shadow: 0 0 10px var(--neon-cyan);
            transition: var(--transition-fast);
        }

        #inGameMenu input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 15px var(--neon-cyan-light);
        }

        #inGameMenu .state-chip {
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid var(--neon-cyan);
            color: var(--neon-cyan);
            font-weight: 600;
            font-size: var(--font-size-xs);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: 999px;
        }

        .menu-btn {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid #00ffff;
            border-radius: 5px;
            color: #00ffff;
            cursor: pointer;
            transition: all 0.3s;
        }

        /* State chip visuals for audio toggles */
        .state-chip {
            display: inline-block;
            min-width: 42px;
            text-align: center;
            line-height: 1.2;
            border-radius: 999px;
            padding: 2px 8px;
            border: 1px solid #334155;
            font-size: 12px;
            letter-spacing: 0.2px;
            background: rgba(2,6,23,0.35);
        }
        .state-chip.on {
            color: #22c55e;
            border-color: rgba(34,197,94,0.6);
            box-shadow: 0 0 0 1px rgba(34,197,94,0.15) inset;
        }
        .state-chip.off {
            color: #ef4444;
            border-color: rgba(239,68,68,0.6);
            box-shadow: 0 0 0 1px rgba(239,68,68,0.15) inset;
        }

        /* Make in-game menu buttons keyboard-friendly */
        #inGameMenu .menu-btn:focus {
            outline: 2px solid rgba(255,255,255,0.3);
            outline-offset: 2px;
        }

        .menu-btn:hover {
            background: rgba(0, 255, 255, 0.3);
            box-shadow: 0 0 10px #00ffff;
        }

        /* Simple language list layout inside settings */
        .lang-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 8px;
            margin-top: 8px;
        }
        .lang-option.active {
            background: rgba(0, 255, 255, 0.25);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.25);
        }

        /* Small state chip for toggle buttons */
        .state-chip {
            padding: 2px 8px;
            border: 1px solid #334155;
            border-radius: 999px;
            font-size: 12px;
            opacity: .95;
        }
        .state-chip.on {
            color: #22c55e;
            border-color: rgba(34, 197, 94, 0.5);
            background: rgba(34, 197, 94, 0.12);
        }
        .state-chip.off {
            color: #e5e7eb;
            border-color: rgba(148, 163, 184, 0.4);
            background: rgba(148, 163, 184, 0.10);
        }

        .element-info {
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border: 1px solid;
            text-align: left;
            font-size: 14px;
        }

        .element-info.fire {
            border-color: #ff4444;
        }
        .element-info.water {
            border-color: #4444ff;
        }
        .element-info.air {
            border-color: #44ff44;
        }
        .element-info.fire { border-color: #ff4444; }
        .element-info.water { border-color: #4444ff; }
        .element-info.air { border-color: #44ff44; }

        .ability-cooldown {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            pointer-events: none;
        }
        /* When playing, make sure it is visible and above UI */
        body.playing .ability-cooldown { bottom: 98px; display: block; z-index: 10010; }
        @media (max-width: 800px) {
            body.playing .ability-cooldown { bottom: 176px; }
        }

        .ability-icon {
            width: 60px;
            height: 60px;
            border: 2px solid;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            position: relative;
        }

        .cooldown-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
        }

        /* Power-up Display (around player center) */
        .power-up-display {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            pointer-events: none;
            z-index: 10020;
            width: 120px;
            height: 120px;
        }

        .power-up-icon {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            border: 2px solid rgba(34, 197, 94, 0.5);
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.6);
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.3), inset 0 0 15px rgba(34, 197, 94, 0.1);
            opacity: 0;
            transition: opacity 0.2s ease-out;
        }

        .power-up-display.active .power-up-icon {
            opacity: 1;
            animation: powerUpGlow 1.5s ease-in-out infinite;
        }

        @keyframes powerUpGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(34, 197, 94, 0.3), inset 0 0 15px rgba(34, 197, 94, 0.1); }
            50% { box-shadow: 0 0 30px rgba(34, 197, 94, 0.6), inset 0 0 20px rgba(34, 197, 94, 0.2); }
        }

        @keyframes abilityReadyGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(34, 197, 94, 0.8), inset 0 0 12px rgba(34, 197, 94, 0.4); filter: brightness(1.1); }
            50% { box-shadow: 0 0 28px rgba(34, 197, 94, 1), inset 0 0 16px rgba(34, 197, 94, 0.6); filter: brightness(1.2); }
        }

        .power-up-cooldown-bar {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
        }

        .power-up-cooldown-bar .power-up-progress {
            stroke-linecap: round;
            stroke-linejoin: round;
            transform-origin: 50px 50px;
            transform: rotate(-90deg);
        }

        body.touch .power-up-display { width: 100px; height: 100px; }
        body.touch .power-up-icon { font-size: 36px; }

        /* Mini Hint Toast Popup */
        .hint-toast {
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(34, 197, 94, 0.95);
            color: #0f172a;
            padding: 12px 20px;
            border-radius: 8px;
            border: 1px solid #22c55e;
            font-weight: 700;
            font-size: 14px;
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
            z-index: 10050;
            pointer-events: none;
            opacity: 0;
            animation: hintToastSlideUp 0.4s ease-out forwards, hintToastFadeOut 0.4s ease-in forwards 2.6s;
        }

        @keyframes hintToastSlideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        @keyframes hintToastFadeOut {
            from {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
            to {
                opacity: 0;
                transform: translateX(-50%) translateY(-10px);
            }
        }

        body.touch .hint-toast { padding: 10px 16px; font-size: 12px; bottom: 100px; }

        /* Show power-up display when playing */
        body.playing .power-up-display { display: block; }
        
        /* Hide hint toast when not playing (menus, shop, cutscenes) */
        body:not(.playing) #hintToast { display: none !important; }

        /* Shop wave label smaller on mobile */
        body.touch #shopWaveLabel { font-size: 11px !important; }

        /* Life use overlay */
        #lifeOverlay {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 12000;
            pointer-events: none;
            background: transparent;
        }
        #lifeOverlayIcon {
            font-size: 72px;
            text-shadow: 0 0 16px rgba(255,0,64,0.6);
            opacity: 1;
        }
        /* Magnet grant overlay */
        #magnetOverlay {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 12000;
            pointer-events: none;
            background: transparent;
        }
        #magnetOverlayIcon {
            font-size: 72px;
            text-shadow: 0 0 16px rgba(59,130,246,0.6);
            opacity: 1;
        }
        @keyframes heartFade {
            0%   { opacity: 1; }
            100% { opacity: 0; }
        }
        .pulse-anim {
            animation: heartFade 1s ease-out forwards;
        }
      /* Consumable use animation */
      @keyframes slotPulse {
        0% { box-shadow: 0 0 0 0 rgba(34,197,94,0.0); transform: scale(1); }
        25% { box-shadow: 0 0 16px 4px rgba(34,197,94,0.45); transform: scale(1.06); }
        60% { box-shadow: 0 0 10px 2px rgba(34,197,94,0.28); transform: scale(1.02); }
        100% { box-shadow: 0 0 0 0 rgba(34,197,94,0.0); transform: scale(1); }
      }
      .consumable-slot.use-anim { animation: slotPulse 420ms ease-out; border-color: #22c55e; }

      /* Minimal tweak: small left padding for texts inside shop cards */
      .shop-item .shop-title,
      .shop-item .shop-desc,
      .shop-item .shop-cost{ padding-left: 6px; }

      /* Mobile adjustments */
      @media (max-width: 768px){
        .shop-box{ top: 50%; left: 50%; transform: translate(-50%, -50%); max-height: 56vh; overflow: auto; width: min(92vw, 560px); padding: 6px; margin-bottom: 0; font-size: 0.80rem !important; }
        #shopOverlay > div,
        #shopOverlay .shop-box{
          width: min(92vw, 520px) !important;
          max-width: min(92vw, 520px) !important;
          padding: 8px !important;
          font-size: 0.80rem !important;
        }
        /* Shop header + tabs smaller */
        #shopTabs .menu-btn{ padding: 3px 7px !important; font-size: 11px !important; }
        /* Items grid tighter */
        #shopItems{ gap: 5px !important; }
        .shop-item{ padding: 5px !important; padding-bottom: 26px !important; }
        .shop-item .shop-title{ font-size: 10.5px !important; line-height: 1.1 !important; margin-bottom: 2px !important; }
        .shop-item .shop-desc{ font-size: 9.6px !important; line-height: 1.1 !important; }
        .shop-item .shop-desc{ display: -webkit-box !important; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .shop-item small{ font-size: 9px !important; }
        .shop-item .price-badge{ font-size: 8.6px !important; padding: 1px 6px !important; bottom: 6px !important; right: 6px !important; }
        .shop-item .shop-cost{ padding-right: 56px !important; }
        .shop-icon{ width: 16px !important; height: 16px !important; }
        /* Right stat panel tighter */
        #shopStatPanel{ padding: 6px !important; }
        #shopStatsBody{ gap: 3px !important; font-size: 10px !important; }
        #shopTitle{ font-size: 16px !important; }
        #shopWaveLabel{ font-size: 11px !important; }
        /* Bottom action buttons smaller */
        #lockBtn{ padding: 5px 9px !important; font-size: 12px !important; }
        #startWaveBtn{ padding: 7px 11px !important; font-size: 13px !important; }
        #consumableBar{ bottom: calc(8px + env(safe-area-inset-bottom)); transform: translateX(-50%) scale(.82); padding:8px 14px; gap:10px; }
        /* Also constrain overlay container itself */
        #shopOverlay > div { max-height: 58vh !important; margin-bottom: 0 !important; overflow:auto; }
        .shop-grid{ grid-template-columns: 1fr; gap:10px; }
        .shop-stats{ position: sticky; top: 0; }
        /* On mobile we keep the default centered fallback; JS will move it next to the bar when ready */
        /* no override here to avoid disappearing before JS runs */
      }

      /* Extra-strong constraints on touch devices regardless of width */
      body.touch #shopOverlay > div,
      body.touch .shop-box {
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
        font-size: 0.80rem !important;
        max-height: 56vh !important;
        width: min(92vw, 520px) !important;
        max-width: min(92vw, 520px) !important;
        padding: 8px !important;
        margin-bottom: 0 !important;
        overflow: auto !important;
      }
      body.touch #consumableBar {
        bottom: calc(16px + env(safe-area-inset-bottom)) !important;
        transform: translateX(-50%) scale(.82) !important;
      }
        /* Game Over Screen Animations */
        @keyframes gameOverPulse {
            0% {
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.05);
                opacity: 0.8;
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        @keyframes titleGlow {
            0%, 100% {
                text-shadow: 0 0 20px rgba(0,255,255,0.5);
                filter: brightness(1);
            }
            50% {
                text-shadow: 0 0 30px rgba(0,255,255,0.8), 0 0 40px rgba(255,0,255,0.4);
                filter: brightness(1.2);
            }
        }

        /* Enhanced button hover effects */
        #gameOverScreen button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(34,197,94,0.3) !important;
            filter: brightness(1.1);
        }

        #gameOverScreen button:active {
            transform: translateY(0);
            filter: brightness(0.95);
        }

        /* Stats entry animations */
        @keyframes statSlideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        #runTimeStats > div {
            animation: statSlideIn 0.5s ease-out forwards;
            opacity: 0;
        }

        #runTimeStats > div:nth-child(1) { animation-delay: 0.1s; }
        #runTimeStats > div:nth-child(2) { animation-delay: 0.2s; }
        #runTimeStats > div:nth-child(3) { animation-delay: 0.3s; }
        #runTimeStats > div:nth-child(4) { animation-delay: 0.4s; }

        /* Mobile responsive adjustments for game over screen */
        @media (max-width: 600px) {
            #gameOverScreen > div {
                padding: 20px 15px !important;
                width: 95vw !important;
            }
            
            #gameOverScreen .grid {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }
            
            #gameOverScreen h2 {
                font-size: 20px !important;
            }
            
            #gameOverScreen button {
                padding: 10px 16px !important;
                font-size: 12px !important;
            }
        }
  </style>
</head>
<body>
    <script>
      // Mark touch devices so touch-specific CSS applies reliably on real phones
      (function(){
        try{
          const isTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0) || (navigator.msMaxTouchPoints > 0);
          if(isTouch) {
            document.body.classList.add('touch');
            document.documentElement.classList.add('touch');
          }
        }catch(_){ }
      })();
      </script>
    <script>
      // Position ability cooldown UI next to the consumable bar (mobile + desktop)
      (function(){
        function positionAbilityNextToBar(){
          try{
            const bar = document.getElementById('consumableBar');
            const ab = document.querySelector('.ability-cooldown');
            if(!ab) return;
            const isPlaying = document.body.classList.contains('playing');
            // If not playing yet, keep it hidden and bail
            if(!isPlaying){
              ab.style.display = 'none';
              return;
            }
            // Ensure visible while playing
            ab.style.display = 'block';
            ab.style.visibility = 'visible';
            const gap = 8;
            let x, y;
            if(bar){
              const rect = bar.getBoundingClientRect();
              const abRect = ab.getBoundingClientRect();
              let neededW = (abRect.width||48);
              x = rect.right + gap; // default right side
              if(x + neededW > window.innerWidth - 8){
                x = rect.left - gap - neededW; // fallback left side
              }
              y = rect.top + rect.height/2; // vertical center
            } else {
              // Fallback: bottom-right with safe area
              const safe = (window.visualViewport?.height ? 0 : 0); // can't read env() in JS; assume 0
              const abRect2 = ab.getBoundingClientRect();
              const neededW2 = (abRect2.width||48);
              x = window.innerWidth - neededW2 - 12;
              y = window.innerHeight - 12 - (abRect2.height||48) - safe;
            }
            // Clamp inside viewport
            y = Math.max(8, Math.min(window.innerHeight - 8, y));
            ab.style.position = 'fixed';
            ab.style.left = Math.round(x) + 'px';
            ab.style.top = Math.round(y) + 'px';
            ab.style.transform = 'translateY(-50%)';
            ab.style.zIndex = '10021';
            // Clear conflicting anchors from CSS
            ab.style.bottom = 'auto';
            ab.style.right = 'auto';
            // Ensure it has a visible size even if styles haven't loaded yet
            const icon = ab.querySelector('.ability-icon');
            if(icon){
              if(!(icon.offsetWidth>0)) icon.style.width = '60px';
              if(!(icon.offsetHeight>0)) icon.style.height = '60px';
            }
          }catch(_){ }
        }
        // Reposition on events
        ['resize','scroll'].forEach(ev=> window.addEventListener(ev, positionAbilityNextToBar, {passive:true}));
        // Observe changes to bar layout
        try{
          const bar = document.getElementById('consumableBar');
          if(bar && 'MutationObserver' in window){
            const mo = new MutationObserver(positionAbilityNextToBar);
            mo.observe(bar, { attributes:true, childList:true, subtree:true });
          }
        }catch(_){ }
        // Observe body class changes (e.g., playing toggle)
        try{
          if('MutationObserver' in window){
            const bodyObs = new MutationObserver(positionAbilityNextToBar);
            bodyObs.observe(document.body, { attributes:true, attributeFilter:['class'] });
          }
        }catch(_){ }
        // Also hook into visibility states
        document.addEventListener('DOMContentLoaded', positionAbilityNextToBar);
        window.addEventListener('load', positionAbilityNextToBar);
        setTimeout(positionAbilityNextToBar, 0);
        setTimeout(positionAbilityNextToBar, 250);
        // Retry a few times in case layout isn't ready
        (function(){
          let n = 0;
          const h = setInterval(()=>{
            positionAbilityNextToBar();
            if(++n > 20) clearInterval(h);
          }, 150);
        })();
      })();
    </script>
    <canvas id="gameCanvas"></canvas>
    <!-- Touch Controls (mobile) -->
    <div id="touchControls" aria-hidden="true">
      <div id="joystick" aria-label="Move">
        <div id="joystickNub"></div>
      </div>
      <button id="dodgeBtn" type="button" aria-label="Dodge">DODGE</button>
      <button id="skillBtn" type="button" aria-label="Skill">SKILL</button>
      <!-- Pause button (top-right) -->
      <button id="pauseBtnMobile" aria-label="Pause" title="Pause"
        style="position:absolute; top: 12px; right: 12px; width:44px; height:44px; border-radius:50%;
               background: rgba(0, 0, 0, 0.45); border:2px solid #00ffff; color:#00ffff; font-weight:800;
               box-shadow: 0 0 14px rgba(0,255,255,0.4); backdrop-filter: blur(2px); letter-spacing:1px;
               pointer-events: all; touch-action: manipulation; cursor: pointer; z-index:2147483000;">II</button>
    </div>
    <script>
      // Minimal mobile controls wiring: show buttons while playing and bind actions
      (function(){
        const tc = document.getElementById('touchControls');
        const skillBtn = document.getElementById('skillBtn');
        const dodgeBtn = document.getElementById('dodgeBtn');
        const pauseBtn = document.getElementById('pauseBtnMobile');
        const isMobileLike = !!(
          (document && document.body && document.body.classList.contains('touch')) ||
          (document && document.documentElement && document.documentElement.classList.contains('touch'))
        );
        function sync(){
          const g = window.game;
          const shopEl = document.getElementById('shopOverlay');
          const shopOpen = (document.body && document.body.classList.contains('shop-open')) || (shopEl && window.getComputedStyle(shopEl).display !== 'none');
          const show = !!isMobileLike && g && g.gameState==='playing' && !g.paused;
          if (!tc) return;
          tc.style.display = show ? 'block' : 'none';
          // If shop is open, keep controls under the shop and non-interactive
          if (shopOpen && show) {
            tc.style.pointerEvents = 'none';
            tc.style.zIndex = '500';
          } else {
            tc.style.pointerEvents = 'none';
            tc.style.zIndex = show ? '30000' : '30';
          }
          tc.setAttribute('aria-hidden', show ? 'false' : 'true');
          // Pause button: show on touch while playing (even if paused menu closed), hide on shop to avoid overlap
          if (pauseBtn) {
            const showPause = !!isMobileLike && g && g.gameState==='playing' && !shopOpen;
            pauseBtn.style.display = showPause ? 'block' : 'none';
          }
        }
        setInterval(sync, 500);
        sync();
      })();
    </script>
    <script>
      // Ensure Run Stats is hidden while playing (simple state check)
      (function(){
        const stats = document.getElementById('statsPanel');
        function syncStats(){
          if (!stats) return;
          const g = window.game;
          const hide = !!g && g.gameState === 'playing';
          stats.style.display = hide ? 'none' : '';
        }
        setInterval(syncStats, 900);
        syncStats();
      })();
    </script>
    <script>
      (function(){
        const STORAGE_KEY = 'elementist_run_stats_v1';
        const LB_KEY = 'elementist_leaderboard_v1';
        const MAX_RUNS = 10;

        const el = (id)=>document.getElementById(id);
        const bestWaveEl = el('statsBestWave');
        const bestScoreEl = el('statsBestScore');
        const lastRunsEl = el('statsLastRuns');
        const resetBtn = el('resetStatsBtn');
        const gameOverScreen = el('gameOverScreen');
        const finalStats = el('finalStats');

        function safeParse(json, fb){
          try{ return JSON.parse(json); }catch(_){ return fb; }
        }
        function loadStats(){
          const fb = { bestWave: 0, bestScore: 0, totalPlaytimeMs: 0 };
          try{ return safeParse(localStorage.getItem(STORAGE_KEY)||'', fb) || fb; }catch(_){ return fb; }
        }
        function saveStats(s){
          try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(s||{})); }catch(_){ }
        }
        function loadLB(){
          try{ return safeParse(localStorage.getItem(LB_KEY)||'', []) || []; }catch(_){ return []; }
        }
        function saveLB(list){
          try{ localStorage.setItem(LB_KEY, JSON.stringify(Array.isArray(list)?list:[])); }catch(_){ }
        }
        function formatMs(ms){
          const t = Math.max(0, ms|0);
          const s = Math.floor(t/1000);
          const m = Math.floor(s/60);
          const r = s%60;
          return `${m}:${String(r).padStart(2,'0')}`;
        }
        function getScore(){
          try{ return parseInt(el('score')?.textContent||'0',10) || 0; }catch(_){ return 0; }
        }
        function getWave(){
          try{
            const g = window.game;
            const w = (g && typeof g.waveNumber==='number') ? (g.waveNumber|0) : 0;
            if(w>0) return w;
          }catch(_){ }
          return 0;
        }
        function renderPanel(){
          const s = loadStats();
          if(bestWaveEl) bestWaveEl.textContent = String(s.bestWave||0);
          if(bestScoreEl) bestScoreEl.textContent = String(s.bestScore||0);
          if(!lastRunsEl) return;
          const list = loadLB();
          if(!Array.isArray(list) || list.length===0){
            lastRunsEl.innerHTML = '<li style="opacity:.7;">No runs yet.</li>';
            return;
          }
          lastRunsEl.innerHTML = list.map((r)=>{
            const wave = r.wave|0;
            const score = r.score|0;
            const dur = formatMs(r.durationMs|0);
            const d = (function(){ try{ return new Date(r.ts||0); }catch(_){ return null; }})();
            const ds = d ? `${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}` : '';
            return `<li><span style="color:#7dd3fc; font-weight:700;">W${wave||'-'}</span> <span style="opacity:.9;">${score}</span> <span style="opacity:.75;">(${dur}${ds?`, ${ds}`:''})</span></li>`;
          }).join('');
        }

        let runStartMs = 0;
        let lastRecordedRunId = '';

        function ensureRunStart(){
          try{
            const g = window.game;
            const playing = !!g && g.gameState === 'playing';
            if(!playing) return;
            if(!runStartMs) runStartMs = Date.now();
          }catch(_){ }
        }

        function recordGameOverOnce(){
          try{
            const visible = !!gameOverScreen && (window.getComputedStyle(gameOverScreen).display !== 'none');
            if(!visible) return;
            const nowId = `${getWave()}-${getScore()}-${String(gameOverScreen.style.display||'')}`;
            if(nowId && nowId === lastRecordedRunId) return;
            lastRecordedRunId = nowId;

            const end = Date.now();
            const dur = runStartMs ? (end - runStartMs) : 0;
            const wave = getWave();
            const score = getScore();

            const st = loadStats();
            st.bestWave = Math.max(st.bestWave|0, wave|0);
            st.bestScore = Math.max(st.bestScore|0, score|0);
            st.totalPlaytimeMs = (st.totalPlaytimeMs|0) + (dur|0);
            saveStats(st);

            const lb = loadLB();
            lb.unshift({ wave: wave|0, score: score|0, durationMs: dur|0, ts: Date.now() });
            const trimmed = lb.slice(0, MAX_RUNS);
            saveLB(trimmed);
            renderPanel();

            if(finalStats){
              const extra = `\n<div style="margin-top:10px; padding-top:10px; border-top:1px solid rgba(51,65,85,0.45); color:#cbd5e1; font-size:13px; line-height:1.55;">`+
                `<div><strong>Run Time</strong>: ${formatMs(dur)}</div>`+
                `<div><strong>Best Wave</strong>: ${st.bestWave|0}</div>`+
                `<div><strong>Best Score</strong>: ${st.bestScore|0}</div>`+
              `</div>`;
              if(!finalStats.__extraStatsAppended){
                finalStats.insertAdjacentHTML('beforeend', extra);
                finalStats.__extraStatsAppended = true;
              }
            }
          }catch(_){ }
        }

        function resetAll(){
          try{ localStorage.removeItem(STORAGE_KEY); }catch(_){ }
          try{ localStorage.removeItem(LB_KEY); }catch(_){ }
          runStartMs = 0;
          lastRecordedRunId = '';
          try{ if(finalStats){ finalStats.__extraStatsAppended = false; } }catch(_){ }
          renderPanel();
        }

        if(resetBtn){
          resetBtn.addEventListener('click', function(){ resetAll(); });
        }

        // init
        renderPanel();
        setInterval(ensureRunStart, 700);

        if(gameOverScreen){
          const obs = new MutationObserver(function(){
            try{ if(finalStats) finalStats.__extraStatsAppended = false; }catch(_){ }
            recordGameOverOnce();
          });
          try{ obs.observe(gameOverScreen, { attributes:true, attributeFilter:['style','class'] }); }catch(_){ }
        }
        setInterval(recordGameOverOnce, 800);
      })();
    </script>
    <script>
      (function(){
        let ctx = null;
        function getCtx(){
          try{
            if(ctx) return ctx;
            const AC = window.AudioContext || window.webkitAudioContext;
            if(!AC) return null;
            ctx = new AC();
            return ctx;
          }catch(_){ return null; }
        }
        function readVolume(){
          try{
            const a = document.getElementById('masterVolume');
            if(a && a.value != null) return Math.max(0, Math.min(1, parseFloat(a.value)||0));
          }catch(_){ }
          try{
            const b = document.getElementById('volumeRange');
            if(b && b.value != null) return Math.max(0, Math.min(1, parseFloat(b.value)||0));
          }catch(_){ }
          return 1;
        }
        function isSoundOn(){
          try{
            const s1 = (document.getElementById('soundState')?.textContent||'').trim().toLowerCase();
            const s2 = (document.getElementById('soundStateIngame')?.textContent||'').trim().toLowerCase();
            if(s1==='off' || s2==='off') return false;
            if(s1==='on' || s2==='on') return true;
          }catch(_){ }
          return true;
        }
        function canPlay(){
          const v = readVolume();
          if(v <= 0.001) return false;
          if(!isSoundOn()) return false;
          return true;
        }
        function resumeIfNeeded(){
          try{
            const c = getCtx();
            if(!c) return;
            if(c.state === 'suspended') c.resume();
          }catch(_){ }
        }
        function beep(freq, durMs, gain){
          try{
            if(!canPlay()) return;
            const c = getCtx();
            if(!c) return;
            resumeIfNeeded();
            const g0 = Math.max(0.001, Math.min(0.25, gain||0.06)) * readVolume();
            const o = c.createOscillator();
            const g = c.createGain();
            o.type = 'sine';
            o.frequency.value = freq;
            g.gain.value = 0;
            o.connect(g);
            g.connect(c.destination);
            const t0 = c.currentTime;
            g.gain.setValueAtTime(0, t0);
            g.gain.linearRampToValueAtTime(g0, t0 + 0.01);
            g.gain.exponentialRampToValueAtTime(0.0001, t0 + (durMs/1000));
            o.start();
            o.stop(t0 + (durMs/1000) + 0.02);
          }catch(_){ }
        }
        function whoosh(){
          try{
            if(!canPlay()) return;
            const c = getCtx();
            if(!c) return;
            resumeIfNeeded();
            const v = readVolume();
            const o = c.createOscillator();
            const f = c.createBiquadFilter();
            const g = c.createGain();
            o.type = 'triangle';
            f.type = 'lowpass';
            f.frequency.value = 1200;
            g.gain.value = 0;
            o.connect(f);
            f.connect(g);
            g.connect(c.destination);
            const t0 = c.currentTime;
            const g0 = Math.max(0.001, Math.min(0.18, 0.07 * v));
            g.gain.setValueAtTime(0.0001, t0);
            g.gain.linearRampToValueAtTime(g0, t0 + 0.02);
            g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.18);
            o.frequency.setValueAtTime(320, t0);
            o.frequency.exponentialRampToValueAtTime(80, t0 + 0.18);
            o.start();
            o.stop(t0 + 0.22);
          }catch(_){ }
        }

        let lastPingAt = 0;
        function ping(){
          const now = Date.now();
          if(now - lastPingAt < 140) return;
          lastPingAt = now;
          beep(880, 70, 0.05);
        }

        function wire(){
          try{
            const dodgeBtn = document.getElementById('dodgeBtn');
            if(dodgeBtn && !dodgeBtn.__sfxBound){
              dodgeBtn.addEventListener('pointerdown', function(){ whoosh(); }, { passive:true });
              dodgeBtn.__sfxBound = true;
            }
          }catch(_){ }
        }

        let lastScore = -1;
        let lastMats = -1;
        function poll(){
          try{
            const s = parseInt(document.getElementById('score')?.textContent||'0',10) || 0;
            const m = parseInt(document.getElementById('materialsTop')?.textContent||'0',10) || 0;
            if(lastScore>=0 && s>lastScore) ping();
            if(lastMats>=0 && m>lastMats) ping();
            lastScore = s;
            lastMats = m;
          }catch(_){ }
        }

        document.addEventListener('DOMContentLoaded', function(){
          wire();
          setInterval(wire, 1200);
          setInterval(poll, 600);
          try{
            const resume = function(){ resumeIfNeeded(); };
            window.addEventListener('pointerdown', resume, { once:true, capture:true });
            window.addEventListener('touchstart', resume, { once:true, capture:true });
          }catch(_){ }
        });
      })();
    </script>
    <!-- Rotate overlay (shown in portrait via CSS) -->
    <div id="rotateOverlay">
        <div class="box">
            <h2 style="margin-bottom:8px; color:#7dd3fc;" data-lang="rotateTitle">Please Rotate Your Device</h2>
            <p style="color:#cbd5e1;" data-lang="rotateDesc">This game plays best in landscape (16:9) mode.</p>
        </div>
    </div>

    <script>
      (function(){
        function isMobileLike(){
          try{
            return (('ontouchstart' in window) || (navigator.maxTouchPoints && navigator.maxTouchPoints>0) || (window.matchMedia && window.matchMedia('(pointer: coarse)').matches));
          }catch(_){ return false; }
        }

        function isLandscapeNow(){
          try{
            if(window.matchMedia && window.matchMedia('(orientation: landscape)').matches) return true;
          }catch(_){ }
          try{
            if(screen.orientation && typeof screen.orientation.type === 'string'){
              return screen.orientation.type.indexOf('landscape') === 0;
            }
          }catch(_){ }
          return false;
        }

        function syncOverlayState(){
          try{
            document.body.classList.toggle('force-landscape', isLandscapeNow());
          }catch(_){ }
        }

        async function tryEnterFullscreenAndLock(){
          try{
            if(!isMobileLike()) return;
            const el = document.documentElement || document.body;
            if(!document.fullscreenElement){
              const p = el.requestFullscreen ? el.requestFullscreen() : (el.webkitRequestFullscreen ? el.webkitRequestFullscreen() : null);
              if(p && p.catch) p.catch(function(){});
            }
            try{
              if(screen.orientation && screen.orientation.lock){
                await screen.orientation.lock('landscape');
              }
            }catch(_){ }
            syncOverlayState();
          }catch(_){ }
        }

        function ensureLandscape(){
          syncOverlayState();
          if(!isMobileLike()) return;
          if(!document.fullscreenElement) return;
          if(isLandscapeNow()) return;
          tryEnterFullscreenAndLock();
        }

        try{
          let done = false;
          const handler = function(){
            if(done) return;
            done = true;
            tryEnterFullscreenAndLock();
            try{ window.removeEventListener('pointerdown', handler, true); }catch(_){ }
            try{ window.removeEventListener('touchstart', handler, true); }catch(_){ }
          };
          window.addEventListener('pointerdown', handler, true);
          window.addEventListener('touchstart', handler, true);
        }catch(_){ }

        try{
          window.addEventListener('orientationchange', ensureLandscape, { passive: true });
          document.addEventListener('fullscreenchange', ensureLandscape, true);
        }catch(_){ }

        try{
          syncOverlayState();
          let n = 0;
          const t = setInterval(function(){
            ensureLandscape();
            if(++n > 30) clearInterval(t);
          }, 350);
        }catch(_){ }
      })();
    </script>

    <!-- Main Menu Skins Shop Overlay -->
    <div id="mainShopOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.75); z-index:12000; align-items:center; justify-content:center;">
      <div class="shop-box" style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#0b1220; color:#e5e7eb; padding:18px; border-radius:12px; width:820px; max-width:96vw; box-shadow:0 10px 30px rgba(0,0,0,0.6); border:1px solid #334155;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
          <div style="display:flex; align-items:center; gap:12px;">
            <h3 style="margin:0; font-size:16px; letter-spacing:0.5px; color:#7dd3fc;" data-lang="shop">SHOP</h3>
            <small id="mainShopStats" style="opacity:.85; font-size:12px;"></small>
          </div>
          <button id="mainShopCloseBtn" class="primary-btn" data-lang="close" style="position:absolute; top:10px; right:10px; width:auto; padding:4px 7px; font-size:12px;">KAPAT</button>
        </div>
        <div id="mainShopItems" style="display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap:12px;">
          <!-- Filled by JS: skin cards -->
        </div>
        <div id="mainShopPager" style="display:flex; align-items:center; justify-content:center; gap:12px; margin-top:12px;">
          <button id="mainShopPrev" class="primary-btn" style="width:auto; padding:4px 7px; font-size:12px;"></button>
          <small id="mainShopPageLabel" style="opacity:.9;">1 / 1</small>
          <button id="mainShopNext" class="primary-btn" style="width:auto; padding:4px 7px; font-size:12px;"></button>
        </div>
      </div>
    </div>

    <script>
      (function(){
        function q(sel){ return document.querySelector(sel); }
        function qa(sel){ return Array.from(document.querySelectorAll(sel)); }
        if (!window.__switchSettingsTab){
          window.__switchSettingsTab = function(tab){
            try{
              var maps = {
                appearance: q('#settingsTab-appearance'),
                audio: q('#settingsTab-audio'),
                language: q('#settingsTab-language'),
                credits: q('#settingsTab-credits')
              };
              Object.keys(maps).forEach(function(k){ var el=maps[k]; if(el) el.style.display = (k===tab)?'block':'none'; });
              qa('.settings-tab-btn').forEach(function(b){ b.classList.toggle('active', b.getAttribute('data-tab')===tab); });
            }catch(_){ }
          };
          try{ window.__switchSettingsTab('appearance'); }catch(_){ }
        }
        function ensureFpsHud(){
          var hud = q('#fpsHud');
          if(!hud){
            hud = document.createElement('div');
            hud.id = 'fpsHud';
            hud.style.position = 'fixed';
            hud.style.top = '8px';
            hud.style.left = '8px';
            hud.style.zIndex = '2147483640';
            hud.style.padding = '4px 6px';
            hud.style.border = '1px solid rgba(203,213,225,0.35)';
            hud.style.borderRadius = '6px';
            hud.style.background = 'rgba(2,6,23,0.65)';
            hud.style.color = '#e2e8f0';
            hud.style.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
            hud.style.display = 'none';
            hud.textContent = 'FPS: --';
            document.body.appendChild(hud);
          }
          return hud;
        }
        if (!window.__toggleFullscreen){
          window.__toggleFullscreen = function(){
            try{
              var canvas = q('#gameCanvas');
              var el = document.documentElement || document.body;
              try{ (canvas||document.body).focus && (canvas||document.body).focus(); }catch(_){ }
              if(!document.fullscreenElement){
                var p = el.requestFullscreen ? el.requestFullscreen() : (el.webkitRequestFullscreen ? el.webkitRequestFullscreen() : (el.msRequestFullscreen ? el.msRequestFullscreen() : null));
                if (p && p.catch) p.catch(function(){});
              } else {
                var px = document.exitFullscreen ? document.exitFullscreen() : (document.webkitExitFullscreen ? document.webkitExitFullscreen() : (document.msExitFullscreen ? document.msExitFullscreen() : null));
                if (px && px.catch) px.catch(function(){});
              }
              setTimeout(function(){ try{ var st=q('#fullscreenState'); if(st) st.textContent = document.fullscreenElement?'On':'Off'; }catch(_){ } }, 120);
            }catch(_){ }
          };
          try{ document.addEventListener('fullscreenchange', function(){ try{ var st=q('#fullscreenState'); if(st) st.textContent = document.fullscreenElement?'On':'Off'; }catch(_){ } }); }catch(_){ }
        }
        if (!window.__toggleFpsInfo){
          window.__toggleFpsInfo = function(){
            try{
              var cur = localStorage.getItem('fpsInfoOn') === 'true';
              localStorage.setItem('fpsInfoOn', (!cur).toString());
              var on = !cur;
              var chip = q('#fpsInfoState'); if (chip){ chip.textContent = on?'On':'Off'; }
              var hud = ensureFpsHud(); if(hud) hud.style.display = on?'block':'none';
            }catch(_){ }
          };
          try{
            var init = localStorage.getItem('fpsInfoOn') === 'true';
            var chip = q('#fpsInfoState'); if (chip) chip.textContent = init?'On':'Off';
            var hud = ensureFpsHud(); if(hud) hud.style.display = init?'block':'none';
            if(!window.__fpsHudLoop){
              window.__fpsHudLoop = true;
              var last = performance.now(); var frames=0; var acc=0;
              function tick(){
                var now = performance.now(); var dt = now-last; last=now; frames++; acc+=dt;
                if(acc>=500){ var fps = Math.round((frames*1000)/acc); frames=0; acc=0; try{ var h=q('#fpsHud'); if(h) h.textContent='FPS: '+fps; }catch(_){ } }
                requestAnimationFrame(tick);
              }
              requestAnimationFrame(tick);
            }
          }catch(_){ }
        }

        function goBackToHub(){
          try{ window.location.href = '../index.html'; }catch(_){ try{ location.assign('../index.html'); }catch(__){} }
        }

        document.addEventListener('DOMContentLoaded', function(){
          const backToHubBtn = document.getElementById('backToHubBtn');

          if(backToHubBtn && !backToHubBtn.__bound){
            backToHubBtn.addEventListener('click', function(e){ try{ e.preventDefault(); }catch(_){ } goBackToHub(); }, true);
            backToHubBtn.__bound = true;
          }
        });
      })();
    </script>

    <!-- Settings Overlay: includes language dropdown; kept minimal to avoid removing other settings content -->
    <div id="settingsOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); backdrop-filter: blur(3px); z-index:10003;">
      <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); width:min(92vw,820px); max-height:82vh; overflow:auto; background:#0b1220; color:#e5e7eb; border:2px solid #00ffff; border-radius:14px; box-shadow:0 0 30px rgba(0,255,255,0.35); padding:18px 20px;">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
          <h2 style="margin:0; color:#67e8f9;" data-lang="settingsTitle">Settings</h2>
          <button id="settingsCloseBtn" class="menu-btn" style="width:auto; padding:6px 10px;" data-lang="close">CLOSE</button>
        </div>
        <!-- Tabs -->
        <div id="settingsTabs" style="display:flex; gap:8px; margin-top:12px; flex-wrap:wrap;">
          <button class="menu-btn settings-tab-btn active" data-tab="appearance" onclick="window.__switchSettingsTab && window.__switchSettingsTab('appearance')" style="width:auto; padding:6px 10px;" data-lang="appearance">Appearance</button>
          <button class="menu-btn settings-tab-btn" data-tab="audio" onclick="window.__switchSettingsTab && window.__switchSettingsTab('audio')" style="width:auto; padding:6px 10px;" data-lang="sound">Sound</button>
          <button class="menu-btn settings-tab-btn" data-tab="language" onclick="window.__switchSettingsTab && window.__switchSettingsTab('language')" style="width:auto; padding:6px 10px;" data-lang="language">Language</button>
          <button class="menu-btn settings-tab-btn" data-tab="credits" onclick="window.__switchSettingsTab && window.__switchSettingsTab('credits')" style="width:auto; padding:6px 10px;" data-lang="credits">Credits</button>
        </div>
        <!-- Tab Panels -->
        <div id="settingsPanels" style="margin-top:12px; display:block;">
          <!-- Grnm -->
          <div id="settingsTab-appearance" class="settings-panel" style="display:block;">
            <h3 style="margin:0 0 6px; color:#93c5fd;" data-lang="appearance">Appearance</h3>
            <div style="display:grid; gap:8px;">
              <div style="display:flex; gap:8px; align-items:center;">
                <button id="fullscreenToggleBtn" class="menu-btn" style="width:auto; padding:6px 10px;" aria-pressed="false" onclick="window.__toggleFullscreen && window.__toggleFullscreen()" data-lang="fullscreen">Fullscreen</button>
                <span id="fullscreenState" class="state-chip" style="padding:2px 8px;">Off</span>
              </div>
              <div style="display:flex; gap:8px; align-items:center;">
              </div>
              <div style="display:flex; gap:8px; align-items:center;">
                <button id="fpsInfoToggleBtn" class="menu-btn" style="width:auto; padding:6px 10px;" aria-pressed="false" onclick="window.__toggleFpsInfo && window.__toggleFpsInfo()" data-lang="fpsInfo">FPS Info</button>
                <span id="fpsInfoState" class="state-chip" style="padding:2px 8px;">Off</span>
              </div>
            </div>
          </div>
          <!-- Ses -->
          <div id="settingsTab-audio" class="settings-panel" style="display:none;">
            <h3 style="margin:0 0 6px; color:#93c5fd;" data-lang="sound">Sound</h3>
            <div style="display:flex; gap:8px; align-items:center;">
              <button id="soundToggleBtn" class="menu-btn" style="width:auto; padding:6px 10px; display:flex; gap:8px; align-items:center;" aria-pressed="false">
                <span data-lang="sound">Sound</span>
                <span id="soundState" class="state-chip" style="padding:2px 8px; border:1px solid #334155; border-radius:999px; font-size:12px; opacity:.9;">Off</span>
              </button>
              <label for="masterVolume" style="min-width:90px; color:#e5e7eb;" data-lang="volume">Volume: </label>
              <input id="masterVolume" type="range" min="0" max="1" step="0.01" style="flex:1;" />
              <span id="masterVolumeVal" style="min-width:40px; text-align:right;">100%</span>
            </div>
            <h3 style="margin:12px 0 6px; color:#93c5fd;" data-lang="music">Music</h3>
            <div style="display:flex; gap:8px; align-items:center;">
              <button id="musicToggleBtn" class="menu-btn" style="width:auto; padding:6px 10px; display:flex; gap:8px; align-items:center;" aria-pressed="false">
                <span data-lang="music">Music</span>
                <span id="musicState" class="state-chip" style="padding:2px 8px; border:1px solid #334155; border-radius:999px; font-size:12px; opacity:.9;">Off</span>
              </button>
              <label for="musicVolume" style="min-width:90px; color:#e5e7eb;" data-lang="volume">Volume: </label>
              <input id="musicVolume" type="range" min="0" max="1" step="0.01" value="0.15" style="flex:1;" />
              <span id="musicVolumeVal" style="min-width:40px; text-align:right;">15%</span>
            </div>
          </div>
          <!-- Dil -->
          <div id="settingsTab-language" class="settings-panel" style="display:none;">
            <h3 style="margin-bottom:6px; color:#93c5fd;" data-lang="language">Language</h3>
            <label for="languageSelect" class="sr-only" aria-hidden="true">Language</label>
            <select id="languageSelect" style="width:100%; padding:10px; background:#0a101f; color:#e5e7eb; border:1px solid #00ffff; border-radius:8px;">
              <option value="tr">Turkish</option>
              <option value="en">English</option>
              <option value="de">Deutsch</option>
              <option value="ja"></option>
              <option value="hi"></option>
              <option value="es">Espaol</option>
              <option value="pt-BR">Portugus (Brasil)</option>
              <option value="zh"></option>
            </select>
          </div>
          <!-- Emei Geenler -->
          <div id="settingsTab-credits" class="settings-panel" style="display:none;">
            <h3 style="margin-bottom:6px; color:#93c5fd;" data-lang="credits">Credits</h3>
            <div class="stat" style="padding:12px;">
              <p style="margin:0; color:#b6c2d1;" data-lang="creditsText">Thanks to the Elementist developer team and contributors.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Cutscene Overlay: plays after element selection, then opens shop -->
    <div id="cutsceneOverlay" style="display:none; position:fixed; inset:0; background:#000; z-index:2147483646; align-items:center; justify-content:center;">
      <div id="cutsceneHolder" style="position:relative; width:100vw; height:100vh;">
        <video id="cutsceneVideo" autoplay playsinline preload="auto" controlslist="nodownload noremoteplayback" disablepictureinpicture style="position:absolute; inset:0; width:100vw; height:100vh; object-fit:contain; background:#000;"></video>
        <button id="cutsceneSkipBtn" class="menu-btn" data-lang="close" style="position:absolute; right:10px; bottom:10px; width:auto; padding:6px 10px; background:rgba(0,0,0,0.6); border-color:#0ea5e9;"></button>
      </div>
    </div>

    <!-- Weapon Selection Overlay (shown after Wave 3, before Shop) -->
    <div id="weaponOverlay" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(3px); z-index: 10001;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: min(92vw, 720px); max-height: 80vh; overflow: auto; background: rgba(10,10,20,0.95); border: 2px solid #00ffff; border-radius: 14px; box-shadow: 0 0 30px rgba(0,255,255,0.4); padding: 18px 20px; color: #fff;">
            <h2 style="margin: 0 0 10px 0; text-align: center; letter-spacing: 1px;" data-lang="weaponSelectTitle"> Choose Your Weapon</h2>
            <p style="margin: 0 0 14px 0; text-align: center; opacity: 0.8;" data-lang="weaponSelectDesc">Before Wave 4 starts, pick a weapon.</p>
            <div id="weaponItems" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px;"></div>
        </div>
    </div>

    <!-- How To Play Overlay -->
    <div id="howToOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); backdrop-filter: blur(3px); z-index:10002;">
      <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:min(92vw,820px); max-height:82vh; overflow:auto; background:#0b1220; color:#e5e7eb; border:2px solid #00ffff; border-radius:14px; box-shadow:0 0 30px rgba(0,255,255,0.35); padding:18px 20px;">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
          <h2 style="margin:0; color:#67e8f9;" data-lang="howToTitle">How to Play</h2>
          <button id="howToCloseBtn" class="menu-btn" style="width:auto; padding:6px 10px;" data-lang="close">CLOSE</button>
        </div>
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); gap:14px; margin-top:12px;">
          <div class="stat" style="padding:12px;">
            <h3 style="margin:0 0 6px; color:#93c5fd;" data-lang="controls_pc">PC Controls</h3>
            <ul style="margin:0; padding-left:18px; line-height:1.6;">
              <li><b>WASD / <span data-lang="arrowKeys">Arrow Keys</span></b>: <span data-lang="controls_move">Move</span></li>
              <li><b>Shift</b>: <span data-lang="controls_ability">Use ability</span> <span data-lang="controls_ability_water_hint">(In Water element, pressing Shift again while the ability is active locks the water pool at the current position.)</span></li>
              <li><b>Space</b>: <span data-lang="controls_dash">Dash / Evade</span></li>
              <li><b>ESC</b>: <span data-lang="controls_pause">Pause / Menu</span></li>
            </ul>
          </div>
          <div class="stat" style="padding:12px;">
            <h3 style="margin:0 0 6px; color:#93c5fd;" data-lang="tipsTitle">Tips</h3>
            <ul style="margin:0; padding-left:18px; line-height:1.6;">
              <li data-lang="tip1">Collect energy from enemies to grow stronger.</li>
              <li data-lang="tip2">After Wave 3, pick a weapon, then the shop will open.</li>
              <li data-lang="tip3">Spend materials in the shop to upgrade.</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Characters Overlay (in-page modal) -->
    <div id="charactersOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.65); z-index:10050; align-items:center; justify-content:center;">
      <div class="card" style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:rgba(0,0,0,0.95); padding:26px; border-radius:16px; border:2px solid #00ffff; box-shadow:0 0 30px #00ffff; width:min(880px, 96vw); max-height:86vh; overflow:auto;">
        <div class="header" style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px;">
          <h1 data-lang="charactersTitle" style="color:#00ffff; margin:0;">Characters</h1>
          <button type="button" id="closeCharactersBtn" class="btn" style="background:#0ea5e9; color:#001018; border:none; border-radius:10px; padding:8px 12px; font-weight:700; cursor:pointer;" data-lang="close">Close</button>
        </div>
        <p class="sub" data-lang="charactersSubtitle" style="color:#b6c2d1; margin: 0 0 12px 0; text-align:center;">Visuals and short descriptions of enemy archetypes.</p>
        <div id="charactersList" style="display:grid; grid-template-columns: repeat(1, 1fr); gap:10px;">
          <div class="char-item" style="display:flex; align-items:center; gap:12px; padding:10px; border:1px solid #334155; border-radius:10px; background:#0b1220;">
            <canvas class="char-icon" width="80" height="80" data-role="rush" data-shape="circle"></canvas>
            <div>
              <div class="shop-name" style="font-weight:700; color:#e2e8f0;" data-lang="enemy_rush_circle_title">Rush (Circle)</div>
              <div class="shop-desc" style="color:#94a3b8; font-size:14px;" data-lang="enemy_rush_circle_desc">Basic melee chaser; does not shoot. Follows directly and applies constant pressure.</div>
            </div>
          </div>
          <div class="char-item" style="display:flex; align-items:center; gap:12px; padding:10px; border:1px solid #334155; border-radius:10px; background:#0b1220;">
            <canvas class="char-icon" width="80" height="80" data-role="rush" data-shape="triangle"></canvas>
            <div>
              <div class="shop-name" style="font-weight:700; color:#e2e8f0;" data-lang="enemy_rush_triangle_title">Rush (Triangle)</div>
              <div class="shop-desc" style="color:#94a3b8; font-size:14px;" data-lang="enemy_rush_triangle_desc">Sharp turns; accelerates in short bursts and closes the gap.</div>
            </div>
          </div>
          <div class="char-item" style="display:flex; align-items:center; gap:12px; padding:10px; border:1px solid #334155; border-radius:10px; background:#0b1220;">
            <canvas class="char-icon" width="80" height="80" data-role="shooter" data-shape="circle"></canvas>
            <div>
              <div class="shop-name" style="font-weight:700; color:#e2e8f0;" data-lang="enemy_shooter_title">Shooter</div>
              <div class="shop-desc" style="color:#94a3b8; font-size:14px;" data-lang="enemy_shooter_desc">Fires periodic energy shots from mid-range; steady rhythm, medium speed.</div>
            </div>
          </div>
          <div class="char-item" style="display:flex; align-items:center; gap:12px; padding:10px; border:1px solid #334155; border-radius:10px; background:#0b1220;">
            <canvas class="char-icon" width="80" height="80" data-role="sniper" data-shape="triangle"></canvas>
            <div>
              <div class="shop-name" style="font-weight:700; color:#e2e8f0;" data-lang="enemy_sniper_title">Sniper</div>
              <div class="shop-desc" style="color:#94a3b8; font-size:14px;" data-lang="enemy_sniper_desc">Stays far away; aims, then fires a delayed but high-damage shot.</div>
            </div>
          </div>
          <div class="char-item" style="display:flex; align-items:center; gap:12px; padding:10px; border:1px solid #334155; border-radius:10px; background:#0b1220;">
            <canvas class="char-icon" width="80" height="80" data-role="charger" data-shape="circle"></canvas>
            <div>
              <div class="shop-name" style="font-weight:700; color:#e2e8f0;" data-lang="enemy_charger_title">Charger</div>
              <div class="shop-desc" style="color:#94a3b8; font-size:14px;" data-lang="enemy_charger_desc">After a short telegraph, surges in a straight line and rams you.</div>
            </div>
          </div>
          <div class="char-item" style="display:flex; align-items:center; gap:12px; padding:10px; border:1px solid #334155; border-radius:10px; background:#0b1220;">
            <canvas class="char-icon" width="80" height="80" data-role="brute" data-shape="triangle"></canvas>
            <div>
              <div class="shop-name" style="font-weight:700; color:#e2e8f0;" data-lang="enemy_brute_title">Brute</div>
              <div class="shop-desc" style="color:#94a3b8; font-size:14px;" data-lang="enemy_brute_desc">High HP and mass; strong shove on contact. Slow but relentless.</div>
            </div>
          </div>
          <div class="char-item" style="display:flex; align-items:center; gap:12px; padding:10px; border:1px solid #334155; border-radius:10px; background:#0b1220;">
            <canvas class="char-icon" width="80" height="80" data-role="assassin" data-shape="triangle"></canvas>
            <div>
              <div class="shop-name" style="font-weight:700; color:#e2e8f0;" data-lang="enemy_assassin_title">Assassin</div>
              <div class="shop-desc" style="color:#94a3b8; font-size:14px;" data-lang="enemy_assassin_desc">Shifts in and out of visibility; ambushes and closes in suddenly.</div>
            </div>
          </div>
          <div class="char-item" style="display:flex; align-items:center; gap:12px; padding:10px; border:1px solid #334155; border-radius:10px; background:#0b1220;">
            <canvas class="char-icon" width="80" height="80" data-role="juggernaut" data-shape="circle"></canvas>
            <div>
              <div class="shop-name" style="font-weight:700; color:#e2e8f0;" data-lang="enemy_juggernaut_title">Juggernaut</div>
              <div class="shop-desc" style="color:#94a3b8; font-size:14px;" data-lang="enemy_juggernaut_desc">Blocks bullets with a rotating front shield; a heavy tank that advances slowly.</div>
            </div>
          </div>
          <div class="char-item" style="display:flex; align-items:center; gap:12px; padding:10px; border:1px solid #334155; border-radius:10px; background:#0b1220;">
            <canvas class="char-icon" width="80" height="80" data-role="parasite" data-shape="circle"></canvas>
            <div>
              <div class="shop-name" style="font-weight:700; color:#e2e8f0;" data-lang="enemy_parasite_title">Parasite</div>
              <div class="shop-desc" style="color:#94a3b8; font-size:14px;" data-lang="enemy_parasite_desc">Applies a debuff on contact and wears you down by staying close.</div>
            </div>
          </div>
          <div class="char-item" style="display:flex; align-items:center; gap:12px; padding:10px; border:1px solid #334155; border-radius:10px; background:#0b1220;">
            <canvas class="char-icon" width="80" height="80" data-role="mutant" data-shape="triangle"></canvas>
            <div>
              <div class="shop-name" style="font-weight:700; color:#e2e8f0;" data-lang="enemy_mutant_title">Mutant</div>
              <div class="shop-desc" style="color:#94a3b8; font-size:14px;" data-lang="enemy_mutant_desc">Changes form and behavior as waves progress; hard to predict.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Builds Overlay (in-page modal) -->
    <div id="buildsOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.65); z-index:10050; align-items:center; justify-content:center;">
      <div class="card" style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:rgba(0,0,0,0.95); padding:26px; border-radius:16px; border:2px solid #00ffff; box-shadow:0 0 30px #00ffff; width:min(980px, 96vw); max-height:86vh; overflow:auto;">
        <div class="header" style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px;">
          <h1 data-lang="buildersTitle" style="color:#00ffff; margin:0;">Builds</h1>
          <button type="button" id="closeBuildsBtn" class="btn" style="background:#0ea5e9; color:#001018; border:none; border-radius:10px; padding:8px 12px; font-weight:700; cursor:pointer;" data-lang="close">Close</button>
        </div>
        <p class="sub" data-lang="buildersSubtitle" style="color:#b6c2d1; margin: 0 0 12px 0; text-align:center;">Recommended builds for each element (quick reference).</p>
        <div class="tabs" style="display:flex; gap:8px; justify-content:center; margin: 12px 0 16px 0; flex-wrap:wrap;">
          <button class="tab-btn active" data-tab="fire" style="background:#0b1220; border:1px solid #334155; color:#e2e8f0; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:700;"><span data-lang="elFire"> Fire</span></button>
          <button class="tab-btn" data-tab="water" style="background:#0b1220; border:1px solid #334155; color:#e2e8f0; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:700;"><span data-lang="elWater"> Water</span></button>
          <button class="tab-btn" data-tab="air" style="background:#0b1220; border:1px solid #334155; color:#e2e8f0; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:700;"><span data-lang="elAir"> Air</span></button>
        </div>
        <section id="tab-fire" class="section" style="display:block;">
          <div class="grid" style="display:grid; grid-template-columns: repeat(1, 1fr); gap:12px;">
            <div class="build" style="background:#0b1220; border:1px solid #334155; border-radius:10px; padding:12px;">
              <h3 style="margin:0 0 6px 0; color:#e2e8f0;" data-lang="build_fire_crit_title">Burn Crit</h3>
              <small style="color:#94a3b8; display:block; margin-bottom:8px;" data-lang="build_fire_crit_desc">High damage with explosive AoE</small>
              <ul style="margin:0; padding-left:18px; color:#94a3b8;">
                <li data-lang="build_fire_crit_i1">Flame Dance</li>
                <li data-lang="build_fire_crit_i2">Crimson Dew</li>
                <li data-lang="build_fire_crit_i3">Fire Ring</li>
                <li data-lang="build_fire_crit_i4">Critical Flame</li>
              </ul>
            </div>
            <div class="build" style="background:#0b1220; border:1px solid #334155; border-radius:10px; padding:12px;">
              <h3 style="margin:0 0 6px 0; color:#e2e8f0;" data-lang="build_fire_layers_title">Stacking Burns</h3>
              <small style="color:#94a3b8; display:block; margin-bottom:8px;" data-lang="build_fire_layers_desc">Sustained DPS via burn layers</small>
              <ul style="margin:0; padding-left:18px; color:#94a3b8;">
                <li data-lang="build_fire_layers_i1">Lingering Burn</li>
                <li data-lang="build_fire_layers_i2">Ember Trail</li>
                <li data-lang="build_fire_layers_i3">Heat Wave</li>
                <li data-lang="build_fire_layers_i4">Charred Heart</li>
              </ul>
            </div>
            <div class="build" style="background:#0b1220; border:1px solid #334155; border-radius:10px; padding:12px;">
              <h3 style="margin:0 0 6px 0; color:#e2e8f0;" data-lang="build_fire_explosive_title">Explosive</h3>
              <small style="color:#94a3b8; display:block; margin-bottom:8px;" data-lang="build_fire_explosive_desc">Mini explosions on contact</small>
              <ul style="margin:0; padding-left:18px; color:#94a3b8;">
                <li data-lang="build_fire_explosive_i1">Spark Charge</li>
                <li data-lang="build_fire_explosive_i2">Volatile Flame</li>
                <li data-lang="build_fire_explosive_i3">Pressurized Core</li>
                <li data-lang="build_fire_explosive_i4">Volcano</li>
              </ul>
            </div>
          </div>
        </section>
        <section id="tab-water" class="section" style="display:none;">
          <div class="grid" style="display:grid; grid-template-columns: repeat(1, 1fr); gap:12px;">
            <div class="build" style="background:#0b1220; border:1px solid #334155; border-radius:10px; padding:12px;">
              <h3 style="margin:0 0 6px 0; color:#e2e8f0;" data-lang="build_water_waves_title">Wavebreaker</h3>
              <small style="color:#94a3b8; display:block; margin-bottom:8px;" data-lang="build_water_waves_desc">Area control and slows</small>
              <ul style="margin:0; padding-left:18px; color:#94a3b8;">
                <li data-lang="build_water_waves_i1">Tide Ring</li>
                <li data-lang="build_water_waves_i2">Cold Current</li>
                <li data-lang="build_water_waves_i3">Dense Mist</li>
                <li data-lang="build_water_waves_i4">Deep Pressure</li>
              </ul>
            </div>
            <div class="build" style="background:#0b1220; border:1px solid #334155; border-radius:10px; padding:12px;">
              <h3 style="margin:0 0 6px 0; color:#e2e8f0;" data-lang="build_water_flow_title">Flow Master</h3>
              <small style="color:#94a3b8; display:block; margin-bottom:8px;" data-lang="build_water_flow_desc">Mobility + healing</small>
              <ul style="margin:0; padding-left:18px; color:#94a3b8;">
                <li data-lang="build_water_flow_i1">Reviving Drops</li>
                <li data-lang="build_water_flow_i2">Drizzle Veil</li>
                <li data-lang="build_water_flow_i3">Fluid Armor</li>
                <li data-lang="build_water_flow_i4">River Rhythm</li>
              </ul>
            </div>
            <div class="build" style="background:#0b1220; border:1px solid #334155; border-radius:10px; padding:12px;">
              <h3 style="margin:0 0 6px 0; color:#e2e8f0;" data-lang="build_water_ice_title">Ice Control</h3>
              <small style="color:#94a3b8; display:block; margin-bottom:8px;" data-lang="build_water_ice_desc">Lower speed, higher control</small>
              <ul style="margin:0; padding-left:18px; color:#94a3b8;">
                <li data-lang="build_water_ice_i1">Freezing Point</li>
                <li data-lang="build_water_ice_i2">Ice Flake</li>
                <li data-lang="build_water_ice_i3">Frost Touch</li>
                <li data-lang="build_water_ice_i4">Polar Silence</li>
              </ul>
            </div>
          </div>
        </section>
        <section id="tab-air" class="section" style="display:none;">
          <div class="grid" style="display:grid; grid-template-columns: repeat(1, 1fr); gap:12px;">
            <div class="build" style="background:#0b1220; border:1px solid #334155; border-radius:10px; padding:12px;">
              <h3 style="margin:0 0 6px 0; color:#e2e8f0;" data-lang="build_air_crit_title">Crit Storm</h3>
              <small style="color:#94a3b8; display:block; margin-bottom:8px;" data-lang="build_air_crit_desc">High crit, fast gameplay</small>
              <ul style="margin:0; padding-left:18px; color:#94a3b8;">
                <li data-lang="build_air_crit_i1">Storm Fury</li>
                <li data-lang="build_air_crit_i2">Rising Pressure</li>
                <li data-lang="build_air_crit_i3">Thunderclap</li>
                <li data-lang="build_air_crit_i4">Endless Breeze</li>
              </ul>
            </div>
            <div class="build" style="background:#0b1220; border:1px solid #334155; border-radius:10px; padding:12px;">
              <h3 style="margin:0 0 6px 0; color:#e2e8f0;" data-lang="build_air_dodger_title">Dodger</h3>
              <small style="color:#94a3b8; display:block; margin-bottom:8px;" data-lang="build_air_dodger_desc">Dodging and survival</small>
              <ul style="margin:0; padding-left:18px; color:#94a3b8;">
                <li data-lang="build_air_dodger_i1">Light Steps</li>
                <li data-lang="build_air_dodger_i2">Storm Armor</li>
                <li data-lang="build_air_dodger_i3">Wind Shield</li>
                <li data-lang="build_air_dodger_i4">Feather Charm</li>
              </ul>
            </div>
            <div class="build" style="background:#0b1220; border:1px solid #334155; border-radius:10px; padding:12px;">
              <h3 style="margin:0 0 6px 0; color:#e2e8f0;" data-lang="build_air_assassin_title">Assassin Speed</h3>
              <small style="color:#94a3b8; display:block; margin-bottom:8px;" data-lang="build_air_assassin_desc">Move speed and burst damage</small>
              <ul style="margin:0; padding-left:18px; color:#94a3b8;">
                <li data-lang="build_air_assassin_i1">Wind Boots</li>
                <li data-lang="build_air_assassin_i2">Jet Stream</li>
                <li data-lang="build_air_assassin_i3">Feather Trigger</li>
                <li data-lang="build_air_assassin_i4">Storm Rush</li>
              </ul>
            </div>
          </div>
        </section>
      </div>
    </div>
    <script>
      // Minimal wiring for overlay close buttons and Builds tabs
      (function(){
        function onReady(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
        onReady(function(){
          try{ var cb = document.getElementById('closeCharactersBtn'); if(cb) cb.addEventListener('click', function(){ try{ window.closeCharactersOverlay && window.closeCharactersOverlay(); }catch(_){ } }); }catch(_){ }
          try{ var bb = document.getElementById('closeBuildsBtn'); if(bb) bb.addEventListener('click', function(){ try{ window.closeBuildsOverlay && window.closeBuildsOverlay(); }catch(_){ } }); }catch(_){ }
          try{
            var builds = document.getElementById('buildsOverlay');
            if(builds){
              var buttons = Array.prototype.slice.call(builds.querySelectorAll('.tab-btn'));
              var sections = {
                fire: document.getElementById('tab-fire'),
                water: document.getElementById('tab-water'),
                air: document.getElementById('tab-air')
              };
              function activate(key){
                buttons.forEach(function(b){ b.classList.toggle('active', b.getAttribute('data-tab')===key); });
                Object.keys(sections).forEach(function(k){ if(sections[k]) sections[k].style.display = (k===key)?'block':'none'; });
              }
              buttons.forEach(function(b){ b.addEventListener('click', function(){ activate(b.getAttribute('data-tab')); }); });
              // default to fire each time overlay opens
              activate('fire');
            }
          }catch(_){ }
        });
      })();
    </script>
    <!-- Bottom HUD Consumable Bar (5 slots) -->
    <div id="consumableBar" aria-label="Consumables">
      <div class="consumable-slot" id="consumSlot1" title="Slot 1">
        <span class="key">1</span>
        <span class="timer" id="consum1Timer"></span>
        <span class="icon" id="consum1Icon"></span>
        <span class="count" id="consum1Count" style="display:none;">1</span>
      </div>
      <div class="consumable-slot" id="consumSlot2" title="Slot 2">
        <span class="key">2</span>
        <span class="timer" id="consum2Timer"></span>
        <span class="icon" id="consum2Icon"></span>
        <span class="count" id="consum2Count" style="display:none;">1</span>
      </div>
      <div class="consumable-slot" id="consumSlot3" title="Slot 3">
        <span class="key">3</span>
        <span class="timer" id="consum3Timer"></span>
        <span class="icon" id="consum3Icon"></span>
        <span class="count" id="consum3Count" style="display:none;">1</span>
      </div>
      <div class="consumable-slot" id="consumSlot4" title="Slot 4">
        <span class="key">4</span>
        <span class="timer" id="consum4Timer"></span>
        <span class="icon" id="consum4Icon"></span>
        <span class="count" id="consum4Count" style="display:none;">1</span>
      </div>
      <div class="consumable-slot" id="consumSlot5" title="Slot 5">
        <span class="key">5</span>
        <span class="timer" id="consum5Timer"></span>
        <span class="icon" id="consum5Icon"></span>
        <span class="count" id="consum5Count" style="display:none;">1</span>
      </div>
    </div>

    <div id="ui">
        <!-- Debug Overlay (F3 toggle) -->
        <div id="debugOverlay">
            <div class="title">Debug</div>
            <div class="row"><div class="k">FPS</div><div class="v" id="dbgFps">-</div></div>
            <div class="row"><div class="k">Spawn/s</div><div class="v" id="dbgRate">-</div></div>
            <div class="row"><div class="k">Interval</div><div class="v" id="dbgInterval">-</div></div>
            <div class="row"><div class="k">Accumulator</div><div class="v" id="dbgAccum">-</div></div>
            <div class="row"><div class="k">Budget</div><div class="v" id="dbgBudget">-</div></div>
            <div class="row"><div class="k">DesiredCap</div><div class="v" id="dbgDesired">-</div></div>
            <div class="row"><div class="k">Alive</div><div class="v" id="dbgAlive">-</div></div>
        </div>
        <!-- Stats Overlay (best wave/score and last runs) -->
        <div id="statsPanel" style="position:fixed; top:14px; right:14px; z-index:10010;">
          <h3 data-lang="runStatsTitle">Run Stats</h3>
          <div id="statsSummary">
              <div><strong data-lang="bestWaveLabel">Best Wave</strong>: <span id="statsBestWave">-</span></div>
              <div><strong data-lang="bestScoreLabel">Best Score</strong>: <span id="statsBestScore">-</span></div>
          </div>
          <button id="resetStatsBtn" class="menu-btn" style="width:auto; margin:8px 0; padding:6px 10px;" data-lang="resetStats">Reset Stats</button>
          <ul id="statsLastRuns"></ul>
        </div>
        <div id="startScreen">
            <h1 id="startTitle" data-lang="gameTitle"> ELEMENTIST </h1>
            <p id="startSubtitle" data-lang="subtitle">Collect energy in a neon universe, grow, and defeat your rivals!</p>
            
            <!-- Banner Ad -->
            <div style="display: flex; justify-content: center; margin: 15px 0;">
                <script>
                    atOptions = {
                        'key' : 'ce673f1e09efadddcb7e75ee9d586e4a',
                        'format' : 'iframe',
                        'height' : 50,
                        'width' : 320,
                        'params' : {}
                    };
                </script>
                <script src="https://www.highperformanceformat.com/ce673f1e09efadddcb7e75ee9d586e4a/invoke.js"></script>
            </div>
            
            <button id="startBtn" data-lang="startGame">START GAME</button>
            <button id="settingsBtn" class="primary-btn" style="margin-top:10px;" data-lang="settings">SETTINGS</button>
            <button id="howToBtn" class="primary-btn" style="margin-top:10px;" data-lang="howTo">HOW TO PLAY</button>
            <button id="charactersBtn" class="primary-btn" style="margin-top:10px;" data-lang="characters">CHARACTERS</button>
            <button id="shopBtn" class="primary-btn" style="margin-top:10px;" data-lang="shop">SHOP</button>
            <button id="buildsBtn" class="primary-btn" style="margin-top:10px;" data-lang="builders">BUILDS</button>
            <div style="display:block; margin-top:10px;">
                <button id="closeGameBtn" class="primary-btn" data-lang="close">CLOSE</button>
            </div>
            <div style="display:block; margin-top:10px;">
                <button id="backToHubBtn" class="primary-btn" data-lang="backToMenuBtn">BACK TO MENU</button>
            </div>
            <div class="social-links">
                <h3 class="brand-242" data-lang="followUs">242 Games</h3>
            </div>
            <!-- Buy Me a Coffee Banner -->
            <div style="position: fixed; bottom: 10px; right: 10px; z-index: 1000; opacity: 0.6; transition: opacity 0.3s ease; text-align: center;" 
                 onmouseover="this.style.opacity='1'" 
                 onmouseout="this.style.opacity='0.6'">
              <div class="support-message" style="background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57, #ff6b6b); background-size: 300% 300%; -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; animation: gradientShift 3s ease-in-out infinite; font-size: 10px; font-weight: 600; margin-bottom: 3px; text-shadow: 0 0 8px rgba(255,255,255,0.3); line-height: 1.2;">
                <div class="desktop-text">Support the solo dev (2$)</div>
                <div class="mobile-text" style="display: none;">Support<br>solo dev  (2$)</div>
              </div>
              <a href="https://buymeacoffee.com/gameist" target="_blank" rel="noopener noreferrer" style="text-decoration: none;">
                <img class="desktop-img" src="../assets/buymeacoffee.png" alt="Buy Me a Coffee" style="width: 100px; height: auto; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                <img class="mobile-img" src="../assets/buymeacoffee.png" alt="Buy Me a Coffee" style="width: 80px; height: auto; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: none;">
              </a>
            </div>
            
            <style>
            @keyframes gradientShift {
              0% { background-position: 0% 50%; }
              50% { background-position: 100% 50%; }
              100% { background-position: 0% 50%; }
            }
            
            @media (max-width: 768px) {
              .desktop-text { display: none !important; }
              .mobile-text { display: block !important; font-size: 9px !important; margin-bottom: 2px !important; line-height: 1.1 !important; }
              .desktop-img { display: none !important; }
              .mobile-img { display: inline !important; }
            }
            </style>
            
            <style>
            @keyframes gradientShift {
              0% { background-position: 0% 50%; }
              50% { background-position: 100% 50%; }
              100% { background-position: 0% 50%; }
            }
            </style>
        </div>
        <!-- Element + Character Select Overlay (shown after pressing start) -->
        <div id="elementSelectOverlay" style="display:none; position:absolute; inset:0; background:rgba(0,0,0,0.9); pointer-events:all; z-index:999;">
            <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:rgba(0,0,0,0.9); padding:30px; border-radius:20px; border:2px solid #00ffff; box-shadow:0 0 30px #00ffff; text-align:center; width: min(760px, 96vw); max-height: 88vh; overflow:auto; position:relative;">
                <button id="elementBackBtn" class="menu-btn" style="position:absolute; top:10px; right:10px; width:auto; padding:6px 10px; z-index:2;" data-lang="back"> Back</button>
                <h2 id="charElementTitle" style="color:#00ffff; margin:0 0 12px 0;" data-lang="charElementTitle">Select Character & Element</h2>
                <div id="characterSelect" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:10px; margin-bottom:14px;">
                    <button class="char-btn" data-char="berserker" style="padding:10px; border:1px solid #ef4444; border-radius:10px; background:#1a0b0b; color:#fca5a5; cursor:pointer; text-align:left;">
                        <div id="charName_berserker" style="font-weight:800; color:#ef4444;" data-lang="char_berserker_name">Berserker</div>
                        <small id="charDesc_berserker" data-lang="char_berserker_desc">+Damage, +Attack Speed, -Armor</small>
                    </button>
                    <button class="char-btn" data-char="guardian" style="padding:10px; border:1px solid #3b82f6; border-radius:10px; background:#0b1020; color:#93c5fd; cursor:pointer; text-align:left;">
                        <div id="charName_guardian" style="font-weight:800; color:#3b82f6;" data-lang="char_guardian_name">Guardian</div>
                        <small id="charDesc_guardian" data-lang="char_guardian_desc">+HP, +Armor, -Speed</small>
                    </button>
                    <button class="char-btn" data-char="ranger" style="padding:10px; border:1px solid #22c55e; border-radius:10px; background:#0b1a12; color:#86efac; cursor:pointer; text-align:left;">
                        <div id="charName_ranger" style="font-weight:800; color:#22c55e;" data-lang="char_ranger_name">Ranger</div>
                        <small id="charDesc_ranger" data-lang="char_ranger_desc">+Range, +Bullet Speed</small>
                    </button>
                    <button class="char-btn" data-char="engineer" style="padding:10px; border:1px solid #eab308; border-radius:10px; background:#1a1606; color:#fde68a; cursor:pointer; text-align:left;">
                        <div id="charName_engineer" style="font-weight:800; color:#eab308;" data-lang="char_engineer_name">Engineer</div>
                        <small id="charDesc_engineer" data-lang="char_engineer_desc">+Turret Synergy, +Materials</small>
                    </button>
                    <button class="char-btn" data-char="rogue" style="padding:10px; border:1px solid #a855f7; border-radius:10px; background:#160b1f; color:#d8b4fe; cursor:pointer; text-align:left;">
                        <div id="charName_rogue" style="font-weight:800; color:#a855f7;" data-lang="char_rogue_name">Rogue</div>
                        <small id="charDesc_rogue" data-lang="char_rogue_desc">+Speed, +Crit</small>
                    </button>
                </div>
                <h2 id="elementOverlayTitle" style="color:#00ffff; margin-bottom:10px;" data-lang="elementOverlayTitle">Choose Your Element</h2>
                <p id="elementOverlayDesc" style="opacity:0.8; margin-bottom:16px;" data-lang="elementOverlayDesc">Your element defines your special ability. Cooldown: 10s</p>
                <div class="element-selection" style="margin-top:12px;">
                    <button id="chooseFire" class="element-btn fire" data-element="fire" data-lang="elFire"> Fire</button>
                    <button id="chooseWater" class="element-btn water" data-element="water" data-lang="elWater"> Water</button>
                    <button id="chooseAir" class="element-btn air" data-element="air" data-lang="elAir"> Air</button>
                </div>
            </div>
        </div>
        <script>
          (function(){
            const btn = document.getElementById('elementBackBtn');
            const ov = document.getElementById('elementSelectOverlay');
            const start = document.getElementById('startScreen');
            if(btn && ov){
              btn.addEventListener('click', function(){
                try{ ov.style.display='none'; }catch(_){ }
                try{ if(start) start.style.display='block'; }catch(_){ }
              });
            }
          })();
        </script>
        <div id="gameUI">
            <div class="stat">
                <div><span id="scoreLabel" data-lang="score">Score:</span> <span id="score">0</span></div>
                <div><span id="materialsTopLabel" data-lang="materials">Materials:</span> <span id="materialsTop">0</span></div>
                <div><span id="elementTopLabel" data-lang="element">Element:</span> <span id="elementType">-</span></div>
            </div>
            <div class="stat" id="livesStat" style="display:flex; align-items:center; gap:8px;">
                <span data-lang="lives">Lives:</span>
                <div id="livesDisplay" style="letter-spacing:4px; font-size:18px;"></div>
            </div>
        </div>
        <div id="timer">5:00</div>
        <!-- Life use overlay (shown when a heart is consumed) -->
        <div id="lifeOverlay">
            <div id="lifeOverlayIcon"></div>
        </div>
        <!-- Magnet grant overlay (shown when magnet is granted) -->
        <div id="magnetOverlay">
            <div id="magnetOverlayIcon"></div>
        </div>
        <div id="gameOverScreen" style="display:none; position:fixed; inset:0; width:100vw; height:100vh; align-items:center; justify-content:center; background:rgba(0,0,0,0.92); z-index:9999; backdrop-filter: blur(8px);">
            <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:linear-gradient(135deg, rgba(10,10,15,0.98), rgba(26,26,46,0.95)); border:2px solid var(--neon-cyan); box-shadow:0 0 25px var(--neon-cyan), 0 8px 32px rgba(0,0,0,0.4), inset 0 0 20px rgba(0,255,255,0.05); border-radius:24px; padding:40px 35px; width:min(620px, 92vw); text-align:center; animation: gameOverPulse 0.8s ease-out;">
                <h2 id="gameOverTitle" data-lang="gameOverTitle" style="color:var(--neon-cyan); margin:0 0 20px 0; letter-spacing:3px; font-size:clamp(28px, 6vw, 36px); text-shadow:0 0 25px var(--neon-cyan); animation: titleGlow 2.5s ease-in-out infinite; font-weight:800;">YOU DIED</h2>
                
                <!-- Enhanced Stats Container -->
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:25px; padding:20px; background:rgba(0,0,0,0.6); border-radius:16px; border:1px solid rgba(0,255,255,0.15); backdrop-filter: blur(4px);">
                    <!-- Left Column - Main Stats -->
                    <div style="text-align:left; padding-right:10px;">
                        <div id="finalStats" style="color:var(--text-secondary); font-size:15px; line-height:2; margin-bottom:10px;"></div>
                    </div>
                    <!-- Right Column - Run Stats -->
                    <div style="text-align:left; padding-left:10px; border-left:1px solid rgba(0,255,255,0.1);">
                        <div id="runTimeStats" style="color:var(--text-muted); font-size:14px; line-height:2;">
                            <div style="margin-bottom:8px; display:flex; align-items:center; gap:8px;">
                                <span style="color:var(--neon-green); font-weight:700; font-size:16px;"></span>
                                <span data-lang="lastRunLabel">Son Kou:</span>
                                <span id="lastRunTime" style="color:var(--neon-green); font-weight:600; margin-left:auto;">--:--</span>
                            </div>
                            <div style="margin-bottom:8px; display:flex; align-items:center; gap:8px;">
                                <span style="color:var(--neon-orange); font-weight:700; font-size:16px;"></span>
                                <span data-lang="bestRunLabel">En yi:</span>
                                <span id="bestRunTime" style="color:var(--neon-orange); font-weight:600; margin-left:auto;">--:--</span>
                            </div>
                            <div style="margin-bottom:8px; display:flex; align-items:center; gap:8px;">
                                <span style="color:var(--neon-blue); font-weight:700; font-size:16px;"></span>
                                <span data-lang="waveLabel">Wave:</span>
                                <span id="finalWave" style="color:var(--neon-blue); font-weight:600; margin-left:auto;">0</span>
                            </div>
                            <div style="display:flex; align-items:center; gap:8px;">
                                <span style="color:var(--neon-red); font-weight:700; font-size:16px;"></span>
                                <span data-lang="killsLabel">Kills:</span>
                                <span id="finalKills" style="color:var(--neon-red); font-weight:600; margin-left:auto;">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div style="display:flex; gap:12px; justify-content:center; flex-wrap:wrap;">
                    <button id="restartBtn" class="btn btn-green" data-lang="restartBtn" style="flex:1; min-width:140px; padding:12px 20px; font-size:16px; font-weight:700; border-radius:12px;">RETRY</button>
                    <button id="backToMenuBtn" class="btn btn-red" data-lang="backToMenuBtn" style="flex:1; min-width:140px; padding:12px 20px; font-size:16px; font-weight:700; border-radius:12px;">BACK TO MENU</button>
                </div>
                
                <!-- Death Hint -->
                <div id="deathHint" style="margin-top:20px; padding:12px; background:rgba(0,255,255,0.05); border:1px solid rgba(0,255,255,0.2); border-radius:8px; color:var(--text-muted); font-size:13px; font-style:italic;"></div>
            </div>
        </div>
        <div id="inGameMenu">
            <h3 id="inGameMenuTitle" data-lang="inGameMenuTitle">PAUSE MENU</h3>
            <button id="resumeBtn" class="menu-btn" data-lang="resumeBtn">RESUME</button>
            <button id="howToIngameBtn" class="menu-btn" data-lang="howTo">HOW TO PLAY</button>
            <!-- In-game audio controls: use unique IDs to avoid conflicts with settings panel -->
            <button id="soundToggleIngame" class="menu-btn" aria-pressed="false" style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                <span data-lang="sound">Sound</span>
                <span id="soundStateIngame" class="state-chip" style="padding:2px 8px; border:1px solid #334155; border-radius:999px; font-size:12px; opacity:.9;"></span>
            </button>
            <button id="musicToggleIngame" class="menu-btn" aria-pressed="false" style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                <span data-lang="music">Music</span>
                <span id="musicStateIngame" class="state-chip" style="padding:2px 8px; border:1px solid #334155; border-radius:999px; font-size:12px; opacity:.9;"></span>
            </button>
            <button id="backToMenuIngameBtn" class="menu-btn" data-lang="backToMenuBtn">BACK TO MENU</button>
            <div style="margin-top:14px; text-align:left;">
                <div id="sensitivityRow">
                    <label for="sensitivityRange" style="display:block; margin:8px 0 4px; color:#7dd3fc;"><span id="sensitivityLabel" data-lang="mouseSensitivity">Mouse Sensitivity</span>: <span id="sensitivityValue">1.00x</span></label>
                    <input id="sensitivityRange" type="range" min="0.5" max="2.0" step="0.05" value="1.00" style="width:100%;" />
                </div>
                <div id="fovRow" style="display:none;">
                    <label for="fovRange" style="display:block; margin:12px 0 4px; color:#7dd3fc;">FOV (Near/Far): <span id="fovValue">1.00x</span></label>
                    <input id="fovRange" type="range" min="0.7" max="1.5" step="0.05" value="1.00" style="width:100%;" />
                </div>
                <label for="volumeRange" data-lang="volume" style="display:block; margin:12px 0 4px; color:#7dd3fc;">Volume: <span id="volumeValue">100%</span></label>
                <input id="volumeRange" type="range" min="0" max="1" step="0.01" value="1" style="width:100%; pointer-events:auto; position:relative; z-index:1;" />
                <label for="musicVolumeRange" data-lang="music" style="display:block; margin:12px 0 4px; color:#7dd3fc;">Music: <span id="musicVolumeValueIngame">30%</span></label>
                <input id="musicVolumeRange" type="range" min="0" max="1" step="0.01" value="0.3" style="width:100%;" />
            </div>
        </div>
        <div class="ability-cooldown">
            <div class="ability-icon" id="abilityIcon">
                <span id="abilitySymbol"></span>
                <div class="cooldown-overlay" id="cooldownOverlay" style="display: none;">
                    <span id="cooldownText">3</span>
                </div>
            </div>
        </div>
        <!-- Power-up Display (center around player) -->
        <div class="power-up-display" id="powerUpDisplay">
            <div class="power-up-icon" id="powerUpIcon"></div>
            <svg class="power-up-cooldown-bar" id="powerUpCooldownBar" viewBox="0 0 100 100" style="display: none;">
                <circle cx="50" cy="50" r="45" fill="none" stroke="rgba(34, 197, 94, 0.2)" stroke-width="2"/>
                <circle cx="50" cy="50" r="45" fill="none" stroke="#22c55e" stroke-width="2.5" 
                        stroke-dasharray="282.7" stroke-dashoffset="0" class="power-up-progress"/>
            </svg>
        </div>
        <!-- Mini Hint Toast Popup -->
        <div id="hintToast" class="hint-toast">
            <span id="hintToastText">New power-up active!</span>
        </div>
    </div>
    <!-- Touch Controls (mobile) -->
    <div id="touchControls">
        <div id="joystick">
            <div id="joystickNub"></div>
        </div>
        <!-- Mobile Pause Button (top-right) -->
        <button id="pauseBtnMobile" aria-label="Pause" title="Pause"
            style="position:absolute; top: 92px; right: 16px; width:44px; height:44px; border-radius:50%;
                   background: rgba(0, 0, 0, 0.45); border:2px solid #00ffff; color:#00ffff; font-weight:800;
                   box-shadow: 0 0 14px rgba(0,255,255,0.4); backdrop-filter: blur(2px); letter-spacing:1px;
                   pointer-events: all; touch-action: manipulation; cursor: pointer; z-index:31;">
            II
        </button>
        <button id="dodgeBtn" aria-label="Dodge" title="Dodge" data-lang="dodgeBtn">DODGE</button>
        <button id="skillBtn" data-lang="skillBtn">SKILL</button>
    </div>
    <!-- Removed TR/EN language toggle buttons -->
    <!-- Brotato Shop Overlay (moved inside body) -->
    <div id="shopOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.65); z-index:10000; align-items:center; justify-content:center;">
      <div class="shop-box" style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#111; color:#eee; padding:18px; border-radius:10px; width:820px; max-width:96vw; box-shadow:0 10px 30px rgba(0,0,0,0.5);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
          <div>
            <div id="shopTitle" data-lang="shopTitle" style="font-size:20px; font-weight:700;"></div>
            <div id="shopWaveLabel" style="opacity:0.8; font-size:13px;"></div>
          </div>
          <div style="display:flex; gap:14px; font-size:14px;">
            <div><span id="materialsLabel" data-lang="materials">Materials:</span> <span id="materialsValue">0</span></div>
            <div><span id="xpLabel" data-lang="xp">XP:</span> <span id="xpValue">0</span></div>
          </div>
        </div>
        <!-- Tabs -->
        <div id="shopTabs" style="display:flex; gap:8px; margin-bottom:10px;">
          <button id="tabOffersBtn" class="menu-btn" style="display:none; width:auto; padding:6px 10px; border-color:#f59e0b; color:#f59e0b;" data-lang="tabOffers">Rewards</button>
          <button id="tabItemsBtn" class="menu-btn" style="width:auto; padding:6px 10px; border-color:#38bdf8; color:#38bdf8;" data-lang="tabItems">Items</button>
          <button id="tabUpgradesBtn" class="menu-btn" style="width:auto; padding:6px 10px; border-color:#a78bfa; color:#a78bfa;" data-lang="tabUpgrades">Upgrades</button>
          <button id="tabSpecialBtn" class="menu-btn" style="width:auto; padding:6px 10px; border-color:#34d399; color:#34d399;" data-lang="tabSpecial">Special</button>
        </div>
        <div class="shop-divider"></div>
        <!-- Main area: left grid + right stat panel -->
        <div style="display:flex; gap:12px; align-items:flex-start;">
          <div style="flex:1; min-width:0;">
            <div id="shopItems" style="display:grid; grid-template-columns:repeat(2, 1fr); gap:10px;"></div>
          </div>
          <div id="shopStatPanel" style="width:220px; border:1px solid #334155; background:#0b1220; border-radius:10px; padding:10px;">
            <div style="font-weight:700; color:#7dd3fc; margin-bottom:8px;" data-lang="shopStatsTitle">Stats</div>
            <div id="shopStatsBody" style="font-size:12px; color:#cbd5e1; display:grid; gap:6px;">
              <div><strong>DMG</strong>: <span id="statDMG">-</span></div>
              <div><strong>ATK</strong>: <span id="statATK">-</span></div>
              <div><strong>SPD</strong>: <span id="statSPD">-</span></div>
              <div><strong>ARM</strong>: <span id="statARM">-</span></div>
              <div><strong>DODGE</strong>: <span id="statDODGE">-</span></div>
              <div><strong>HP</strong>: <span id="statHP">-</span></div>
              <div><strong>REGEN</strong>: <span id="statREGEN">-</span></div>
              <div><strong>BURN</strong>: <span id="statBURN">-</span></div>
              <div><strong>SLOW</strong>: <span id="statSLOW">-</span></div>
              <div style="margin-top:6px; color:#93c5fd;" data-lang="activeBuffsTitle">Active Buffs</div>
              <div id="activeBuffsList" style="display:flex; flex-wrap:wrap; gap:6px;"></div>
              <div style="margin-top:8px; color:#93c5fd; font-weight:700;">WEAPON</div>
              <div id="shopWeaponStats" style="display:grid; grid-template-columns: 1fr 1fr; gap:4px 6px;"></div>
            </div>
          </div>
        </div>
        <div style="display:flex; justify-content:space-between; margin-top:14px;">
          <div style="display:flex; gap:8px;">
            <button id="lockBtn" data-lang="lockBtn" style="padding:8px 12px; background:#0f172a; color:#fff; border:1px solid #334155; border-radius:6px;">Lock</button>
          </div>
          <button id="startWaveBtn" style="padding:10px 16px; background:#047857; color:#fff; border:none; border-radius:6px; font-weight:700;" data-lang="startWaveBtn">Start Next Wave</button>
        </div>
        
      </div>
    </div>

    <script src="Vector2.js"></script>
    <script>
      (function(){
        const DEFAULT_LANG = 'en';
        const LANG_KEY = 'lang';
        const dict = {
          en: {
            close: 'CLOSE',
            inGameMenuTitle: 'PAUSE MENU',
            settingsTitle: 'Settings',
            appearance: 'Appearance',
            sound: 'Sound',
            music: 'Music',
            volume: 'Volume',
            language: 'Language',
            credits: 'Credits',
            creditsText: 'Thanks to the Elementist developer team and contributors.',
            fpsInfo: 'FPS Info',
            weaponSelectTitle: ' Choose Your Weapon',
            weaponSelectDesc: 'Before Wave 4 starts, pick a weapon.',
            weapon_turrets_name: 'Turrets',
            weapon_turrets_desc: 'Two turrets orbit near you and fire automatically. Medium range, balanced damage.',
            weapon_electro_name: 'Electro Shock Generator',
            weapon_electro_desc: 'Two electric orbs rotate around you. Every 1.5s, chain lightning strikes the nearest target and briefly paralyzes enemies.',
            weapon_gravity_name: 'Gravity Orb',
            weapon_gravity_desc: 'Every 2.6s, creates a pull for 0.65s (240px). Applies small DOT inside the inner ring; then explodes into 6 shards and slows nearby enemies.',
            costLabel: 'Cost:',
            backToMenuBtn: 'Back to Menu',
            resumeBtn: 'Resume',
            tabOffers: 'Rewards',
            tabItems: 'Items',
            tabUpgrades: 'Upgrades',
            tabSpecial: 'Special',
            shopTitle: 'Shop - Intermission',
            wavePrefix: 'Wave',
            weaponUpgrades: 'WEAPON UPGRADES',
            deathHint_tryElement: 'Try a different element next run.',
            deathHint_fire: 'Ate yakn mesafede iyidir.',
            deathHint_lightning: 'Yldrm kritik buildlerle iyi alr.',
            deathHint: 'Bir sonraki kouda farkl element dene.',
            lastRunLabel: 'Son Kou',
            bestRunLabel: 'En yi',
            waveLabel: 'Wave',
            killsLabel: 'Kills',
            onboarding1: 'Your character moves automatically on mobile. You control dodging and positioning.',
            onboarding2: 'Enemies come in waves. Survive each wave to unlock upgrades.',
            onboarding3: 'Elements change how your build plays. Experiment  no run is the same.',
            lockLabel: 'Lock',
            unlockLabel: 'Unlock'
          },
          tr: {
            close: 'KAPAT',
            inGameMenuTitle: 'OYUN MENS',
            settingsTitle: 'Ayarlar',
            appearance: 'Grnm',
            sound: 'Ses',
            music: 'Mzik',
            volume: 'Ses Seviyesi',
            language: 'Dil',
            credits: 'Emei Geenler',
            creditsText: 'Elementist gelitirici ekibi ve katkda bulunanlara teekkrler.',
            weaponSelectTitle: ' Silahn Se',
            weaponSelectDesc: 'Wave 4 balamadan nce bir silah semelisin.',
            weapon_turrets_name: 'Taretler',
            weapon_turrets_desc: 'Oyuncunun yannda iki taret dolar ve otomatik ate eder. Orta menzil, dengeli hasar.',
            weapon_electro_name: 'Elektro ok Jeneratr',
            weapon_electro_desc: 'Karakterin etrafnda iki elektrik kresi dner. Her 1.5 snde en yakndaki hedefe zincirli yldrm atar, ksa sersemletir.',
            weapon_gravity_name: 'Yerekimi Kresi',
            weapon_gravity_desc: '2.6 snde bir 0.65 sn boyunca ekim (240px).  halkada kk DOT uygular; bitite patlayp 6 para en yakn dmanlara frlar ve yavalatr.',
            costLabel: 'Maliyet:',
            backToMenuBtn: 'MENYE DN',
            resumeBtn: 'OYUNA DN',
            tabOffers: 'dller',
            tabItems: 'Eyalar',
            tabUpgrades: 'Ykseltmeler',
            tabSpecial: 'zel',
            shopTitle: 'Dkkan - Ara',
            wavePrefix: 'Dalga',
            weaponUpgrades: 'SLAH YKSELTMELER',
            deathHint_tryElement: 'Sonraki rund farkl element dene.',
            deathHint_fire: 'Feuer ist im Nahkampf stark.',
            deathHint_lightning: 'Blitz funktioniert gut mit kritischen Builds.',
            deathHint: 'Versuche ein anderes Element im nchsten Lauf.',
            lastRunLabel: 'Letzter Lauf',
            bestRunLabel: 'Bester Lauf',
            waveLabel: 'Welle',
            killsLabel: 'Kills',
            onboarding1: 'Karakterin mobilde otomatik hareket eder. Sen dash ve konumlanmay kontrol edersin.',
            onboarding2: 'Dmanlar dalgalar halinde gelir. Her dalgadan sonra ykseltme se.',
            onboarding3: 'Elementler buildini deitirir. Dene  her run farkldr.',
            lockLabel: 'Kilit',
            unlockLabel: 'Kilidi A'
          }
        };

        function normalizeLang(l){ return (l === 'tr') ? 'tr' : 'en'; }

        function getLang(){
          try{
            const saved = localStorage.getItem(LANG_KEY);
            if(saved) return saved;
          }catch(_){ }
          return DEFAULT_LANG;
        }

        function setLang(lang){
          const l = lang || DEFAULT_LANG;
          try{ localStorage.setItem(LANG_KEY, l); }catch(_){ }
          try{ document.documentElement.setAttribute('lang', l); }catch(_){ }
          applyLang(l);
        }

        function t(key, fallback){
          const lang = normalizeLang(getLang());
          const table = dict[lang] || dict[DEFAULT_LANG] || {};
          if(key && Object.prototype.hasOwnProperty.call(table, key)) return table[key];
          const base = dict[DEFAULT_LANG] || {};
          if(key && Object.prototype.hasOwnProperty.call(base, key)) return base[key];
          // If caller passed null explicitly, treat as "no translation" and return null
          if (fallback === null) return null;
          return fallback != null ? fallback : key;
        }

        function applyLang(lang){
          try{
            const norm = normalizeLang(lang);
            const table = dict[norm] || dict[DEFAULT_LANG] || {};
            document.querySelectorAll('[data-lang]').forEach(el=>{
              const key = el.getAttribute('data-lang');
              const val = t(key, el.textContent);
              if(typeof val === 'string') el.textContent = val;
            });
            // Some buttons get their labels overwritten by core game scripts at runtime (esp. mobile).
            // Re-assert critical labels explicitly.
            try{
              const hub = document.getElementById('backToHubBtn');
              if(hub) hub.textContent = t('backToMenuBtn', hub.textContent);
            }catch(_){ }
            // Also normalize dynamic weapon overlay cards that may be injected with hardcoded strings
            scheduleWeaponOverlayNormalize();
          }catch(_){ }
        }

        let __weaponNormalizeScheduled = false;
        let __weaponNormalizeRunning = false;
        function scheduleWeaponOverlayNormalize(){
          if(__weaponNormalizeScheduled) return;
          __weaponNormalizeScheduled = true;
          requestAnimationFrame(()=>{
            __weaponNormalizeScheduled = false;
            if(__weaponNormalizeRunning) return;
            __weaponNormalizeRunning = true;
            try{ applyWeaponOverlayText(); }catch(_){ }
            __weaponNormalizeRunning = false;
          });
        }

        function applyWeaponOverlayText(){
          try{
            const wrap = document.getElementById('weaponOverlay');
            const items = document.getElementById('weaponItems');
            if(!wrap || !items) return;
            const visible = window.getComputedStyle(wrap).display !== 'none';
            if(!visible) return;

            const lang = normalizeLang(getLang());
            // Only rewrite TEXT nodes so we don't destroy icons/emojis/spans inside cards
            const walker = document.createTreeWalker(items, NodeFilter.SHOW_TEXT, null);
            const textNodes = [];
            while(walker.nextNode()) textNodes.push(walker.currentNode);

            function replacePrefix(s, fromRe, to){
              if(!fromRe.test(s)) return s;
              return s.replace(fromRe, to);
            }

            // Translate known weapon titles/descriptions if they are hardcoded
            const mappings = [
              {
                trName: 'Taretler',
                enName: t('weapon_turrets_name','Turrets'),
                trDescPrefix: 'Oyuncunun yannda iki taret',
                enDesc: t('weapon_turrets_desc',''),
                trDesc: t('weapon_turrets_desc','')
              },
              {
                trName: 'Elektro ok Jeneratr',
                enName: t('weapon_electro_name','Electro Shock Generator'),
                trDescPrefix: 'Karakterin etrafnda iki elektrik',
                enDesc: t('weapon_electro_desc',''),
                trDesc: t('weapon_electro_desc','')
              },
              {
                trName: 'Yerekimi Kresi',
                enName: t('weapon_gravity_name','Gravity Orb'),
                trDescPrefix: '2.6 sn',
                enDesc: t('weapon_gravity_desc',''),
                trDesc: t('weapon_gravity_desc','')
              }
            ];

            textNodes.forEach(n=>{
              const raw = n.nodeValue || '';
              const trimmed = raw.trim();
              if(!trimmed) return;

              // Cost label
              if(lang === 'tr'){
                n.nodeValue = replacePrefix(raw, /^\s*Cost\s*:/i, 'Maliyet:');
              } else {
                n.nodeValue = replacePrefix(raw, /^\s*Maliyet\s*:/i, 'Cost:');
              }

              // Weapon title/desc replacements
              mappings.forEach(m=>{
                if(lang === 'tr'){
                  if(raw.includes(m.enName)) n.nodeValue = raw.replace(m.enName, m.trName);
                  if(m.enDesc && trimmed === m.enDesc) n.nodeValue = m.trDesc;
                } else {
                  if(raw.includes(m.trName)) n.nodeValue = raw.replace(m.trName, m.enName);
                  if(m.trDescPrefix && trimmed.includes(m.trDescPrefix) && m.enDesc) n.nodeValue = m.enDesc;
                }
              });
            });
          }catch(_){ }
        }

        // Expose translation to other inline scripts
        window.__i18n = { t, setLang, getLang, applyLang };

        // Init and bind language dropdown
        document.addEventListener('DOMContentLoaded', function(){
          const sel = document.getElementById('languageSelect');
          const cur = getLang();
          if(sel){
            try{ sel.value = cur; }catch(_){ }
            sel.addEventListener('change', function(){ setLang(sel.value); });
          }
          setLang(cur);
        });

        // Keep "Back to Menu" button label consistent even if core scripts overwrite it.
        document.addEventListener('DOMContentLoaded', function(){
          try{
            const hub = document.getElementById('backToHubBtn');
            if(!hub) return;
            const apply = ()=>{
              try{
                const desired = t('backToMenuBtn', hub.textContent);
                if(typeof desired === 'string' && desired && hub.textContent !== desired) hub.textContent = desired;
              }catch(_){ }
            };
            apply();
            const mo = new MutationObserver(function(){ apply(); });
            mo.observe(hub, { childList:true, subtree:true });
          }catch(_){ }
        });

        // Watch weapon overlay for dynamic content injection and re-apply language
        document.addEventListener('DOMContentLoaded', function(){
          try{
            const wrap = document.getElementById('weaponOverlay');
            const items = document.getElementById('weaponItems');
            if(!wrap || !items) return;
            const obs = new MutationObserver(function(){ scheduleWeaponOverlayNormalize(); });
            // Avoid characterData observation: too chatty and can freeze on Wave transitions.
            obs.observe(items, { childList: true, subtree: true });
            obs.observe(wrap, { attributes: true, attributeFilter: ['style','class'] });
          }catch(_){ }
        });

        // Onboarding (wave-start tips) - once per run
        document.addEventListener('DOMContentLoaded', function(){
          const runKey = 'elementist_run_id_v1';
          const shownKey = 'elementist_onboarding_shown_run_v1';
          const isTouch = document.body.classList.contains('touch') || (window.matchMedia && window.matchMedia('(hover: none) and (pointer: coarse)').matches);
          const getRunId = ()=>{
            try{ return parseInt(sessionStorage.getItem(runKey) || '0', 10) || 0; }catch(_){ return 0; }
          };
          const wasShownThisRun = ()=>{
            try{ return String(sessionStorage.getItem(shownKey) || '') === String(getRunId()); }catch(_){ return false; }
          };
          let box = document.getElementById('onboardingHints');
          if(!box){
            box = document.createElement('div');
            box.id = 'onboardingHints';
            box.className = 'onboarding-hints';
            box.style.position = 'fixed';
            box.style.left = '50%';
            box.style.top = isTouch ? '54px' : '76px';
            box.style.transform = 'translateX(-50%)';
            box.style.zIndex = '2147483600';
            box.style.maxWidth = 'min(720px, 92vw)';
            box.style.padding = '10px 12px';
            box.style.borderRadius = '12px';
            box.style.border = '1px solid rgba(56,189,248,0.45)';
            box.style.background = 'rgba(2,6,23,0.72)';
            box.style.backdropFilter = 'blur(6px)';
            box.style.color = '#e2e8f0';
            box.style.fontSize = isTouch ? '13px' : '15px';
            box.style.fontWeight = '800';
            box.style.lineHeight = '1.35';
            box.style.boxShadow = '0 0 18px rgba(0,255,255,0.18)';
            box.style.opacity = '0';
            box.style.transition = 'opacity 320ms ease';
            box.style.pointerEvents = 'none';
            try{
              if(!document.getElementById('onboardingHintsStyle')){
                const st = document.createElement('style');
                st.id = 'onboardingHintsStyle';
                st.textContent = `
                  @keyframes onboardingHintSheen {
                    0% { box-shadow: 0 0 18px rgba(0,255,255,0.14), 0 0 0 1px rgba(56,189,248,0.18) inset; border-color: rgba(56,189,248,0.38); }
                    50% { box-shadow: 0 0 28px rgba(0,255,255,0.22), 0 0 16px rgba(255,0,255,0.10), 0 0 0 1px rgba(255,0,255,0.12) inset; border-color: rgba(255,0,255,0.30); }
                    100% { box-shadow: 0 0 18px rgba(0,255,255,0.14), 0 0 0 1px rgba(56,189,248,0.18) inset; border-color: rgba(56,189,248,0.38); }
                  }
                  .onboarding-hints { animation: onboardingHintSheen 2.8s ease-in-out infinite; }
                `;
                document.head.appendChild(st);
              }
            }catch(_){ }
            document.body.appendChild(box);
          }

          const msgs = ['onboarding1','onboarding2','onboarding3'];
          let i = 0;
          function showNext(){
            if(i >= msgs.length){
              box.style.opacity = '0';
              setTimeout(()=>{ try{ box.remove(); }catch(_){ } }, 450);
              try{ sessionStorage.setItem(shownKey, String(getRunId())); }catch(_){ }
              return;
            }
            box.textContent = t(msgs[i], '');
            box.style.opacity = '1';
            const visibleMs = (i===0) ? 5200 : 4300;
            setTimeout(()=>{ box.style.opacity = '0'; }, visibleMs);
            setTimeout(()=>{ i++; showNext(); }, visibleMs + 700);
          }

          // Start after the first time the shop has been opened, and the player presses Start Next Wave.
          let shopOpenedOnce = false;
          try{
            const shop = document.getElementById('shopOverlay');
            if(shop){
              const isShopOpen = ()=>{
                try{
                  if(document.body && document.body.classList.contains('shop-open')) return true;
                  return window.getComputedStyle(shop).display !== 'none';
                }catch(_){ return false; }
              };
              const moShop = new MutationObserver(function(){
                try{ if(isShopOpen()) shopOpenedOnce = true; }catch(_){ }
              });
              moShop.observe(document.body, { attributes:true, attributeFilter:['class'] });
              moShop.observe(shop, { attributes:true, attributeFilter:['style','class'] });
            }
          }catch(_){ }

          const startWaveBtn = document.getElementById('startWaveBtn');
          if(startWaveBtn){
            const handler = function(){
              try{
                if(wasShownThisRun()) return;
                if(!shopOpenedOnce) return;
                startWaveBtn.removeEventListener('click', handler);
                setTimeout(showNext, 550);
              }catch(_){ }
            };
            startWaveBtn.addEventListener('click', handler, true);
          }
        });

        // Tutorial overlay (4 slides) - show once per run
        document.addEventListener('DOMContentLoaded', function(){
          const runKey = 'elementist_run_id_v1';
          const shownKey = 'elementist_tutorial_shown_run_v1';
          let runId = 0;
          try{ runId = parseInt(sessionStorage.getItem(runKey) || '0', 10) || 0; }catch(_){ runId = 0; }

          const isTouch = (document.body && document.body.classList.contains('touch')) || (window.matchMedia && window.matchMedia('(hover: none) and (pointer: coarse)').matches);
          const slides = isTouch ? [
            'Use the on-screen joystick to move (auto-movement active).',
            'Tap the Dodge button to dash  hold for a longer dash!',
            'Collect drops, then shop during intermission to upgrade.',
            'Survive waves and keep upgrading between rounds.'
          ] : [
            'WASD or Arrows to move (auto-movement active).',
            'Space to dodge (choose direction freely)  hold for dash!',
            'Shift for ability, collect drops to upgrade.',
            'Survive waves, shop in intermission.'
          ];
          let idx = 0;

          function build(){
            const overlay = document.createElement('div');
            overlay.id = 'tutorialOverlay';
            overlay.style.position = 'fixed';
            overlay.style.inset = '0';
            overlay.style.display = 'none';
            overlay.style.alignItems = 'center';
            overlay.style.justifyContent = 'center';
            overlay.style.background = 'rgba(0,0,0,0.72)';
            overlay.style.backdropFilter = 'blur(3px)';
            overlay.style.zIndex = '2147483602';

            const card = document.createElement('div');
            card.style.width = 'min(560px, 92vw)';
            card.style.background = 'rgba(2,6,23,0.92)';
            card.style.border = '2px solid rgba(56,189,248,0.65)';
            card.style.borderRadius = '16px';
            card.style.boxShadow = '0 0 28px rgba(0,255,255,0.22)';
            card.style.padding = '16px 16px 12px 16px';
            card.style.color = '#e5e7eb';

            const title = document.createElement('div');
            title.style.fontWeight = '800';
            title.style.color = '#7dd3fc';
            title.style.marginBottom = '8px';
            title.textContent = 'Quick Tutorial';

            const body = document.createElement('div');
            body.id = 'tutorialBody';
            body.style.fontSize = '14px';
            body.style.lineHeight = '1.45';
            body.style.margin = '6px 0 12px 0';

            const footer = document.createElement('div');
            footer.style.display = 'flex';
            footer.style.gap = '8px';
            footer.style.justifyContent = 'space-between';
            footer.style.alignItems = 'center';

            const left = document.createElement('div');
            left.style.opacity = '0.85';
            left.style.fontSize = '12px';
            left.id = 'tutorialStep';

            const right = document.createElement('div');
            right.style.display = 'flex';
            right.style.gap = '8px';

            const skip = document.createElement('button');
            skip.className = 'menu-btn';
            skip.style.width = 'auto';
            skip.style.padding = '6px 10px';
            skip.style.borderColor = '#ef4444';
            skip.style.color = '#ef4444';
            skip.style.background = 'rgba(127,29,29,0.18)';
            skip.textContent = 'Close';

            const next = document.createElement('button');
            next.className = 'menu-btn';
            next.style.width = 'auto';
            next.style.padding = '6px 10px';
            next.textContent = 'Next';

            const got = document.createElement('button');
            got.className = 'menu-btn';
            got.style.width = 'auto';
            got.style.padding = '6px 10px';
            got.style.borderColor = '#22c55e';
            got.style.color = '#22c55e';
            got.textContent = 'Got it';

            function close(){
              try{ sessionStorage.setItem(shownKey, String(runId)); }catch(_){ }
              try{ overlay.remove(); }catch(_){ }
            }
            function render(){
              const bodyEl = overlay.querySelector('#tutorialBody');
              const stepEl = overlay.querySelector('#tutorialStep');
              if(bodyEl) bodyEl.textContent = slides[idx];
              if(stepEl) stepEl.textContent = `Step ${idx+1} / ${slides.length}`;
              next.style.display = (idx < slides.length - 1) ? 'inline-block' : 'none';
              got.style.display = (idx >= slides.length - 1) ? 'inline-block' : 'none';
            }

            skip.addEventListener('click', close);
            next.addEventListener('click', ()=>{ idx = Math.min(slides.length-1, idx+1); render(); });
            got.addEventListener('click', close);

            // User requested: swap Next and Skip positions
            right.appendChild(next);
            right.appendChild(skip);
            right.appendChild(got);
            footer.appendChild(left);
            footer.appendChild(right);
            card.appendChild(title);
            card.appendChild(body);
            card.appendChild(footer);
            overlay.appendChild(card);
            document.body.appendChild(overlay);
            render();
            return overlay;
          }

          const overlay = build();

          function show(){
            try{ overlay.style.display = 'flex'; }catch(_){ }
          }

          function wasShownThisRun(){
            try{ return String(sessionStorage.getItem(shownKey) || '') === String(runId); }catch(_){ return false; }
          }

          // Increment runId on new game start so tutorial shows every new run
          function bumpRun(){
            try{
              runId = (runId|0) + 1;
              sessionStorage.setItem(runKey, String(runId));
            }catch(_){ }
          }
          try{
            const sb = document.getElementById('startBtn');
            if(sb) sb.addEventListener('click', bumpRun, { capture:true });
          }catch(_){ }
          try{
            const rb = document.getElementById('restartBtn');
            if(rb) rb.addEventListener('click', bumpRun, { capture:true });
          }catch(_){ }

          // Show only after cutscene, when the shop first opens.
          // This prevents showing during element selection or other pre-run overlays.
          try{
            const shop = document.getElementById('shopOverlay');
            if(!shop) return;
            const isShopVisible = ()=>{
              try{ return window.getComputedStyle(shop).display !== 'none'; }catch(_){ return false; }
            };
            const isShopOpen = ()=>{
              try{ return document.body && document.body.classList.contains('shop-open'); }catch(_){ return false; }
            };
            const tryShow = ()=>{
              try{
                if(wasShownThisRun()) return true;
                if(isShopOpen() || isShopVisible()){
                  setTimeout(show, 180);
                  return true;
                }
              }catch(_){ }
              return false;
            };
            if(tryShow()) return;
            const mo = new MutationObserver(function(){
              try{
                if(!tryShow()) return;
                mo.disconnect();
              }catch(_){ }
            });
            mo.observe(document.body, { attributes:true, attributeFilter:['class'] });
            mo.observe(shop, { attributes:true, attributeFilter:['style','class'] });
          }catch(_){ }
        });

        // Death screen retention hint (set a contextual line when game over becomes visible)
        document.addEventListener('DOMContentLoaded', function(){
          const screen = document.getElementById('gameOverScreen');
          const hintEl = document.getElementById('deathHint');
          if(!screen || !hintEl) return;
          const hints = ['deathHint_tryElement','deathHint_fire','deathHint_lightning'];
          const obs = new MutationObserver(function(){
            try{
              const visible = window.getComputedStyle(screen).display !== 'none';
              if(!visible) return;
              const pick = hints[Math.floor(Math.random()*hints.length)];
              hintEl.textContent = t(pick, t('deathHint',''));
            }catch(_){ }
          });
          try{ obs.observe(screen, { attributes: true, attributeFilter: ['style','class'] }); }catch(_){ }
        });

        // Cutscene warm-up: keep it non-invasive to avoid breaking video loads.
        // Only hint preload early; never force play/pause or mute.
        document.addEventListener('DOMContentLoaded', function(){
          const v = document.getElementById('cutsceneVideo');
          if(!v) return;
          let primed = false;
          function prime(){
            if(primed) return;
            primed = true;
            try{
              v.preload = 'auto';
              // Only call load() if a source is already set; otherwise let game code set src first.
              const hasSrc = !!(v.currentSrc || v.getAttribute('src'));
              if(hasSrc && typeof v.load === 'function') v.load();
            }catch(_){ }
          }
          window.addEventListener('pointerdown', prime, { once: true, passive: true });
          window.addEventListener('touchstart', prime, { once: true, passive: true });
        });

        // Cutscene UX: on mobile, show a short loading overlay and trigger playback ASAP.
        document.addEventListener('DOMContentLoaded', function(){
          const overlay = document.getElementById('cutsceneOverlay');
          const holder = document.getElementById('cutsceneHolder');
          const v = document.getElementById('cutsceneVideo');
          if(!overlay || !holder || !v) return;

          const isMobile = (window.matchMedia && window.matchMedia('(hover: none) and (pointer: coarse)').matches);
          let loadingEl = null;

          function ensureLoading(){
            if(loadingEl) return loadingEl;
            const d = document.createElement('div');
            d.style.position = 'absolute';
            d.style.inset = '0';
            d.style.display = 'flex';
            d.style.alignItems = 'center';
            d.style.justifyContent = 'center';
            d.style.background = '#000';
            d.style.color = '#7dd3fc';
            d.style.fontWeight = '800';
            d.style.letterSpacing = '0.5px';
            d.style.fontSize = '14px';
            d.style.textShadow = '0 0 18px rgba(0,255,255,0.35)';
            d.textContent = 'Loading...';
            holder.appendChild(d);
            loadingEl = d;
            return d;
          }

          function showLoading(){ try{ ensureLoading().style.display = 'flex'; }catch(_){ } }
          function hideLoading(){ try{ if(loadingEl) loadingEl.style.display = 'none'; }catch(_){ } }

          // Hide loader as soon as we have frames
          v.addEventListener('loadeddata', hideLoading, { passive:true });
          v.addEventListener('canplay', hideLoading, { passive:true });
          v.addEventListener('playing', hideLoading, { passive:true });
          v.addEventListener('error', ()=>{ try{ if(loadingEl) loadingEl.textContent = 'Failed to load'; }catch(_){ } }, { passive:true });

          // When overlay is shown, render loader immediately and try to start decode/play.
          const obs = new MutationObserver(function(){
            try{
              const visible = window.getComputedStyle(overlay).display !== 'none';
              if(!visible) return;
              showLoading();
              if(isMobile){
                // On mobile, autoplay often requires muted. Try muted start, then unmute best-effort.
                const hasSrc = !!(v.currentSrc || v.getAttribute('src'));
                if(hasSrc){
                  v.preload = 'auto';
                  v.muted = true;
                  const p = v.play && v.play();
                  if(p && typeof p.then === 'function'){
                    p.then(()=>{ setTimeout(()=>{ try{ v.muted = false; }catch(_){ } }, 350); }).catch(()=>{});
                  }
                }
              }
            }catch(_){ }
          });
          try{ obs.observe(overlay, { attributes:true, attributeFilter:['style','class'] }); }catch(_){ }
        });
      })();
    </script>
    <script src="glowlings.js"></script>
    <!-- Enhanced hooks after core game -->
    <script src="glowlings-enhanced.js"></script>
    <script>
      (function(){
        const bar = document.getElementById('consumableBar');
        const shop = document.getElementById('shopOverlay');
        const startWaveBtn = document.getElementById('startWaveBtn');
        const closeGameBtn = document.getElementById('closeGameBtn');
        const backToMenuBtn = document.getElementById('backToMenuBtn');
        const backToMenuIngameBtn = document.getElementById('backToMenuIngameBtn');
        const restartBtn = document.getElementById('restartBtn');

        function goBackToMenu(){
          try{ document.body.classList.remove('playing','menu-open','shop-open'); }catch(_){ }
          try{ const el=['shopOverlay','inGameMenu','gameOverScreen','elementSelectOverlay','touchControls','startScreen']; el.forEach(id=>{ const n=document.getElementById(id); if(n) n.style.display='none'; }); }catch(_){ }
          try{ const bgm = document.getElementById('bgm'); if(bgm){ bgm.pause(); bgm.currentTime = 0; } }catch(_){ }
          try{ if(window.__noStartGuard){ clearInterval(window.__noStartGuard); window.__noStartGuard = null; } }catch(_){ }
          try{
            const g = window.game;
            if(g){
              try{ g.paused = true; }catch(_){ }
              try{ g.gameState = 'menu'; }catch(_){ }
              try{ if(typeof g.stop==='function') g.stop(); }catch(_){ }
              try{ if(typeof g.destroy==='function') g.destroy(); }catch(_){ }
              try{ if(typeof g.cleanup==='function') g.cleanup(); }catch(_){ }
              try{ if(typeof g.dispose==='function') g.dispose(); }catch(_){ }
              try{ if(typeof g.endGame==='function') g.endGame(); }catch(_){ }
              try{ if(g.__raf) cancelAnimationFrame(g.__raf); }catch(_){ }
              try{ if(g.rafId) cancelAnimationFrame(g.rafId); }catch(_){ }
              try{ if(g.frameId) cancelAnimationFrame(g.frameId); }catch(_){ }
            }
          }catch(_){ }
          try{ window.onbeforeunload = null; }catch(_){ }
          try{ window.location.href = 'index.html'; }catch(_){ try{ location.assign('index.html'); }catch(__){} }
        }
        if(backToMenuBtn && !backToMenuBtn.__bound){ backToMenuBtn.addEventListener('click', function(e){ try{ e.preventDefault(); }catch(_){ } goBackToMenu(); }, true); backToMenuBtn.__bound = true; }
        if(backToMenuIngameBtn && !backToMenuIngameBtn.__bound){ backToMenuIngameBtn.addEventListener('click', function(e){ try{ e.preventDefault(); }catch(_){ } goBackToMenu(); }, true); backToMenuIngameBtn.__bound = true; }
        if(restartBtn && !restartBtn.__bound){
          restartBtn.addEventListener('click', function(e){
            try{ e.preventDefault(); }catch(_){ }
            try{
              const g = window.game;
              if(g && typeof g.restartRun==='function'){
                g.restartRun();
              } else {
                // Fallback: just hide game over and set playing class
                document.getElementById('gameOverScreen')?.style && (document.getElementById('gameOverScreen').style.display='none');
                document.body.classList.add('playing');
                document.body.classList.remove('shop-open','menu-open');
              }
            }catch(_){ }
          }, true);
          restartBtn.__bound = true;
        }

        // How To Play overlay open/close (main menu + in-game pause menu)
        (function(){
          try{
            const howToOverlay = document.getElementById('howToOverlay');
            const howToBtn = document.getElementById('howToBtn');
            const howToIngameBtn = document.getElementById('howToIngameBtn');
            const howToCloseBtn = document.getElementById('howToCloseBtn');
            if(!howToOverlay) return;
            const open = ()=>{ try{ howToOverlay.style.display = 'block'; }catch(_){ } };
            const close = ()=>{ try{ howToOverlay.style.display = 'none'; }catch(_){ } };

            if(howToBtn && !howToBtn.__bound){
              howToBtn.addEventListener('click', function(e){ try{ e.preventDefault(); }catch(_){ } open(); }, true);
              howToBtn.__bound = true;
            }
            if(howToIngameBtn && !howToIngameBtn.__bound){
              howToIngameBtn.addEventListener('click', function(e){ try{ e.preventDefault(); }catch(_){ } open(); }, true);
              howToIngameBtn.__bound = true;
            }
            if(howToCloseBtn && !howToCloseBtn.__bound){
              howToCloseBtn.addEventListener('click', function(e){ try{ e.preventDefault(); }catch(_){ } close(); }, true);
              howToCloseBtn.__bound = true;
            }
            // Close on backdrop click
            if(!howToOverlay.__bound){
              howToOverlay.addEventListener('click', function(e){
                try{ if(e.target === howToOverlay) close(); }catch(_){ }
              }, true);
              howToOverlay.__bound = true;
            }
          }catch(_){ }
        })();

        const makeSlot = (i) => ({
          idx: i,
          root: document.getElementById('consumSlot'+i),
          icon: document.getElementById('consum'+i+'Icon'),
          timer: document.getElementById('consum'+i+'Timer'),
          count: document.getElementById('consum'+i+'Count'),
          cooldownId: null,
          cooldownUntil: 0,
        });
        const slots = [1,2,3,4,5].map(makeSlot);

        function setCount(i, n){
          const s = slots[i-1]; if(!s) return;
          if(n && n > 1){ s.count.style.display = 'flex'; s.count.textContent = String(n); }
          else if(n === 1){ s.count.style.display = 'none'; s.count.textContent = '1'; }
          else { s.count.style.display = 'none'; s.count.textContent = '1'; }
        }
        function setIcon(i, html){ const s = slots[i-1]; if(!s) return; s.icon.innerHTML = html || ''; }
        function clearSlot(i){
          const s = slots[i-1]; if(!s) return;
          if(s.cooldownId){ clearInterval(s.cooldownId); s.cooldownId = null; }
          s.cooldownUntil = 0; s.timer.textContent = '';
          s.root.classList.remove('cooldown');
          setIcon(i, '');
          setCount(i, 1);
        }
        // Clear inventory and shop UI when the game restarts
        window.addEventListener('inventory:reset', () => {
          try {
            if (window.localState) {
              window.localState.inv = [null, null, null, null, null];
              // Reset simple shop-local mirrors so purchased things don't persist
              window.localState.offers = [];
              window.localState.offersClaimedThisRound = 0;
            }
            [1,2,3,4,5].forEach(clearSlot);
            if (typeof updateBar === 'function') updateBar();
            const list = document.getElementById('shopItems'); if (list) list.innerHTML = '';
            const stats = document.getElementById('activeBuffsList'); if (stats) stats.innerHTML = '';
          } catch(_) {}
        });
        function startCooldown(i, seconds){
          const s = slots[i-1]; if(!s) return;
          if(s.cooldownId){ clearInterval(s.cooldownId); s.cooldownId = null; }
          const now = Date.now(); s.cooldownUntil = now + Math.max(0, seconds)*1000;
          s.root.classList.add('cooldown');
          const tick = () => {
            const remainMs = s.cooldownUntil - Date.now();
            if(remainMs <= 0){
              s.timer.textContent = '';
              s.root.classList.remove('cooldown');
              clearInterval(s.cooldownId); s.cooldownId = null;
              try{
                const ev = new CustomEvent('consumable:cooldownEnd', { detail: { slot: i } });
                window.dispatchEvent(ev);
              }catch(_){ }
              return;
            }
            const remain = Math.ceil(remainMs/1000);
            s.timer.textContent = String(remain);
          };
          tick();
          s.cooldownId = setInterval(tick, 200);
        }
        function activateSlot(i){
          // Publish intent with slot and current item id (if any)
          let itemId = null;
          try { itemId = (window.localState?.inv?.[(i|0)-1]||{}).id || null; } catch(_){ }
          const ev = new CustomEvent('consumable:activate', { detail: { slot: i, id: itemId } });
          window.dispatchEvent(ev);
        }

        // Expose small UI API
        window.consumBar = { setCount, setIcon, clearSlot, startCooldown, activateSlot, slots };

        // Key handlers (only while playing)
        window.addEventListener('keydown', (e) => {
          if(!document.body.classList.contains('playing')) return;
          const map = { '1':1, '2':2, '3':3, '4':4, '5':5 };
          const idx = map[e.key];
          if(idx){
            e.preventDefault();
            window.consumBar?.activateSlot(idx);
          }
        }, {passive:false});
        // Click/touch on slots
        slots.forEach((s, k) => {
          if(!s.root) return;
          s.root.addEventListener('click', () => {
            if(!document.body.classList.contains('playing')) return;
            activateSlot(k+1);
          }, { passive: true });
        });

        // Manage playing state based on shop and start wave actions
        function setPlaying(on){
          if(on){ document.body.classList.add('playing'); }
          else { document.body.classList.remove('playing'); }
        }
        // Ensure not playing on load (start menu/shop)
        setPlaying(false);
        // Start wave button => hide shop, enter playing
        if(startWaveBtn){
          startWaveBtn.addEventListener('click', () => {
            if(shop) shop.style.display = 'none';
            setPlaying(true);
          });
        }
        // Close game from main menu
        if (closeGameBtn) {
          closeGameBtn.addEventListener('click', () => {
            try { window.open('', '_self'); } catch(_) {}
            try { window.close(); } catch(_) {}
            try { location.href = 'about:blank'; } catch(_) {}
          });
        }
        // Observe shop visibility changes and turn off playing when shop opens
        if(shop){
          const syncFromShop = () => {
            const visible = window.getComputedStyle(shop).display !== 'none';
            if(visible){
              setPlaying(false);
              document.body.classList.add('shop-open');
              if(bar) bar.classList.add('attached-to-shop');
              // Ensure default tab is Items and render content when shop opens
              try {
                if(window.shopUI && typeof window.shopUI.setTab === 'function'){
                  window.shopUI.setTab('items');
                } else {
                  if(window.localState){ window.localState.tab = 'items'; }
                  if(typeof window.render === 'function'){ window.render(); }
                }
              } catch(_) {}

              // Mobile: ensure the shop opens at the TOP (avoid starting scrolled to bottom)
              try{
                const isTouch = (document.body && document.body.classList.contains('touch')) || (window.matchMedia && window.matchMedia('(hover: none) and (pointer: coarse)').matches);
                if(isTouch){
                  const resetScroll = ()=>{
                    try{ shop.scrollTop = 0; }catch(_){ }
                    try{
                      const box = shop.querySelector('.shop-box') || shop.querySelector('div');
                      if(box){
                        try{ box.scrollTop = 0; }catch(_){ }
                      }
                    }catch(_){ }
                  };
                  // Run a couple times to beat layout/paint timing
                  resetScroll();
                  try{ requestAnimationFrame(resetScroll); }catch(_){ setTimeout(resetScroll, 0); }
                  setTimeout(resetScroll, 80);
                  setTimeout(resetScroll, 220);
                }
              }catch(_){ }

              // Place the consumable bar just under the shop box
              positionBarUnderShop();
            } else {
              document.body.classList.remove('shop-open');
              // Restore bar to bottom when leaving shop
              if(bar){
                bar.style.top='';
                bar.style.bottom='18px';
                bar.style.left='50%';
                bar.style.transform='translateX(-50%)';
                bar.style.maxWidth='';
                bar.style.width='';
                bar.style.minWidth='';
                bar.style.maxWidth='';
                bar.classList.remove('attached-to-shop');
                // Reset width lock for next time
                try { bar.__widthLocked = false; bar.__widthBasis = undefined; } catch(_){}
              }
            }
          };
          const mo = new MutationObserver(syncFromShop);
          mo.observe(shop, { attributes:true, attributeFilter:['style','class'] });
          syncFromShop();
          // Observe size changes of the shop box to keep bar attached
          try {
            const box = document.querySelector('.shop-box');
            if(box && 'ResizeObserver' in window){
              const ro = new ResizeObserver(()=>{ if(document.body.classList.contains('shop-open')) positionBarUnderShop(); });
              ro.observe(box);
            }
          } catch(_){ }
        }
        function positionBarUnderShop(){
          try{
            const box = document.querySelector('.shop-box');
            if(!box || !bar) return;
            const r = box.getBoundingClientRect();
            // Add a clear gap below the shop box so the bar sits inside the background area
            const gap = 22; // px space between shop and bar
            const top = Math.round(r.bottom + gap);
            bar.style.top = top + 'px';
            bar.style.bottom = 'auto';
            // Center under shop using CSS centering (no pixel left to avoid jitter)
            bar.style.left = '50%';
            // Keep stylesheet transform for centering/scale
            bar.style.transform = 'translateX(-50%)';
            // Lock width to a stable, formula-based value: slots + gaps + paddings (border-box)
            const viewportW = window.innerWidth || document.documentElement.clientWidth || screen.width;
            const needRecalc = (!bar.__widthLocked || Math.abs((bar.__widthBasis||viewportW) - viewportW) > 24);
            if (needRecalc) {
              const cs = window.getComputedStyle(bar);
              const padL = parseFloat(cs.paddingLeft) || 0;
              const padR = parseFloat(cs.paddingRight) || 0;
              const gap = parseFloat(cs.columnGap) || 12;
              const slotsEls = Array.from(bar.querySelectorAll('.consumable-slot'));
              const slotW = (slotsEls[0]?.getBoundingClientRect().width) || 48;
              const n = Math.max(1, slotsEls.length);
              const innerW = (slotW * n) + (gap * Math.max(0, n - 1));
              const targetW = Math.round(innerW + padL + padR);
              const maxPossible = Math.floor(viewportW * 0.96);
              const finalW = Math.min(Math.max(240, targetW), maxPossible);
              // Apply border-box sizing and lock
              bar.style.boxSizing = 'border-box';
              bar.style.width = finalW + 'px';
              bar.style.minWidth = finalW + 'px';
              bar.style.maxWidth = finalW + 'px';
              bar.__widthLocked = true;
              bar.__widthBasis = viewportW;
            }
            // Ensure the bar stays inside viewport vertically (avoid going below the screen)
            const paddingFromBottom = 8; // px
            const maxBottomY = window.innerHeight - paddingFromBottom;
            const rect = bar.getBoundingClientRect();
            if(rect.bottom > maxBottomY){
              const adjustedTop = Math.max(8, maxBottomY - rect.height);
              bar.style.top = Math.round(adjustedTop) + 'px';
            }
            // ensure above overlay
            bar.style.zIndex = '10020';
          }catch(_){ }
        }
        // Reposition only on resize while shop is open (avoid scroll jitter on mobile)
        window.addEventListener('resize', ()=>{
          if(document.body.classList.contains('shop-open')) positionBarUnderShop();
        });
      })();
    </script>
    <script>
      // Shop logic (self-contained, UI-only for now)
      (function(){
        const el = (id)=>document.getElementById(id);
        const shopItemsEl = el('shopItems');
        const tabOffersBtn = el('tabOffersBtn');
        const materialsValue = el('materialsValue');
        const xpValue = el('xpValue');
        const tabItemsBtn = el('tabItemsBtn');
        const tabUpgradesBtn = el('tabUpgradesBtn');
        const tabSpecialBtn = el('tabSpecialBtn');
        // Stats panel elements
        const statEls = {
          DMG: el('statDMG'), ATK: el('statATK'), SPD: el('statSPD'), ARM: el('statARM'),
          DODGE: el('statDODGE'), HP: el('statHP'), REGEN: el('statREGEN'), BURN: el('statBURN'), SLOW: el('statSLOW')
        };
        const lockBtn = el('lockBtn');
        const activeBuffsList = el('activeBuffsList');
        const shopOverlay = el('shopOverlay');
        const isShopVisible = ()=> !!shopOverlay && (window.getComputedStyle(shopOverlay).display !== 'none');

        // Offers helpers
        function getPlayerElement(){
          try{
            const g = (typeof window!=='undefined') ? window.game : null;
            const e = g?.player?.element || document.getElementById('elementType')?.textContent || '';
            const v = String(e||'').trim().toLowerCase();
            if(v==='fire' || v==='water' || v==='air') return v;
          }catch(_){ }
          return 'fire';
        }
        function makeDefaultOffers(){
          // Pick 3 unique random items from the player's element-specific pool (free)
          const elem = getPlayerElement();
          const pool = (C.special||[]).filter(x=> x && x.tag === elem);
          if(!Array.isArray(pool) || pool.length === 0) return [];
          const copy = pool.slice();
          const picks = [];
          while(copy.length > 0 && picks.length < 3){
            const i = Math.floor(Math.random() * copy.length);
            picks.push(copy.splice(i,1)[0]);
          }
          // Make them cost-free in Offers
          return picks.map(p=> ({...p, cost: 0}));
        }

        // Local economy/inventory (can be replaced by game state later)
        let localState = {
          materials: 0, // will be read from HUD dynamically
          xp: 0,
          tab: 'offers',
          // Defer generating offers until after catalog C is initialized
          offers: [],
          offersClaimedThisRound: 0,
          owned: {},
          inv: [null,null,null,null,null], // 5-slot consumable inventory
        };
        // Expose for global handlers (e.g., consumable activation)
        try{ window.localState = localState; }catch(_){ }
        const getMaterials = ()=> {
          const g = (typeof window !== 'undefined') ? window.game : null;
          if(g && typeof g.materials === 'number') return g.materials|0;
          return parseInt(materialsValue?.textContent||'0',10) || 0;
        };
        const setMaterials = (v)=>{
          const val = Math.max(0, v|0);
          const g = (typeof window !== 'undefined') ? window.game : null;
          if(g && typeof g.materials === 'number') g.materials = val;
          if(materialsValue) materialsValue.textContent = String(val);
        };
        function syncHUD(){ if(xpValue) xpValue.textContent = String(localState.xp); }

        // Stats updater (public API + optional polling from window.game.stats)
        function writeStats(s){
          if(!s) return;
          const map = {
            DMG: s.dmg ?? s.DMG, ATK: s.atk ?? s.ATK, SPD: s.spd ?? s.SPD, ARM: s.arm ?? s.ARM,
            DODGE: s.dodge ?? s.DODGE, HP: s.hp ?? s.HP, REGEN: s.regen ?? s.REGEN, BURN: s.burn ?? s.BURN, SLOW: s.slow ?? s.SLOW
          };
          Object.keys(statEls).forEach(k=>{ if(statEls[k]) statEls[k].textContent = (map[k] ?? '-'); });
        }
        // expose API
        window.shopUI = window.shopUI || {};
        window.shopUI.setStats = writeStats;
        // optional polling
        try{
          setInterval(()=>{
            try{
              const shopOpen = document.body.classList.contains('shop-open') || (typeof window !== 'undefined' && (()=>{ try{ const sh=document.getElementById('shopOverlay'); return !!sh && window.getComputedStyle(sh).display !== 'none'; }catch(_){ return false; } })());
              if(!shopOpen) return;
            }catch(_){ }
            const gs = window.game?.stats || window.game?.playerStats || null;
            if(gs) writeStats(gs);
          }, 900);
        }catch(_){ }

        // Catalog
        const C = {
          // Items (Consumables)
          items: [
            { id:'blood_draught', name:'Blood Draught', icon:'', cost:9, rarity:'uncommon', desc:'4s: Convert 40% of damage dealt into HP. After it ends, lose 5% Max HP.', tag:'consum' },
            { id:'flame_syrup', name:'Flame Syrup', icon:'', cost:8, rarity:'uncommon', desc:'3s: Your attacks apply burn; 20% of burn damage converts to HP. -20% move speed.', tag:'consum' },
            { id:'mist_tonic', name:'Mist Tonic', icon:'', cost:10, rarity:'rare', desc:'3s: The next 3 hits are ignored; 30% of prevented damage is converted to HP. Vision -50%.', tag:'consum' },
            { id:'stone_infusion', name:'Stone Infusion', icon:'', cost:8, rarity:'common', desc:'5s: +3 armor. No healing; reflect 30% of damage taken. Move speed reduced.', tag:'consum' },
            { id:'heal_potion', name:'Heal Potion', icon:'', cost:7, rarity:'common', desc:'Instantly heal 25% HP. (CD 12s)', tag:'consum' },
            { id:'buy_hearts', name:'Extra Hearts', icon:'', cost:10, rarity:'common', desc:'Spend all your money (min 10). Your total hearts become 2. (Only available on Waves 4/9/14/19/24/29)', tag:'life' },
          ],
          // Upgrades (Permanent stat trades)
          upgrades: [
            { id:'sharp_crystal', name:'Sharpened Crystal', icon:'', cost:7, rarity:'common', desc:'+3 DMG, -3% move speed', tag:'stat' },
            { id:'light_core', name:'Lightweight Core', icon:'', cost:7, rarity:'common', desc:'+6% move speed, -1 armor', tag:'stat' },
            { id:'iron_husk', name:'Iron Husk', icon:'', cost:8, rarity:'common', desc:'+2 armor, -4% move speed', tag:'stat' },
            { id:'vital_shard', name:'Vital Shard', icon:'', cost:10, rarity:'rare', desc:'+1 max heart; each purchase increases cost by +8', tag:'stat', priceScale:8 },
            // Base weapon upgrades (affect starting weapon stats)
            { id:'base_overclocker', name:'Overclocker', icon:'', cost:13, rarity:'uncommon', desc:'Fire rate +15%', tag:'stat', max:1 },
            { id:'base_reinforced_slugs', name:'Reinforced Slugs', icon:'', cost:13, rarity:'uncommon', desc:'Damage +12%', tag:'stat', max:1 },
            { id:'base_calibrated_sight', name:'Calibrated Sight', icon:'', cost:12, rarity:'uncommon', desc:'Range +10%', tag:'stat', max:1 },
            { id:'base_kinetic_rounds', name:'Kinetic Rounds', icon:'', cost:12, rarity:'uncommon', desc:'Bullet speed +12%', tag:'stat', max:1 },
            { id:'base_quickstep', name:'Quickstep Harness', icon:'', cost:12, rarity:'uncommon', desc:'Move speed +8%', tag:'stat', max:1 },
            // Weapon-specific upgrades (filtered by chosen weapon)
            { id:'wep_turret_damage', name:'Turret Calibration', icon:'', cost:11, rarity:'uncommon', desc:'Turret damage +15%', tag:'weapon', type:'turrets', priceScale:3, max:1 },
            { id:'wep_turret_speed', name:'Auto-loader', icon:'', cost:11, rarity:'uncommon', desc:'Turret fire rate +12%', tag:'weapon', type:'turrets', priceScale:3, max:1 },
            { id:'wep_turret_range', name:'Extended Barrels', icon:'', cost:10, rarity:'uncommon', desc:'Turret range +15%', tag:'weapon', type:'turrets', priceScale:3, max:1 },
            { id:'wep_elec_damage', name:'Overcharge Coils', icon:'', cost:13, rarity:'rare', desc:'Electric damage +15%', tag:'weapon', type:'electro', priceScale:4, max:1 },
            { id:'wep_elec_speed', name:'Pulse Optimizer', icon:'', cost:13, rarity:'rare', desc:'Electric fire rate +12%', tag:'weapon', type:'electro', priceScale:4, max:1 },
            { id:'wep_elec_chain', name:'Extra Node', icon:'', cost:11, rarity:'uncommon', desc:'Chain +1', tag:'weapon', type:'electro', priceScale:3, max:1 },
            { id:'wep_elec_range', name:'Long Arc', icon:'', cost:10, rarity:'uncommon', desc:'Electric range +10%', tag:'weapon', type:'electro', priceScale:3, max:1 },
            { id:'wep_grav_damage', name:'Dense Core', icon:'', cost:13, rarity:'rare', desc:'Gravity core damage +15%', tag:'weapon', type:'gravity', priceScale:4, max:1 },
            { id:'wep_grav_speed', name:'Phase Cycler', icon:'', cost:13, rarity:'rare', desc:'Gravity period -12% (more frequent)', tag:'weapon', type:'gravity', priceScale:4, max:1 },
            { id:'wep_grav_radius', name:'Event Horizon', icon:'', cost:11, rarity:'uncommon', desc:'Gravity radius +12%', tag:'weapon', type:'gravity', priceScale:3, max:1 },
            { id:'wep_grav_shrapnel', name:'Fragment Bloom', icon:'', cost:11, rarity:'uncommon', desc:'Shrapnel +2', tag:'weapon', type:'gravity', priceScale:3, max:1 },
          ],
          // Special (Elemental + Utility/Economy)
          special: [
            // Fire
            { id:'cinder_ring', name:'Cinder Ring', icon:'', cost:9, rarity:'uncommon', desc:'Nearby enemies burn for 0.5 DPS (does not stack).', tag:'fire' },
            { id:'burning_claw', name:'Burning Claw', icon:'', cost:10, rarity:'rare', desc:'+10% crit chance, but crits deal 30% less damage.', tag:'fire' },
            { id:'molten_core', name:'Molten Core', icon:'', cost:11, rarity:'epic', desc:'Burn duration +0.5s, your HP regen -1.', tag:'fire' },
            // Water
            { id:'frozen_veil', name:'Frozen Veil', icon:'', cost:9, rarity:'uncommon', desc:'10% slow aura; you are also 5% slower while inside the aura.', tag:'water' },
            { id:'abyss_pearl', name:'Abyss Pearl', icon:'', cost:10, rarity:'rare', desc:'+1 armor, +5% slow; -5% attack speed.', tag:'water' },
            { id:'tidecaller', name:'Tidecaller', icon:'', cost:9, rarity:'uncommon', desc:'+5 materials after each wave; at wave start you are slower for 2s.', tag:'water' },
            // Air
            { id:'tempest_feather', name:'Tempest Feather', icon:'', cost:9, rarity:'uncommon', desc:'+15% move speed; -10% damage.', tag:'air' },
            { id:'storm_eye', name:'Storm Eye', icon:'', cost:10, rarity:'rare', desc:'+10% attack speed; projectile range -10%.', tag:'air' },
            { id:'cyclone_fragment', name:'Cyclone Fragment', icon:'', cost:10, rarity:'rare', desc:'If you have dash: cooldown -20%; after dashing, -1 armor briefly.', tag:'air' },
            // Utility / Economy
            { id:'amber_coin', name:'Amber Coin', icon:'', cost:9, rarity:'uncommon', desc:'+5 materials at the start of each wave; enemy HP +5%.', tag:'util' },
            { id:'lucky_charm', name:'Lucky Charm', icon:'', cost:8, rarity:'uncommon', desc:'+10% drop chance; -5% damage.', tag:'util' },
            { id:'time_relic', name:'Time Relic', icon:'', cost:11, rarity:'rare', desc:'Wave duration -5s; reward +10 materials.', tag:'util' },
          ],
        };

        function rarityClass(r){
          return 'rarity-'+(r||'common');
        }
        // Simple translation helper
        // For non-TR languages, avoid game.t() to prevent Turkish text bleed.
        function T(key, fallback){
          try{
            const sel = (window.__i18n && typeof window.__i18n.getLang === 'function') ? window.__i18n.getLang() : (localStorage.getItem('lang') || 'en');
            const norm = (sel === 'tr') ? 'tr' : 'en';
            const it = window.__i18n && typeof window.__i18n.t === 'function' ? window.__i18n.t : null;
            if(it){
              const v = it(key, null);
              // Do NOT accept raw keys as "translations"; fallback to provided text.
              if(v != null && v !== key && !/^shop_item_/.test(v) && v !== 'costLabel') return v;
            }
            if(norm === 'tr'){
              const g = (typeof window!=='undefined') ? window.game : null;
              if(g && typeof g.t === 'function'){
                const v2 = g.t(key);
                if(v2 && v2 !== key) return v2;
              }
            }
          }catch(_){ }
          return (fallback!=null) ? fallback : key;
        }
        function itemNameKey(item){ return `shop_item_${item.id}_name`; }
        function itemDescKey(item){ return `shop_item_${item.id}_desc`; }
        function getNextWave(){
          try{
            const g = (typeof window!=='undefined') ? window.game : null;
            const w = (g && typeof g.waveNumber==='number') ? (g.waveNumber|0) : 0;
            const next = Math.max(1, (w||0) + (g?.inWave ? 0 : 1));
            return next;
          }catch(_){ return 1; }
        }
        function getUnlockState(nextWave){
          const w = Math.max(1, nextWave|0);
          return {
            showUpgrades: w >= 5,
            showSpecial: w >= 8,
            rarityMax: (w < 5) ? 'uncommon' : (w < 8) ? 'rare' : (w < 12) ? 'epic' : 'epic'
          };
        }
        function rarityRank(r){
          const map = { common:0, uncommon:1, rare:2, epic:3, legendary:4 };
          return map[String(r||'common').toLowerCase()] ?? 9;
        }
        function lockedCardHTML(title, desc){
          const costLabel = T('costLabel', 'Cost');
          return `
            <div class="shop-item rarity-common" style="opacity:0.55; filter:saturate(0.7); pointer-events:none;">
              <div class="shop-title"><span class="shop-icon"></span>${title}</div>
              <div class="shop-desc">${desc}</div>
              <div class="shop-cost unaffordable">${costLabel} </div>
              <div class="price-badge">LOCKED</div>
            </div>
          `;
        }
        // Helpers for limits and availability
        function totalConsumableCount(id){
          try{ return (localState.inv||[]).reduce((n,s)=> n + ((s&&s.id===id)?(s.count||1):0), 0); }catch(_){ return 0; }
        }
        function hasConsumSpace(item){
          // can stack on same id or use an empty slot
          const sameIdx = localState.inv.findIndex(s=>s && s.id===item.id);
          const hasEmpty = localState.inv.some(s=>!s);
          return sameIdx>=0 || hasEmpty;
        }
        function canBuyItem(item, fromOffers){
          if(fromOffers) return true; // free and single-claim handled elsewhere
          const mats = getMaterials();
          const cost = item.cost|0;
          // Special life purchase: costs all money (min 10) and only if lives < 2
          if(item.id==='buy_hearts'){
            try{
              const wn = (window.game?.waveNumber|0);
              const allowed = (wn===4||wn===9||wn===14||wn===19||wn===24||wn===29);
              if(!allowed) return false;
              if((window.game?.lives|0) >= 2) return false;
            }catch(_){ }
            return mats >= 10;
          }
          if(mats < cost) return false;
          const isConsum = item.tag==='consum';
          if(isConsum){
            // enforce stack caps if defined (heal_potion hard limit 3 already elsewhere)
            const cap = (item.maxStack|0) || (item.id==='heal_potion'?3:0);
            if(cap>0 && totalConsumableCount(item.id) >= cap) return false;
            if(!hasConsumSpace(item)) return false;
            return true;
          }
          // non-consumable: check optional max copies
          const owned = localState.owned[item.id]||0;
          const max = item.max|0; if(max>0 && owned >= max) return false;
          
          // weapon-tagged items: enforce 6-wave block allowance from core game state
          if(item.tag==='weapon'){
            try{
              const g = (typeof window!=='undefined') ? window.game : null;
              const left = (g?.weaponBlockAllowance|0);
              if(left <= 0) return false;
            }catch(_){ }
          }
          return true;
        }
        function cardHTML(item){
          const name = T(itemNameKey(item), item.name);
          const desc = T(itemDescKey(item), item.desc);
          const costLabel = T('costLabel', 'Cost');
          const price = `${costLabel} ${item.cost}`;
          const fromOffers = (localState.tab==='offers');
          const canBuy = canBuyItem(item, fromOffers);
          const afford = getMaterials()>= (item.cost|0);
          const costClass = fromOffers ? '' : (canBuy ? 'affordable' : (afford ? 'unaffordable' : 'unaffordable'));
          const lockClass = '';
          return `
            <div class="shop-item rarity-${item.rarity||'common'}" data-id="${item.id}">
              <div class="shop-title">
                <span class="shop-icon">${item.icon}</span>${name}
              </div>
              <div class="shop-desc">${desc}</div>
              <div class="shop-cost ${costClass}">${price}</div>
              <div class="price-badge">${item.rarity?.toUpperCase()||'COMMON'}</div>
            </div>
          `;
        }
        function getPool(){
          const unlock = getUnlockState(getNextWave());
          if(localState.tab==='offers') return Array.isArray(localState.offers)? localState.offers : [];
          if(localState.tab==='special' && !unlock.showSpecial) return [];
          if(localState.tab==='upgrades' && !unlock.showUpgrades) return [];
          const base = C[localState.tab]||[];
          if(localState.tab==='upgrades'){
            // Show weapon upgrades only after a weapon is explicitly selected
            try{
              let cw = window.game?.chosenWeapon || null;
              if(!cw){
                // No selection yet: hide all weapon-tagged items
                return base.filter(it=> it && it.tag!=='weapon');
              }
              // Normalize possible variants
              if(cw){
                const s = String(cw).toLowerCase();
                if(s.startsWith('turret')) cw = 'turrets';
                else if(s.startsWith('elec')) cw = 'electro';
                else if(s.startsWith('grav')) cw = 'gravity';
              }
              return base.filter(it=>{
                if(it.tag!=='weapon') return true;
                const t = String(it.type||'').toLowerCase();
                const c = String(cw||'').toLowerCase();
                return (t===c) || t.startsWith(c) || c.startsWith(t);
              });
            }catch(_){ return base.filter(it=> it && it.tag!=='weapon'); }
          }
          // Rarity progression: hide items above current cap
          return base.filter(it=>{
            if(!it) return false;
            return rarityRank(it.rarity) <= rarityRank(unlock.rarityMax);
          });
        }
        function render(){
          // Update shop header (title + wave)
          try{
            const ttl = document.getElementById('shopTitle');
            const waveLbl = document.getElementById('shopWaveLabel');
            if(ttl) ttl.textContent = T('shopTitle','Shop - Intermission');
            if(waveLbl){
              const next = getNextWave();
              waveLbl.textContent = `${T('wavePrefix','Wave')} ${next}`;
            }
          }catch(_){ }

          // Incremental unlock UI (tabs)
          const unlock = getUnlockState(getNextWave());
          try{
            if(tabUpgradesBtn){
              tabUpgradesBtn.style.display = unlock.showUpgrades ? '' : 'none';
              tabUpgradesBtn.disabled = !unlock.showUpgrades;
              tabUpgradesBtn.style.opacity = unlock.showUpgrades ? '' : '0.55';
            }
            if(tabSpecialBtn){
              tabSpecialBtn.style.opacity = unlock.showSpecial ? '' : '0.55';
              tabSpecialBtn.disabled = !unlock.showSpecial;
              tabSpecialBtn.title = unlock.showSpecial ? '' : 'Unlocks at Wave 8';
            }
            if(localState.tab==='special' && !unlock.showSpecial) localState.tab = 'items';
            if(localState.tab==='upgrades' && !unlock.showUpgrades) localState.tab = 'items';
          }catch(_){ }
          // Sort by rarity, then by cost for a cleaner layout
          const order = { common:0, uncommon:1, rare:2, epic:3 };
          const matsNow = getMaterials();
          const livesNow = (function(){ try{ return window.game ? (window.game.lives|0) : 0; }catch(_){ return 0; }})();
          const pool = getPool().slice()
            // If already at 2 lives, do not show buy_hearts at all
            .filter(it=> !(it && it.id==='buy_hearts' && livesNow>=2))
            .map(it=>{
            if(it && it.id==='buy_hearts'){
              // Dynamic price display: all money (min 10)
              const dyn = Math.max(10, matsNow|0);
              const clone = {
                ...it,
                cost: dyn,
                desc: (function(){
                  // Always keep description consistent with selected language
                  const key = 'shop_item_buy_hearts_desc';
                  const fallbackEn = 'Spend all your money (min 10). Your total hearts become 2. (Only available on Waves 4/9/14/19/24/29)';
                  const fallbackTr = 'Tm paran harca (min 10). Toplam kalbin 2 olur. (Sadece 4/9/14/19/24/29. dalgalarda alnabilir)';
                  try{
                    const sel = window.__i18n?.getLang ? window.__i18n.getLang() : (localStorage.getItem('lang') || 'en');
                    const norm = (sel === 'tr') ? 'tr' : 'en';
                    const fb = (norm === 'tr') ? fallbackTr : fallbackEn;
                    return T(key, fb);
                  }catch(_){ return fallbackEn; }
                })()
              };
              return clone;
            }
            return it;
          }).sort((a,b)=>{
            const ra = order[a.rarity] ?? 9; const rb = order[b.rarity] ?? 9;
            if(ra !== rb) return ra - rb;
            return (a.cost|0) - (b.cost|0);
          });
          // Partition into weapon vs others to ensure weapon upgrades appear under their header
          const parts = [];
          const weapons = pool.filter(it=> it && it.tag==='weapon');
          const others  = pool.filter(it=> it && it.tag!=='weapon');
          if(localState.tab==='upgrades' && weapons.length>0){
            parts.push(`<div style="grid-column:1/-1; color:#93c5fd; font-weight:700; margin-top:6px;">${T('weaponUpgrades','WEAPON UPGRADES')}</div>`);
            weapons.forEach(it=>{ parts.push(cardHTML(it)); });
          }
          // Render non-weapon with rarity headers
          let lastR = null;
          others.forEach(it=>{
            if(it.rarity !== lastR){
              lastR = it.rarity;
              parts.push(`<div style="grid-column:1/-1; color:#93c5fd; font-weight:700; margin-top:6px;">${(it.rarity||'COMMON').toUpperCase()}</div>`);
            }
            parts.push(cardHTML(it));
          });

          if(localState.tab==='upgrades' && parts.length===0 && !unlock.showUpgrades){
            parts.push(lockedCardHTML('Upgrades', 'Unlocks at Wave 5.')); 
          }
          if(localState.tab==='special' && parts.length===0 && !unlock.showSpecial){
            parts.push(lockedCardHTML('Special', 'Unlocks at Wave 8.'));
          }
          shopItemsEl.innerHTML = parts.join('');
          // Update weapon stats panel inside shop
          try{
            const box = document.getElementById('shopWeaponStats');
            if(box){
              const g = (typeof window!=='undefined') ? window.game : null;
              const t = (k, fb)=>{ try{ return (g && typeof g.t==='function') ? (g.t(k)||fb) : fb; }catch(_){ return fb; } };
              const rows = [];
              const cw = g?.chosenWeapon || '';
              const s = String(cw||'').toLowerCase();
              const isTurrets = s.startsWith('turret') || !!g?.playerTurrets;
              const isElectro = s.startsWith('elec') || !!g?.electroGen;
              const isGravity = s.startsWith('grav') || !!g?.gravityOrb;
              // Base weapon stats (global)
              rows.push(`<div style="grid-column:1/-1; color:#93c5fd; font-weight:700;">${t('weaponBase','BASE WEAPON')}</div>`);
              const baseFlat = (g && (g.baseDmgFlat||0)) || 0;
              const dmg = ((g && (g.weaponDamage!=null)) ? g.weaponDamage : (g?.weaponDmg||0)) + baseFlat;
              const frMs = Math.max(1, g?.weaponFireRate||0);
              const frS = (frMs/1000).toFixed(2)+'s';
              const rng = g?.weaponRange || g?.baseWeaponRange || 0;
              rows.push(`<div>${t('wepDamage','Damage')}</div><div>${dmg}</div>`);
              rows.push(`<div>${t('wepFireRate','Fire Rate')}</div><div>${frS}</div>`);
              rows.push(`<div>${t('wepRange','Range')}</div><div>${rng}</div>`);
              if (isTurrets || isElectro || isGravity) {
                rows.push(`<div style="grid-column:1/-1; color:#93c5fd; font-weight:700; margin-top:6px;">${t('weaponSelected','SELECTED WEAPON')}</div>`);
                if(isTurrets){
                  const tur = Array.isArray(g?.playerTurrets) ? g.playerTurrets : [];
                  const count = tur.length;
                  const r = count ? Math.round(tur.reduce((a,t)=>a+(t.range||520),0)/count) : 520;
                  const baseD = (g && (g.weaponDamage!=null)) ? g.weaponDamage : (g?.weaponDmg||12);
                  const effD = Math.round(baseD * (g.turretDamageMul||1));
                  const avgDelay = count ? Math.round(tur.reduce((a,t)=>a+(t.fireDelay||600),0)/count) : 600;
                  const effDelay = Math.max(120, Math.floor(avgDelay * (g.turretFireRateMul||1)));
                  rows.push(`<div>Turrets</div><div>${count}</div>`);
                  rows.push(`<div>${t('wepDamage','Damage')}</div><div>${effD}</div>`);
                  rows.push(`<div>${t('wepFireRate','Fire Rate')}</div><div>${(effDelay/1000).toFixed(2)}s</div>`);
                  rows.push(`<div>${t('wepRange','Range')}</div><div>${r}</div>`);
                }
                if(isElectro){
                  const eg = g?.electroGen || {};
                  const effDelay = Math.max(0, Math.floor((eg.fireDelay||1500) * (g.elecFireRateMul||1)));
                  const effRange = Math.floor((eg.range||520) * (g.elecRangeMul||1));
                  const effChain = ((eg.chain||0) + 1 + (g.elecChainBonus||0));
                  const baseD = (g && (g.weaponDamage!=null)) ? g.weaponDamage : (g?.weaponDmg||15);
                  const effD = Math.round(baseD * (eg.dmgMult||0.6) * (g.elecDmgMul||1));
                  rows.push(`<div>${t('wepDamage','Damage')}</div><div>${effD}</div>`);
                  rows.push(`<div>${t('wepPeriod','Period')}</div><div>${(effDelay/1000).toFixed(2)}s</div>`);
                  rows.push(`<div>${t('wepChain','Chain')}</div><div>${effChain}</div>`);
                  rows.push(`<div>${t('wepRange','Range')}</div><div>${effRange}</div>`);
                }
                if(isGravity){
                  const go = g?.gravityOrb || {};
                  const effPeriod = Math.max(0, Math.floor((go.period||2600) * (g.gravPeriodMul||1)));
                  const effRadius = Math.floor((go.radius||240) * (g.gravRadiusMul||1));
                  rows.push(`<div>${t('wepPeriod','Period')}</div><div>${(effPeriod/1000).toFixed(2)}s</div>`);
                  rows.push(`<div>${t('wepRadius','Radius')}</div><div>${effRadius}</div>`);
                  rows.push(`<div>${t('wepShrapnel','Shrapnel')}</div><div>${go.shrapnelCount||6}</div>`);
                }
              }
              box.innerHTML = rows.join('');
            }
          }catch(_){ }
          // If offers have been claimed this round, lock remaining offers visually
          if(localState.tab==='offers' && (localState.offersClaimedThisRound|0) >= 1){
            shopItemsEl.classList.add('offers-locked');
          } else {
            shopItemsEl.classList.remove('offers-locked');
          }
          // bind clicks
          Array.from(shopItemsEl.querySelectorAll('.shop-item')).forEach(card=>{
            card.addEventListener('click', ()=>{
              const id = card.getAttribute('data-id');
              const fromOffers = (localState.tab==='offers');
              const item = fromOffers
                ? (Array.isArray(localState.offers) ? localState.offers.find(x=>x.id===id) : null)
                : ([...C.items, ...C.upgrades, ...C.special].find(x=>x.id===id));
              if(!item) return;
              // Limit: at most 1 claim per round from internal free offers
              if(fromOffers && (localState.offersClaimedThisRound|0) >= 1){
                shopItemsEl.classList.add('shake');
                setTimeout(()=>shopItemsEl.classList.remove('shake'), 200);
                return;
              }
              const isConsum = item.tag==='consum';
              // Pre-check availability and limits BEFORE any deduction
              if(!canBuyItem(item, fromOffers)){
                shopItemsEl.classList.add('shake');
                setTimeout(()=>shopItemsEl.classList.remove('shake'), 200);
                return;
              }
              // track ownership / stacks
              if(isConsum){
                // place into inventory and bottom bar
                // heal_potion max 3 stacks total
                if(item.id==='heal_potion'){
                  const current = (localState.inv.reduce((n,s)=> n + ((s&&s.id==='heal_potion')?(s.count||1):0), 0))|0;
                  if(current >= 3){ render(); return; }
                }
                // Deduct materials now that we know it will succeed
                if(!fromOffers){ const mats=getMaterials(); setMaterials(mats - (item.cost|0)); }
                addConsumableToInventory(item);
              } else {
                // Special case: buy_hearts uses all money (min 10) and sets lives to 2
                if(item.id==='buy_hearts'){
                  const g = (typeof window!=='undefined') ? window.game : null;
                  const mats=getMaterials();
                  if(mats < 10){ return; }
                  // Hard block if lives already at cap (2)
                  try{ if(g && (g.lives|0) >= 2){ shopItemsEl.classList.add('shake'); setTimeout(()=>shopItemsEl.classList.remove('shake'), 200); return; } }catch(_){ }
                  setMaterials(0);
                  try{ if(g){ g.lives = Math.max(g.lives|0, 0); if((g.lives|0) < 2) g.lives = 2; } }catch(_){ }
                  try{ const livesEl = document.getElementById('livesDisplay'); if(livesEl && g) livesEl.textContent = ''.repeat(Math.max(0, g.lives|0)); }catch(_){ }
                } else {
                  // Deduct materials for non-consumables after all checks
                  if(!fromOffers){ const mats=getMaterials(); setMaterials(mats - (item.cost|0)); }
                  localState.owned[item.id] = (localState.owned[item.id]||0) + 1;
                  addBuffBadge(item, localState.owned[item.id]);
                  // dynamic price scaling for Vital Shard
                  if(!fromOffers && item.priceScale){ item.cost += item.priceScale; }
                  // apply upgrade/special stat effects
                  applyPermanentEffect(item.id);
                  // Decrement 6-wave block allowance for weapon-tagged items
                  if(item.tag==='weapon'){
                    try{
                      const g = (typeof window!=='undefined') ? window.game : null;
                      if(g){ g.weaponBlockAllowance = Math.max(0, (g.weaponBlockAllowance|0) - 1); }
                    }catch(_){ }
                  }
                }
              }
              // If claimed from offers: count and optionally keep list visible but locked
              if(fromOffers){
                localState.offersClaimedThisRound = (localState.offersClaimedThisRound|0) + 1;
                if(Array.isArray(localState.offers)){
                  const idx = localState.offers.findIndex(x=>x.id===id);
                  if(idx>=0) localState.offers.splice(idx,1);
                }
              }
              syncHUD();
              render();
              recomputeAndPublishStats();
              try{ window.dispatchEvent(new CustomEvent('shop:stats:refresh')); }catch(_){ }
            }, {passive:true});
          });
          // tabs active state
          [tabItemsBtn,tabUpgradesBtn,tabSpecialBtn,tabOffersBtn].forEach(btn=>btn?.classList.remove('active'));
          if(localState.tab==='items') tabItemsBtn?.classList.add('active');
          if(localState.tab==='upgrades') tabUpgradesBtn?.classList.add('active');
          if(localState.tab==='special') tabSpecialBtn?.classList.add('active');
          if(localState.tab==='offers') tabOffersBtn?.classList.add('active');
        }

        // Listen for explicit shop stats refresh requests and re-render the shop UI
        try{ window.addEventListener('shop:stats:refresh', ()=>{ try{ render(); }catch(_){ } }); }catch(_){ }

        function applyPermanentEffect(id){
          try{
            const g = window.game || (window.game={});
            switch(id){
              // Base stat upgrades
              case 'sharp_crystal':
                g.baseDmgFlat = (g.baseDmgFlat||0) + 3; // +3 DMG
                g.moveSpeedMul = (g.moveSpeedMul||1) * 0.97; // -3% speed
                break;
              case 'light_core':
                g.moveSpeedMul = (g.moveSpeedMul||1) * 1.06; // +6% speed
                g.armorFlat = (g.armorFlat||0) - 1; // -1 armor (tradeoff)
                break;
              case 'iron_husk':
                g.armorFlat = (g.armorFlat||0) + 2; // +2 armor
                g.moveSpeedMul = (g.moveSpeedMul||1) * 0.96; // -4% speed
                break;
              case 'vital_shard':
                // +1 max heart; if lives UI is used, raise cap and heal by one
                try{ g.maxLives = Math.max((g.maxLives||1), (g.lives||1)) + 1; g.lives = Math.min(g.maxLives||2, (g.lives||0)+1); }catch(_){ }
                break;
              case 'base_overclocker':
                // Fire rate +15% -> reduce ms delay
                if(typeof g.weaponFireRate==='number') g.weaponFireRate = Math.max(100, Math.floor(g.weaponFireRate * 0.85));
                try{
                  if (Array.isArray(g.playerTurrets)) g.playerTurrets.forEach(t=>{ t.fireDelay = Math.max(120, Math.floor((t.fireDelay||600) * 0.85)); });
                  if (g.electroGen) g.electroGen.fireDelay = Math.max(120, Math.floor((g.electroGen.fireDelay||1500) * 0.85));
                }catch(_){ }
                break;
              case 'base_reinforced_slugs':
                if(typeof g.weaponDamage==='number') g.weaponDamage = Math.max(1, Math.floor(g.weaponDamage * 1.12));
                break;
              case 'base_calibrated_sight':
                if(typeof g.weaponRange==='number') { g.weaponRange = Math.floor((g.weaponRange||600) * 1.10); g.baseWeaponRange = g.weaponRange; }
                break;
              case 'base_kinetic_rounds':
                g.projectileSpeedMult = (g.projectileSpeedMult||1) * 1.12;
                break;
              case 'base_quickstep':
                g.moveSpeedMul = (g.moveSpeedMul||1) * 1.08;
                try{ if(g.player) g.player.speedBoost = (g.player.speedBoost||1) * 1.08; }catch(_){ }
                break;
              case 'wep_turret_damage':
                g.turretDamageMul = (g.turretDamageMul||1) * 1.15; break;
              case 'wep_turret_speed':
                g.turretFireRateMul = (g.turretFireRateMul||1) * 0.88; break; // lower delay
              case 'wep_turret_range':
                if(Array.isArray(g.playerTurrets)) g.playerTurrets.forEach(t=>{ t.range = Math.round((t.range||520) * 1.15); });
                g.turretRangeMul = (g.turretRangeMul||1) * 1.15; break;
              case 'wep_elec_damage':
                g.elecDmgMul = (g.elecDmgMul||1) * 1.15; break;
              case 'wep_elec_speed':
                g.elecFireRateMul = (g.elecFireRateMul||1) * 0.88; break;
              case 'wep_elec_chain':
                if(g.electroGen) g.electroGen.chain = Math.min(8, (g.electroGen.chain|0) + 1); else g.elecChainBonus = (g.elecChainBonus||0)+1; break;
              case 'wep_elec_range':
                if(g.electroGen) g.electroGen.range = Math.round((g.electroGen.range||520) * 1.10); else g.elecRangeMul = (g.elecRangeMul||1)*1.10; break;
              case 'wep_grav_damage':
                if(g.gravityOrb) g.gravityOrb.dmgMult = (g.gravityOrb.dmgMult||1) * 1.15; else g.gravDmgMul = (g.gravDmgMul||1)*1.15; break;
              case 'wep_grav_speed':
                if(g.gravityOrb) g.gravityOrb.period = Math.max(600, Math.floor((g.gravityOrb.period||2600) * 0.88)); else g.gravPeriodMul = (g.gravPeriodMul||1)*0.88; break;
              case 'wep_grav_radius':
                if(g.gravityOrb) g.gravityOrb.radius = Math.round((g.gravityOrb.radius||240) * 1.12); else g.gravRadiusMul = (g.gravRadiusMul||1)*1.12; break;
              case 'wep_grav_shrapnel':
                if(g.gravityOrb) g.gravityOrb.shrapnelCount = Math.min(20, (g.gravityOrb.shrapnelCount||6) + 2); else g.gravShrapnelBonus = (g.gravShrapnelBonus||0)+2; break;
            }
            try{ window.dispatchEvent(new CustomEvent('shop:stats:refresh')); }catch(_){ }
          }catch(_){ }
        }

        // Expose a minimal API to re-render and switch tabs from outside this closure
        window.shopUI = window.shopUI || {};
        window.shopUI.render = render;
        window.shopUI.setTab = function(tab){
          try{ localState.tab = tab; render(); }catch(_){ }
        };

        // Inventory helpers -> Bottom bar UI
        function updateBar(){
          // write inventory into bottom bar UI
          localState.inv.forEach((slot, i)=>{
            const n = i+1;
            if(slot){
              window.consumBar.setIcon(n, slot.icon);
              window.consumBar.setCount(n, slot.count||1);
            } else {
              window.consumBar.clearSlot(n);
            }
          });
        }
        function addConsumableToInventory(item){
          // try stack first
          let idx = localState.inv.findIndex(s=>s && s.id===item.id);
          if(idx>=0){
            localState.inv[idx].count = (localState.inv[idx].count||1)+1;
          } else {
            // find empty slot
            idx = localState.inv.findIndex(s=>!s);
            if(idx===-1) return; // full
            localState.inv[idx] = { id:item.id, icon:item.icon, name:item.name, cost:item.cost, count:1 };
          }
          // track owned stack for HUD badge
          localState.owned[item.id] = (localState.owned[item.id]||0)+1;
          addBuffBadge(item, localState.owned[item.id]);
          updateBar();
          updateBuffBadges();
        }

        // Drag & Drop reordering and right-click sell
        function initInventoryInteractions(){
          if(!window.consumBar?.slots) return;
          // Prevent browser context menu on the whole bar while shop is open
          try {
            const barEl = document.getElementById('consumableBar');
            barEl?.addEventListener('contextmenu', (e)=>{
              if(isShopVisible()){ e.preventDefault(); e.stopPropagation(); }
            });
          } catch(_){ }
          window.consumBar.slots.forEach((s, i)=>{
            if(!s?.root) return;
            const root = s.root;
            root.setAttribute('draggable','true');
            root.addEventListener('dragstart', (e)=>{
              if(!isShopVisible()) return e.preventDefault();
              e.dataTransfer.setData('text/plain', String(i));
            });
            root.addEventListener('dragover', (e)=>{ if(isShopVisible()) e.preventDefault(); });
            root.addEventListener('drop', (e)=>{
              e.preventDefault();
              if(!isShopVisible()) return;
              const from = parseInt(e.dataTransfer.getData('text/plain')||'-1',10);
              const to = i;
              if(from<0 || from===to) return;
              const a = localState.inv[from];
              const b = localState.inv[to];
              localState.inv[from] = b;
              localState.inv[to] = a;
              updateBar();
            });
            // Right-click sell one stack unit (40% refund)
            root.addEventListener('contextmenu', (e)=>{
              e.preventDefault();
              e.stopPropagation();
              if(!isShopVisible()) return; // sell only in shop
              const slot = localState.inv[i];
              if(!slot) return;
              const refund = Math.floor((slot.cost||0)*0.4);
              setMaterials(getMaterials() + refund);
              slot.count = (slot.count||1)-1;
              if(slot.count<=0){ localState.inv[i] = null; }
              // also update owned stacks and badges
              localState.owned[slot.id] = Math.max(0, (localState.owned[slot.id]||1)-1);
              if(localState.owned[slot.id]===0) delete localState.owned[slot.id];
              syncHUD();
              updateBar();
              render();
              updateBuffBadges();
            });
          });
        }

        function addBuffBadge(item, count){
          if(!activeBuffsList) return;
          let badge = activeBuffsList.querySelector(`[data-buff='${item.id}']`);
          if(!badge){
            badge = document.createElement('div');
            badge.setAttribute('data-buff', item.id);
            badge.style.border = '1px solid #334155';
            badge.style.borderRadius = '999px';
            badge.style.padding = '2px 8px';
            badge.style.fontSize = '12px';
            badge.style.background = 'rgba(2,6,23,0.5)';
            badge.style.color = '#e2e8f0';
            badge.textContent = `${item.icon} ${item.name}`;
            activeBuffsList.appendChild(badge);
          }
          // Show stack count for consumables
          if(item.tag==='consum'){
            badge.textContent = `${item.icon} ${item.name} x${count}`;
          }
        }

        function updateBuffBadges(){
          if(!activeBuffsList) return;
          const all = Array.from(activeBuffsList.querySelectorAll('[data-buff]'));
          all.forEach(b=>{
            const id = b.getAttribute('data-buff');
            const count = localState.owned[id]||0;
            if(count<=0){ b.remove(); return; }
            // find item def for icon/name (consumables are in C.items)
            const item = (C.items||[]).find(x=>x.id===id);
            if(item){ b.textContent = `${item.icon} ${item.name} x${count}`; }
          });
        }

        // Accept passive inventory grants from game (e.g., magnet at Wave 3)
        window.addEventListener('inventory:add', (e)=>{
          try{
            const it = e?.detail; if(!it || !it.id) return;
            localState.owned[it.id] = (localState.owned[it.id]||0) + 1;
            // Show immediately in Active Buffs with provided icon/name
            addBuffBadge(it, localState.owned[it.id]);
            updateBuffBadges();
            syncHUD();
          }catch(_){ }
        });

        window.addEventListener('inventory:consumable:add', (e)=>{
          try{
            const it = e?.detail; if(!it || !it.id) return;
            const item = { id: it.id, icon: it.icon||'', name: it.name||it.id, cost: it.cost||0 };
            if(item.id === 'magnet_core'){
              const i = 4; // 0-based index for 5th slot
              const cur = localState.inv[i];
              if(cur && cur.id !== 'magnet_core'){
                addConsumableToInventory(item);
              } else {
                if(cur){ cur.count = (cur.count||1)+1; }
                else { localState.inv[i] = { id:item.id, icon:item.icon, name:item.name, cost:item.cost, count:1 }; }
                window.consumBar.setIcon(5, item.icon);
                window.consumBar.setCount(5, (localState.inv[i].count||1));
                // Clear any existing cooldown state on slot 5 (avoid showing 14 immediately)
                try{
                  const s = window.consumBar?.slots?.[4];
                  if(s){
                    if(s.cooldownId){ clearInterval(s.cooldownId); s.cooldownId = null; }
                    s.cooldownUntil = 0;
                    s.timer.textContent = '';
                    s.root.classList.remove('cooldown');
                    // flash animation to reveal slot
                    s.root.classList.add('use-anim');
                    setTimeout(()=>{ try{ s.root.classList.remove('use-anim'); }catch(_){ } }, 500);
                  }
                }catch(_){ }
                localState.owned[item.id] = (localState.owned[item.id]||0)+1;
                addBuffBadge(item, localState.owned[item.id]);
                updateBuffBadges();
                // Spawn transient magnet emoji above player to indicate grant
                try{
                  const g = window.game; const cvs = document.getElementById('gameCanvas'); const p=g?.player;
                  let cx=(cvs?.width||innerWidth)/2, cy=(cvs?.height||innerHeight)/2;
                  if(g && typeof g.worldToScreen==='function' && p?.pos){ const s=g.worldToScreen(p.pos); cx=s.x; cy=s.y; }
                  const rect = cvs?.getBoundingClientRect ? cvs.getBoundingClientRect() : { left:0, top:0, width:innerWidth, height:innerHeight };
                  const sx = cvs && cvs.width ? (rect.width / cvs.width) : 1;
                  const sy = cvs && cvs.height ? (rect.height / cvs.height) : 1;
                  const vx = Math.round(rect.left + cx * sx);
                  const vy = Math.round(rect.top + cy * sy) - 24;
                  const el = document.createElement('div');
                  el.textContent = item.icon || '';
                  el.style.position='fixed'; el.style.left=`${vx}px`; el.style.top=`${vy}px`;
                  el.style.transform='translate(-50%, -50%)'; el.style.fontSize='28px'; el.style.zIndex='1402'; el.style.pointerEvents='none'; el.style.opacity='1';
                  el.style.transition='transform 600ms ease-out, opacity 600ms ease-out';
                  document.body.appendChild(el);
                  requestAnimationFrame(()=>{ el.style.transform='translate(-50%, -120%) scale(1.2)'; el.style.opacity='0'; });
                  setTimeout(()=>{ try{ el.remove(); }catch(_){ } }, 700);
                  // Also show centered overlay like the heart animation
                  try{
                    const ov = document.getElementById('magnetOverlay');
                    const ico = document.getElementById('magnetOverlayIcon');
                    if(ov && ico){
                      ov.style.display = 'flex';
                      ico.classList.remove('pulse-anim');
                      // force reflow
                      void ico.offsetWidth;
                      ico.classList.add('pulse-anim');
                      setTimeout(()=>{ try{ ov.style.display='none'; ico.classList.remove('pulse-anim'); }catch(_){ } }, 1000);
                    }
                  }catch(_){ }
                }catch(_){ }
              }
            } else {
              addConsumableToInventory(item);
            }
            syncHUD();
            render();
          }catch(_){ }
        });

        // Tab handlers
        tabItemsBtn?.addEventListener('click', ()=>{ localState.tab='items'; render(); });
        tabUpgradesBtn?.addEventListener('click', ()=>{
          const unlock = getUnlockState(getNextWave());
          if(!unlock.showUpgrades){ try{ shopItemsEl.classList.add('shake'); setTimeout(()=>shopItemsEl.classList.remove('shake'), 200); }catch(_){ } return; }
          localState.tab='upgrades'; render();
        });
        tabSpecialBtn?.addEventListener('click', ()=>{
          const unlock = getUnlockState(getNextWave());
          if(!unlock.showSpecial){ try{ shopItemsEl.classList.add('shake'); setTimeout(()=>shopItemsEl.classList.remove('shake'), 200); }catch(_){ } return; }
          localState.tab='special'; render();
        });
        tabOffersBtn?.addEventListener('click', ()=>{
          // If offers are empty, generate defaults and switch; prevents blank tab
          if(!Array.isArray(localState.offers) || localState.offers.length===0){ localState.offers = makeDefaultOffers(); }
          localState.tab='offers';
          render();
        });

        // Public API for offers
        window.showShopOffers = function(list){
          try{
            const elem = getPlayerElement();
            const src = Array.isArray(list) ? list.slice() : makeDefaultOffers();
            const filtered = Array.isArray(src) ? src.filter(x=> x && (x.tag===elem)) : null;
            localState.offers = filtered;
            localState.offersClaimedThisRound = 0;
            if(localState.offers && localState.offers.length>0){
              localState.tab = 'offers';
            }
            render();
          }catch(_){ }
        };
        window.clearShopOffers = function(){
          try{
            localState.offers = null;
            if(localState.tab==='offers') localState.tab='items';
            render();
          }catch(_){ }
        };

        // Basic buttons placeholder
        // Do not auto-switch to Offers on first open; render depends on explicit tab clicks.
        lockBtn?.addEventListener('click', ()=>{
          try{
            const cur = (lockBtn.getAttribute('data-locked') === 'true');
            const next = !cur;
            lockBtn.setAttribute('data-locked', next ? 'true' : 'false');
            const tr = window.__i18n?.t;
            if(typeof tr === 'function'){
              lockBtn.textContent = tr(next ? 'unlockLabel' : 'lockLabel', lockBtn.textContent);
            }
          }catch(_){ }
        });

        // CSS micro-anim
        const style = document.createElement('style');
        style.textContent = `.offers-locked .shop-item{opacity:0.5; pointer-events:none; filter:grayscale(0.2);}`;
        document.head.appendChild(style);

        // Initial render and interactions
        render();
        initInventoryInteractions();
        
        // Consumable activation -> consume stack, start cooldown, update UI
        const CONSUMABLE_COOLDOWNS = {
          blood_draught: 12,
          flame_syrup: 10,
          mist_tonic: 14,
          stone_infusion: 10,
          heal_potion: 12,
          magnet_core: 7,
        };
        function consumeFromSlot(slotIndex){
          const i = (slotIndex|0) - 1;
          if(i < 0 || i >= localState.inv.length) return;
          const slot = localState.inv[i];
          if(!slot) return; // empty
          // Block if UI cooldown active
          const uiSlot = window.consumBar?.slots?.[i];
          if(uiSlot && uiSlot.cooldownUntil && uiSlot.cooldownUntil > Date.now()) return;
          const id = slot.id;
          // For magnet_core, make it permanent: do NOT decrement count or owned
          if(id !== 'magnet_core'){
            // Consume one stack
            slot.count = (slot.count||1) - 1;
            // Do NOT remove immediately; keep grayscale until cooldown ends
            // Update owned/badge stack tracking
            localState.owned[id] = Math.max(0, (localState.owned[id]||1) - 1);
            if(localState.owned[id] === 0) delete localState.owned[id];
          }
          // Start cooldown visual
          const cd = CONSUMABLE_COOLDOWNS[id] || 8;
          window.consumBar?.startCooldown(slotIndex, cd);
          try{
            const ev2 = new CustomEvent('consumable:cooldownStart', { detail: { slot: slotIndex, id, duration: cd } });
            window.dispatchEvent(ev2);
          }catch(_){ }
          // Refresh UI
          updateBar();
          render();
          updateBuffBadges();
          // apply consumable immediate effect hooks
          applyConsumableImmediate(id);
          recomputeAndPublishStats();
          
          // Show hint popup notification
          try{
            const g = (typeof window!=='undefined') ? window.game : undefined;
            if(g && typeof g.showHintToast === 'function'){
              const consumableNames = {
                'blood_draught': 'Blood Draught Active!',
                'flame_syrup': 'Flame Syrup Active!',
                'mist_tonic': 'Mist Tonic Active!',
                'stone_infusion': 'Stone Infusion Active!',
                'heal_potion': 'HP Restored!',
                'magnet_core': 'Magnet Core Active!'
              };
              const message = consumableNames[id] || 'Power-up Active!';
              g.showHintToast(message);
            }
          }catch(_){ }
        }

        // Allow using consumables by tapping the slot in the bar (mobile-friendly)
        (function(){
          function bind(){
            const slots = window.consumBar?.slots || [];
            if(!slots.length) return false;
            let boundAny = false;
            slots.forEach((s, i)=>{
              if(!s?.root) return;
              const el = s.root;
              if(el.__useBound) return;
              el.addEventListener('pointerdown', function(e){
                try{ e.preventDefault(); }catch(_){ }
                try{ e.stopPropagation(); }catch(_){ }
                if(!document.body.classList.contains('playing') && !document.body.classList.contains('shop-open')) return;
                if(document.body.classList.contains('menu-open')) return;
                consumeFromSlot(i+1);
              }, { capture: true, passive: false });
              el.__useBound = true;
              boundAny = true;
            });
            return boundAny;
          }
          try{
            if(bind()) return;
            let n = 0;
            const t = setInterval(()=>{
              try{ bind(); }catch(_){ }
              if(++n > 20) clearInterval(t);
            }, 250);
          }catch(_){ }
        })();
        window.addEventListener('consumable:activate', (e)=>{
          // Only allow during play state
          if(!document.body.classList.contains('playing')) return;
          const idx = e?.detail?.slot|0;
          if(!idx) return;
          // Animate the pressed slot for feedback
          try{
            const slotEl = document.getElementById('consumSlot'+idx);
            if(slotEl){
              slotEl.classList.remove('use-anim');
              // force reflow to restart animation
              void slotEl.offsetWidth;
              slotEl.classList.add('use-anim');
              setTimeout(()=>slotEl.classList.remove('use-anim'), 480);
            }
            if(idx === 5){
              const g = (typeof window!=='undefined') ? window.game : undefined;
              try{
                if(!g) return;
                g._magnetActiveCount = (g._magnetActiveCount||0) + 1;
                g.magnetActive = true;
                g.magnetRadius = Math.max(g.magnetRadius||300, 360);
                const off = ()=>{
                  try{
                    g._magnetActiveCount = Math.max(0, (g._magnetActiveCount||1) - 1);
                    if(g._magnetActiveCount===0){ g.magnetActive = false; }
                  }catch(_){ }
                };
                setTimeout(off, 7000);
                try{
                  const cvs = document.getElementById('gameCanvas');
                  const p = g?.player;
                  let cx=(cvs?.width||innerWidth)/2, cy=(cvs?.height||innerHeight)/2;
                  if(g && typeof g.worldToScreen==='function' && p?.pos){ const s=g.worldToScreen(p.pos); cx=s.x; cy=s.y; }
                  const rect = cvs?.getBoundingClientRect ? cvs.getBoundingClientRect() : { left:0, top:0, width:innerWidth, height:innerHeight };
                  const sx = cvs && cvs.width ? (rect.width / cvs.width) : 1;
                  const sy = cvs && cvs.height ? (rect.height / cvs.height) : 1;
                  const vx = Math.round(rect.left + cx * sx);
                  const vy = Math.round(rect.top + cy * sy);
                  const ring = document.createElement('div');
                  ring.style.position='fixed'; ring.style.left=`${vx}px`; ring.style.top=`${vy}px`;
                  ring.style.transform='translate(-50%, -50%)'; ring.style.width='10px'; ring.style.height='10px'; ring.style.borderRadius='999px';
                  ring.style.boxShadow='0 0 0 0 rgba(59,130,246,0.85), 0 0 18px 5px rgba(59,130,246,0.65)'; ring.style.pointerEvents='none'; ring.style.zIndex='1401';
                  ring.style.transition='transform 450ms ease-out, opacity 450ms ease-out, box-shadow 450ms ease-out';
                  document.body.appendChild(ring);
                  requestAnimationFrame(()=>{ ring.style.transform='translate(-50%, -50%) scale(22)'; ring.style.opacity='0'; ring.style.boxShadow='0 0 0 10px rgba(59,130,246,0.0), 0 0 36px 10px rgba(59,130,246,0.0)'; });
                  setTimeout(()=>{ try{ ring.remove(); }catch(_){ } }, 500);
                }catch(_){ }
              }catch(_){ }
            }
            consumeFromSlot(idx);
          }catch(_){ }
        });
        // Apply temporary effects when cooldown starts
        (function(){
          const K = '__consumTempMods';
          window[K] = window[K] || {};
          function pulse(color){
            try{
              const cvs = document.getElementById('gameCanvas');
              const g = window.game; const p=g?.player;
              let cx=(cvs?.width||innerWidth)/2, cy=(cvs?.height||innerHeight)/2;
              if(g && typeof g.worldToScreen==='function' && p?.pos){ const s=g.worldToScreen(p.pos); cx=s.x; cy=s.y; }
              const rect = cvs?.getBoundingClientRect ? cvs.getBoundingClientRect() : { left:0, top:0, width:innerWidth, height:innerHeight };
              const sx = cvs && cvs.width ? (rect.width / cvs.width) : 1;
              const sy = cvs && cvs.height ? (rect.height / cvs.height) : 1;
              const vx = Math.round(rect.left + cx * sx);
              const vy = Math.round(rect.top + cy * sy);
              const ring = document.createElement('div');
              ring.style.position='fixed'; ring.style.left=`${vx}px`; ring.style.top=`${vy}px`;
              ring.style.transform='translate(-50%, -50%)'; ring.style.width='10px'; ring.style.height='10px'; ring.style.borderRadius='999px';
              ring.style.boxShadow=`0 0 0 0 ${color}, 0 0 18px 5px ${color}`; ring.style.pointerEvents='none'; ring.style.zIndex='1401';
              ring.style.transition='transform 450ms ease-out, opacity 450ms ease-out, box-shadow 450ms ease-out';
              document.body.appendChild(ring);
              requestAnimationFrame(()=>{ ring.style.transform='translate(-50%, -50%) scale(18)'; ring.style.opacity='0'; ring.style.boxShadow=`0 0 0 10px ${color.replace('0.85','0.0')}, 0 0 36px 10px ${color.replace('0.85','0.0')}`; });
              setTimeout(()=>{ try{ ring.remove(); }catch(_){ } }, 500);
            }catch(_){ }
          }
          window.addEventListener('consumable:cooldownStart', (e)=>{
            const id = e?.detail?.id; const slot = e?.detail?.slot|0; const dur = (e?.detail?.duration|0) || 8;
            if(!id || !slot) return;
            const g = window.game || (window.game={});
            if(!window[K][slot]) window[K][slot] = {};
            const store = window[K][slot];
            switch(id){
              case 'blood_draught':{
                // +20% weapon damage; small regen over time (~1.2%/s)
                store.weaponDamage = g.weaponDamage;
                g.weaponDamage = (g.weaponDamage != null ? g.weaponDamage : 12) * 1.20;
                const p = g.player; const maxHP = p?.maxHP || 100;
                const tick = ()=>{ try{ if(!g?.player) return; g.player.hp = Math.min(g.player.maxHP||maxHP, (g.player.hp||maxHP) + Math.max(1, Math.round((g.player.maxHP||maxHP)*0.012))); }catch(_){ } };
                const h = setInterval(tick, 1000);
                store._intervals = (store._intervals||[]); store._intervals.push(h);
                pulse('rgba(220,38,38,0.85)'); // red
                break; }
              case 'flame_syrup':{
                // Faster fire rate and faster projectiles (moderate)
                store.weaponFireRate = g.weaponFireRate;
                store.projectileSpeedMult = g.projectileSpeedMult;
                g.weaponFireRate = Math.max(120, Math.floor((g.weaponFireRate||450) * 0.80));
                g.projectileSpeedMult = (g.projectileSpeedMult||1) * 1.10;
                pulse('rgba(251,146,60,0.85)'); // orange
                break; }
              case 'mist_tonic':{
                // Short invulnerability window using existing dodgeInvulnUntil (75% of CD)
                const now = Date.now();
                store.dodgeInvulnUntil = g.dodgeInvulnUntil;
                g.dodgeInvulnUntil = Math.max(g.dodgeInvulnUntil||0, now + Math.floor(dur*1000*0.75));
                pulse('rgba(96,165,250,0.85)'); // blue
                break; }
              case 'stone_infusion':{
                // Temporary maxHP boost (+15%) and grant same as immediate HP; clamp back on end
                const p = g.player;
                if(p){
                  store.maxHP = p.maxHP;
                  const add = Math.max(1, Math.round((p.maxHP||100) * 0.15));
                  p.maxHP = (p.maxHP||100) + add;
                  p.hp = Math.min(p.maxHP, (p.hp||p.maxHP) + add);
                }
                pulse('rgba(148,163,184,0.85)'); // gray
                break; }
            }
          });
          window.addEventListener('consumable:cooldownEnd', (e)=>{
            const slot = e?.detail?.slot|0; if(!slot) return;
            const g = window.game || (window.game={});
            const store = window[K][slot];
            if(!store) return;
            // clear intervals
            try{ (store._intervals||[]).forEach(id=>clearInterval(id)); }catch(_){ }
            // revert numeric fields if stored
            if(store.weaponDamage != null) g.weaponDamage = store.weaponDamage;
            if(store.weaponFireRate != null) g.weaponFireRate = store.weaponFireRate;
            if(store.projectileSpeedMult != null) g.projectileSpeedMult = store.projectileSpeedMult;
            if(store.dodgeInvulnUntil != null) g.dodgeInvulnUntil = store.dodgeInvulnUntil;
            if(store.maxHP != null && g.player){
              const p = g.player; p.maxHP = store.maxHP; if(p.hp > p.maxHP) p.hp = p.maxHP;
            }
            delete window[K][slot];
          });
        })();
        // When a slot cooldown ends, if that slot's stack is 0, clear the slot from inventory
        window.addEventListener('consumable:cooldownEnd', (e)=>{
          const idx = e?.detail?.slot|0; if(!idx) return;
          const i = idx-1;
          const slot = localState.inv[i];
          if(slot && (slot.count|0) <= 0){
            localState.inv[i] = null;
            updateBar();
          }
          // clear any temporary effect flags tied to this slot if needed
          clearTemporaryEffectsForSlot(idx);
          recomputeAndPublishStats();
        });

        // ================= Stats and Effects =================
        // Base stats and effect mappings; adjust as your core game expects
        const BASE_STATS = { DMG: 10, ATK: 1.0, SPD: 1.0, ARM: 0, DODGE: 0, HP: 100, REGEN: 0, BURN: 0, SLOW: 0 };
        // permanent effects keyed by id
        const PERM_EFFECTS = {
          sharp_crystal: { DMG:+3, SPD:-0.03 },
          light_core: { SPD:+0.06, ARM:-1 },
          iron_husk: { ARM:+2, SPD:-0.04 },
          vital_shard: { HP:+10 },
          // specials (examples)
          amber_coin: {}, // economy only
          lucky_charm: { DMG:-0.05 }, // damage -5%
          time_relic: {},
          cinder_ring: { BURN:+0.5 },
          frozen_veil: { SLOW:+0.1 },
          tidecaller: { SPD:-0.02 },
          tempest_feather: { SPD:+0.15, DMG:+0.10 },
          burning_claw: {},
          abyss_pearl: { ARM:+1, SPD:-0.05, ATK:+0.65 },
          storm_eye: { ATK:+0.10 },
          cyclone_fragment: {},
          time_relic2: {},
          molten_core: { REGEN:-1, BURN:+0.5 }
        };
        // temporary consumable effects
        const TEMP_EFFECTS = {
          blood_draught: (on)=> on ? { lifesteal:0.4 } : {},
          flame_syrup: (on)=> on ? { burnOnHit:true, moveMult:0.8, lifestealFromBurn:0.2 } : {},
          mist_tonic: (on)=> on ? { blockHits:3, vision:-0.5 } : {},
          stone_infusion: (on)=> on ? { ARM:+3, SPD:-0.15 } : {},
          heal_potion: (on)=> ({})
        };
        let tempFlags = {}; // aggregated runtime flags

        

        function applyConsumableImmediate(id){
          // immediate actions
          if(id==='heal_potion'){
            const g = (typeof window!=='undefined') ? window.game : undefined;
            let healedAmt = 0;
            try{
              // Update the actual player HP used by core gameplay
              const p = g && g.player ? g.player : null;
              if(p){
                const maxHPField = (typeof p.maxHP === 'number' && p.maxHP > 0) ? 'maxHP' : ((typeof p.maxHp === 'number' && p.maxHp > 0) ? 'maxHp' : null);
                const maxHP = maxHPField ? p[maxHPField] : 100;
                const cur = (typeof p.hp === 'number' && p.hp >= 0) ? p.hp : maxHP;
                const add = Math.round(maxHP * 0.25);
                const healed = Math.min(maxHP, cur + add); // +25% of max HP
                healedAmt = Math.max(0, healed - cur);
                p.hp = healed;
                // Mirror to global fields if some UI reads these
                if(typeof g.maxHp === 'number' && g.maxHp > 0) g.hp = Math.min(g.maxHp, (typeof g.hp==='number'?g.hp:healed) + 0);
              }
            }catch(_){ }
            // Force an on-screen heal pulse for clear feedback
            try{
              const cvs = document.getElementById('gameCanvas');
              const p = g?.player;
              // Default to canvas center in canvas coordinates
              let cx = (cvs?.width||innerWidth)/2, cy = (cvs?.height||innerHeight)/2;
              if(g && typeof g.worldToScreen==='function' && p?.pos){ const s=g.worldToScreen(p.pos); cx=s.x; cy=s.y; }
              // Map canvas coordinates -> viewport pixels using bounding rect (handles mobile CSS scaling)
              const rect = cvs?.getBoundingClientRect ? cvs.getBoundingClientRect() : { left:0, top:0, width:innerWidth, height:innerHeight };
              const scaleX = cvs && cvs.width ? (rect.width / cvs.width) : 1;
              const scaleY = cvs && cvs.height ? (rect.height / cvs.height) : 1;
              const vx = Math.round(rect.left + cx * scaleX);
              const vy = Math.round(rect.top + cy * scaleY);
              const ring = document.createElement('div');
              ring.style.position='fixed'; ring.style.left=`${vx}px`; ring.style.top=`${vy}px`;
              ring.style.transform='translate(-50%, -50%)'; ring.style.width='12px'; ring.style.height='12px'; ring.style.borderRadius='999px';
              ring.style.boxShadow='0 0 0 0 rgba(16,185,129,0.9), 0 0 24px 6px rgba(16,185,129,0.55)'; ring.style.pointerEvents='none'; ring.style.zIndex='1401';
              ring.style.transition='transform 500ms ease-out, opacity 500ms ease-out, box-shadow 500ms ease-out';
              document.body.appendChild(ring);
              requestAnimationFrame(()=>{ ring.style.transform='translate(-50%, -50%) scale(22)'; ring.style.opacity='0'; ring.style.boxShadow='0 0 0 10px rgba(16,185,129,0.0), 0 0 44px 14px rgba(16,185,129,0.0)'; });
              setTimeout(()=>{ try{ ring.remove(); }catch(_){ } }, 560);

              // Small '+HP' floating text for visibility
              if(healedAmt > 0){
                const txt = document.createElement('div');
                txt.textContent = `+${healedAmt} HP`;
                txt.style.position='fixed'; txt.style.left=`${vx}px`; txt.style.top=`${vy-18}px`;
                txt.style.transform='translate(-50%, -50%)';
                txt.style.color='#10b981'; txt.style.fontWeight='700'; txt.style.textShadow='0 0 6px rgba(16,185,129,0.8)';
                txt.style.pointerEvents='none'; txt.style.zIndex='1402'; txt.style.opacity='1';
                txt.style.transition='transform 600ms ease-out, opacity 600ms ease-out';
                document.body.appendChild(txt);
                requestAnimationFrame(()=>{ txt.style.transform='translate(-50%, -90%)'; txt.style.opacity='0'; });
                setTimeout(()=>{ try{ txt.remove(); }catch(_){ } }, 700);
              }
            }catch(_){ }
          }
        }

        function clearTemporaryEffectsForSlot(slotIndex){
          // here we could track per-slot effects; for now full recompute will drop temp flags
          tempFlags = {};
        }

        function aggregateOwnedEffects(){
          const out = { ...BASE_STATS };
          // apply permanent effects based on localState.owned counts
          Object.keys(localState.owned).forEach(id=>{
            const n = localState.owned[id]||0;
            const eff = PERM_EFFECTS[id];
            if(!eff || n<=0) return;
            // simple linear stacking
            Object.entries(eff).forEach(([k,v])=>{ out[k] = (out[k]||0) + v * n; });
          });
          // temp flags impact numeric stats
          if(tempFlags.ARM) out.ARM = (out.ARM||0) + tempFlags.ARM;
          if(tempFlags.SPD) out.SPD = (out.SPD||1) + tempFlags.SPD;
          return out;
        }

        function recomputeAndPublishStats(){
          // rebuild temps from active cooldown states
          tempFlags = {};
          try{
            (window.consumBar?.slots||[]).forEach((s, i)=>{
              const inv = localState.inv[i];
              if(!s || !inv) return;
              if(s.cooldownUntil && s.cooldownUntil>Date.now()){
                const tf = TEMP_EFFECTS[inv.id]?.(true) || {};
                // numeric merges
                if(tf.ARM) tempFlags.ARM = (tempFlags.ARM||0)+tf.ARM;
                if(tf.SPD) tempFlags.SPD = (tempFlags.SPD||0)+tf.SPD;
              }
            });
          }catch(_){ }
          const stats = aggregateOwnedEffects();
          // publish to central state and UI
          const g = (typeof window!=='undefined') ? (window.game=window.game||{}) : {};
          g.stats = { ...stats };
          if(window.shopUI?.setStats) window.shopUI.setStats(g.stats);
        }

        // initial stats draw
        recomputeAndPublishStats();
      })();
    </script>
    <!-- Background music element -->
    <audio id="bgm" preload="auto" loop>
      <source src="elementist1.AAC" type="audio/aac" />
      <source src="elementist2.MP3" type="audio/mpeg" />
    </audio>
    <!-- Main menu button wiring: Characters / Builds -->
    <script>
      (function(){
        function goCharacters(){
          try { if (window.openCharactersOverlay) { window.openCharactersOverlay(); return; } } catch(_){ }
          // No fallback navigation; characters overlay is required
        }
        function goBuilds(){
          try { if (window.openBuildsOverlay) { window.openBuildsOverlay(); return; } } catch(_){ }
          // No fallback navigation; builds overlay is required
        }
        function bind(id, fn){
          try{
            var el = document.getElementById(id);
            if(!el) return;
            el.addEventListener('click', function(e){ try{ e.preventDefault(); }catch(_){ } fn(); });
          }catch(_){}
        }
        if (document.readyState !== 'loading'){
          bind('charactersBtn', goCharacters);
          bind('buildsBtn', goBuilds);
        } else {
          document.addEventListener('DOMContentLoaded', function(){
            bind('charactersBtn', goCharacters);
            bind('buildsBtn', goBuilds);
          });
        }
      })();
    </script>
    <!-- Characters wiring handled in glowlings.js to match Builds behavior -->
    
    <!-- Firebase Authentication for Gameist -->
    <script src="../auth-component.js?v=2"></script>
    
    <!-- Game-specific leaderboard integration -->
    <script>
      // Elementist-specific leaderboard integration
      document.addEventListener('DOMContentLoaded', function() {
        // Wait for auth component to initialize
        setTimeout(() => {
          if (window.gameistAuth) {
            console.log(' Elementist auth integration ready');
            
            // Function to get current score from Elementist
            function getElementistScore() {
              try {
                return parseInt(document.getElementById('score')?.textContent || '0', 10) || 0;
              } catch (error) {
                console.error('Error getting Elementist score:', error);
                return 0;
              }
            }
            
            // Hook into existing stats recording system
            const originalRecordRun = window.recordRun;
            if (typeof originalRecordRun === 'function') {
              window.recordRun = function() {
                // Call original function first
                const result = originalRecordRun.apply(this, arguments);
                
                // Then save to our leaderboard
                const user = window.gameistAuth.getCurrentUser();
                const score = getElementistScore();
                
                if (user && score > 0) {
                  console.log(' Saving Elementist score:', score);
                  console.log(' User info:', { displayName: user.displayName, uid: user.uid });
                  
                  window.gameistAuth.saveScore('elementist', score)
                    .then(() => {
                      console.log(' Elementist score saved to leaderboard:', score);
                      showScoreSavedNotification();
                      
                      // Notify main page about the score update
                      notifyMainPageStatsUpdate(user.uid);
                      
                      // Verify the score was actually saved by checking Firestore
                      setTimeout(() => {
                        verifyScoreInFirestore(user.uid, score);
                      }, 2000);
                    })
                    .catch(error => {
                      console.error(' Failed to save Elementist score:', error);
                      console.error(' Error details:', error.code, error.message);
                    });
                } else {
                  console.log(' No user logged in or score is 0, skipping leaderboard save');
                  console.log(' User:', user ? user.uid : 'null', 'Score:', score);
                }
                
                return result;
              };
            }
            
            // Also hook into game over screen visibility
            const gameOverScreen = document.getElementById('gameOverScreen');
            if (gameOverScreen) {
              const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                  if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                    const isVisible = window.getComputedStyle(gameOverScreen).display !== 'none';
                    if (isVisible) {
                      // Game over screen is visible, save score
                      setTimeout(() => {
                        const user = window.gameistAuth.getCurrentUser();
                        const score = getElementistScore();
                        
                        if (user && score > 0) {
                          console.log(' Game over detected, saving score:', score);
                          window.gameistAuth.saveScore('elementist', score)
                            .then(() => {
                              console.log(' Elementist score saved on game over:', score);
                              showScoreSavedNotification();
                              
                              // Notify main page about the score update
                              notifyMainPageStatsUpdate(user.uid);
                            })
                            .catch(error => {
                              console.error(' Failed to save Elementist score on game over:', error);
                            });
                        }
                      }, 1000); // Wait 1 second for score to finalize
                    }
                  }
                });
              });
              
              observer.observe(gameOverScreen, { attributes: true });
            }
            
            // Cross-page communication function using BroadcastChannel
            function notifyMainPageStatsUpdate(userId) {
              try {
                // Use BroadcastChannel for reliable communication
                const channel = new BroadcastChannel('gameist_stats');
                const message = {
                  type: 'statsUpdate',
                  userId: userId,
                  game: 'elementist',
                  score: getElementistScore(),
                  timestamp: Date.now()
                };
                
                channel.postMessage(message);
                console.log(' Sent stats update via BroadcastChannel:', message);
                
                // Also store in localStorage as fallback
                localStorage.setItem('gameist_stats_update_needed', JSON.stringify(message));
                
                console.log(' Notified main page about stats update via BroadcastChannel');
              } catch (error) {
                console.error(' Failed to notify main page:', error);
              }
            }
            
            // Verify score was actually saved to Firestore
            function verifyScoreInFirestore(userId, expectedScore) {
              try {
                console.log(' Verifying score in Firestore for user:', userId, 'expected score:', expectedScore);
                
                const database = window.gameistAuth ? window.gameistAuth.db : null;
                if (!database) {
                  console.error(' No database available for verification');
                  return;
                }
                
                database.collection('leaderboard')
                  .where('userId', '==', userId)
                  .where('game', '==', 'elementist')
                  .orderBy('timestamp', 'desc')
                  .limit(5)
                  .get()
                  .then((snapshot) => {
                    const scores = snapshot.docs.map(doc => doc.data());
                    console.log(' Recent Elementist scores in Firestore:', scores);
                    
                    const foundScore = scores.find(s => s.score === expectedScore);
                    if (foundScore) {
                      console.log(' Score verification successful - found score:', foundScore.score, 'at:', foundScore.timestamp);
                    } else {
                      console.log(' Score not found in recent entries. All scores:', scores.map(s => s.score));
                    }
                  })
                  .catch((error) => {
                    console.error(' Error verifying score in Firestore:', error);
                  });
              } catch (error) {
                console.error(' Verification function error:', error);
              }
            }
            
            // Periodic score save (every 30 seconds) - only for logged in users
            setInterval(() => {
              const user = window.gameistAuth.getCurrentUser();
              const score = getElementistScore();
              
              if (user && score > 0) {
                window.gameistAuth.saveScore('elementist', score)
                  .catch(error => {
                    // Silent fail for periodic saves
                    console.log(' Periodic save failed:', error.message);
                  });
              }
            }, 30000);
            
            console.log(' Elementist leaderboard hooks installed');
            
            // Monitor Elementist's own stats and sync to main index
            monitorElementistStats();
          }
        }, 2000);
      });
      
      // Function to get Elementist's current stats (moved here for button access)
      function getElementistNativeStats() {
        try {
          const bestScoreEl = document.getElementById('statsBestScore');
          const bestWaveEl = document.getElementById('statsBestWave');
          const lastRunsEl = document.getElementById('statsLastRuns');
          
          return {
            bestScore: parseInt(bestScoreEl?.textContent || '0', 10) || 0,
            bestWave: parseInt(bestWaveEl?.textContent || '0', 10) || 0,
            lastRuns: lastRunsEl?.textContent || '0'
          };
        } catch (error) {
          console.error(' Error getting Elementist stats:', error);
          return { bestScore: 0, bestWave: 0, lastRuns: '0' };
        }
      }
      
      // Monitor Elementist's native stats system
      function monitorElementistStats() {
        console.log(' Starting Elementist stats monitoring');
        
        // Function to sync stats to main index
        function syncStatsToMainIndex() {
          const user = window.gameistAuth.getCurrentUser();
          const stats = getElementistNativeStats();
          
          if (user && stats.bestScore > 0) {
            console.log(' Syncing Elementist stats to main index:', stats);
            
            // Save best score to our leaderboard
            console.log(' Attempting to save score to Firestore...');
            console.log(' Auth component available:', !!window.gameistAuth);
            console.log(' SaveScore method available:', !!(window.gameistAuth && window.gameistAuth.saveScore));
            console.log(' Database reference:', window.gameistAuth ? window.gameistAuth.db : 'null');
            
            if (!window.gameistAuth) {
              console.error(' window.gameistAuth not available');
              return;
            }
            
            if (!window.gameistAuth.saveScore) {
              console.error(' saveScore method not available');
              return;
            }
            
            // FAST SYNC: Save directly to Realtime Database FIRST (no waiting)
            console.log(' FAST SYNC: Saving directly to Realtime Database first...');
            try {
              const database = firebase.database();
              const userScoresRef = database.ref(`userScores/${user.uid}`);
              const newScoreRef = userScoresRef.push();
              
              newScoreRef.set({
                userId: user.uid,
                displayName: user.displayName,
                email: user.email,
                score: stats.bestScore,
                game: 'elementist',
                timestamp: Date.now(),
                fastSync: true,
                fromElementist: true
              }).then(() => {
                console.log(' FAST SYNC: Score saved to Realtime Database immediately');
                
                // Notify main menu immediately
                try {
                  const channel = new BroadcastChannel('gameist_stats');
                  channel.postMessage({
                    type: 'statsUpdate',
                    userId: user.uid,
                    game: 'elementist',
                    score: stats.bestScore,
                    timestamp: Date.now(),
                    firestoreSuccess: true,
                    fastSync: true
                  });
                } catch (error) {
                  console.log('BroadcastChannel not available');
                }
              });
            } catch (error) {
              console.error(' FAST SYNC failed:', error);
            }

            // Then save to Firestore (async, no blocking)
            window.gameistAuth.saveScore('elementist', stats.bestScore)
              .then((result) => {
                console.log(' Elementist best score synced to Firestore:', stats.bestScore);
                
                // If Firestore failed, we already saved to Realtime Database above
                if (result === false) {
                  console.log(' Firestore failed, but Realtime Database already has the score');
                }
              });
                
                // Notify main page about the update using BroadcastChannel
                try {
                  const channel = new BroadcastChannel('gameist_stats');
                  const message = {
                    type: 'statsUpdate',
                    userId: user.uid,
                    game: 'elementist',
                    score: stats.bestScore,
                    timestamp: Date.now(),
                    firestoreSuccess: result !== false
                  };
                  
                  channel.postMessage(message);
                  console.log(' Sent stats update via BroadcastChannel:', message);
                  console.log(' Channel state:', channel ? 'open' : 'closed');
                  
                  // Also store in localStorage as fallback for cross-tab communication
                  localStorage.setItem('gameist_stats_update_needed', JSON.stringify(message));
                  console.log(' Stored fallback in localStorage:', message);
                } catch (error) {
                  console.error(' Error sending BroadcastChannel message:', error);
                  // Still store in localStorage as fallback
                  localStorage.setItem('gameist_stats_update_needed', JSON.stringify({
                    type: 'statsUpdate',
                    userId: user.uid,
                    game: 'elementist',
                    score: stats.bestScore,
                    timestamp: Date.now(),
                    firestoreSuccess: false
                  }));
                }
              });
            }
          });
        }
        
        // Monitor stats changes every 5 seconds
        setInterval(() => {
          syncStatsToMainIndex();
        }, 5000);
        
        // Also sync immediately when game over screen appears
        const gameOverScreen = document.getElementById('gameOverScreen');
        if (gameOverScreen) {
          const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
              if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                const hasGameOverContent = Array.from(mutation.addedNodes).some(node => {
                  return node.nodeType === Node.ELEMENT_NODE && 
                         (node.querySelector('#statsBestScore') || node.textContent.includes('Game Over'));
                });
                
                if (hasGameOverContent) {
                  setTimeout(syncStatsToMainIndex, 1000);
                }
              }
            });
          });
          
          observer.observe(gameOverScreen, {
            childList: true,
            subtree: true
          });
        }
      }
      
      // Show score saved notification
      function showScoreSavedNotification() {
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          left: 50%;
          transform: translateX(-50%);
          background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
          color: white;
          padding: 12px 24px;
          border-radius: 8px;
          font-weight: 600;
          z-index: 99999;
          box-shadow: 0 4px 12px rgba(34,197,94,0.4);
          animation: slideDown 0.3s ease;
        `;
        notification.textContent = ' Score saved to leaderboard!';
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.style.animation = 'slideUp 0.3s ease';
          setTimeout(() => notification.remove(), 300);
        }, 2000);
      }
      
      // Add animations
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideDown {
          from { transform: translate(-50%, -100%); opacity: 0; }
          to { transform: translate(-50%, 0); opacity: 1; }
        }
        @keyframes slideUp {
          from { transform: translate(-50%, 0); opacity: 1; }
          to { transform: translate(-50%, -100%); opacity: 0; }
        }
      `;
      document.head.appendChild(style);
    </script>
  </body>
</html>
