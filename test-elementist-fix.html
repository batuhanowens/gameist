<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elementist Score Fix Test</title>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: all 0.3s ease;
        }
        button:hover {
            background: #3367d6;
            transform: translateY(-2px);
        }
        .status {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .info { color: #60a5fa; }
        .warning { color: #fbbf24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ® Elementist Score Fix Test</h1>
        <p>Bu test, Elementist oyunundan ana menÃ¼ye skor gÃ¶nderimini doÄŸrular.</p>
        
        <div>
            <button onclick="testScoreSaving()">ğŸ§ª Test Skor Kaydetme</button>
            <button onclick="testLocalStorageFormat()">ğŸ’¾ localStorage Format Test</button>
            <button onclick="testFirestoreConnection()">ğŸ”¥ Firestore BaÄŸlantÄ± Test</button>
            <button onclick="clearTestData()">ğŸ—‘ï¸ Test Verilerini Temizle</button>
        </div>
        
        <div id="status" class="status">Test sonuÃ§larÄ± burada gÃ¶rÃ¼necek...</div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD7ckcqdZWfnUx5r8uKmvu9Ikax1x5Qidk",
            authDomain: "gameist.firebaseapp.com",
            projectId: "gameist",
            storageBucket: "gameist.firebasestorage.app",
            messagingSenderId: "525659299937",
            appId: "1:525659299937:web:1c8343a25be2a994bcca20",
            measurementId: "G-WE9R0GWKM6",
            databaseURL: "https://gameist-default-rtdb.firebaseio.com/"
        };
        
        firebase.initializeApp(firebaseConfig);
        
        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info';
            statusEl.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            statusEl.scrollTop = statusEl.scrollHeight;
        }
        
        // Simulate the saveScoreToGameist function from Elementist
        function saveScoreToGameist(score, wave) {
            return new Promise((resolve, reject) => {
                try {
                    updateStatus(`ğŸ® Elementist skor kaydetme simÃ¼lasyonu: { score: ${score}, wave: ${wave} }`, 'info');
                    
                    // Get current user from Firebase Auth
                    firebase.auth().onAuthStateChanged(user => {
                        if (user) {
                            updateStatus(`ğŸ‘¤ KullanÄ±cÄ± bulundu: ${user.displayName}`, 'success');
                            
                            // Save to Firebase Firestore leaderboard collection
                            const db = firebase.firestore();
                            const leaderboardEntry = {
                                userId: user.uid,
                                displayName: user.displayName || 'Anonymous',
                                photoURL: user.photoURL || '',
                                email: user.email,
                                game: 'elementist',
                                score: Math.floor(score),
                                wave: wave,
                                timestamp: Date.now(),
                                character: 'berserker', // Simulated
                                element: 'fire' // Simulated
                            };
                            
                            db.collection('leaderboard').add(leaderboardEntry)
                                .then((docRef) => {
                                    updateStatus(`âœ… Skor Firestore'a kaydedildi! Document ID: ${docRef.id}`, 'success');
                                    
                                    // Also save to localStorage fallback
                                    try {
                                        const localScores = JSON.parse(localStorage.getItem('gameist_local_scores') || '[]');
                                        localScores.push({
                                            ...leaderboardEntry,
                                            timestamp: Date.now()
                                        });
                                        localStorage.setItem('gameist_local_scores', JSON.stringify(localScores.slice(-50)));
                                        updateStatus('âœ… localStorage fallback baÅŸarÄ±yla gÃ¼ncellendi', 'success');
                                    } catch (localError) {
                                        updateStatus(`âš ï¸ localStorage hatasÄ±: ${localError.message}`, 'warning');
                                    }
                                    
                                    resolve(docRef);
                                })
                                .catch(error => {
                                    updateStatus(`âŒ Firestore hatasÄ±: ${error.message}`, 'error');
                                    reject(error);
                                });
                                
                        } else {
                            updateStatus('âŒ KullanÄ±cÄ± giriÅŸi gerekli', 'error');
                            reject(new Error('No authenticated user'));
                        }
                    });
                    
                } catch (error) {
                    updateStatus(`âŒ Genel hata: ${error.message}`, 'error');
                    reject(error);
                }
            });
        }
        
        function testScoreSaving() {
            updateStatus('ğŸ§ª Elementist skor kaydetme testi baÅŸlatÄ±lÄ±yor...', 'info');
            
            const testScore = 15000;
            const testWave = 7;
            
            saveScoreToGameist(testScore, testWave)
                .then(() => {
                    updateStatus('ğŸ‰ Test baÅŸarÄ±yla tamamlandÄ±!', 'success');
                })
                .catch((error) => {
                    updateStatus(`âŒ Test baÅŸarÄ±sÄ±z: ${error.message}`, 'error');
                });
        }
        
        function testLocalStorageFormat() {
            updateStatus('ğŸ’¾ localStorage format testi baÅŸlatÄ±lÄ±yor...', 'info');
            
            try {
                // Check current localStorage
                const localScores = JSON.parse(localStorage.getItem('gameist_local_scores') || '[]');
                updateStatus(`ğŸ“Š Mevcut localStorage skor sayÄ±sÄ±: ${localScores.length}`, 'info');
                
                // Show last few scores
                const recentScores = localScores.slice(-3);
                recentScores.forEach((score, index) => {
                    updateStatus(`ğŸ“„ Skor ${index + 1}: ${score.game} - ${score.score} (${new Date(score.timestamp).toLocaleString()})`, 'info');
                });
                
                // Check if format matches what main menu expects
                const hasRequiredFields = localScores.every(score => 
                    score.userId && score.game && score.score && score.timestamp
                );
                
                if (hasRequiredFields) {
                    updateStatus('âœ… localStorage formatÄ± ana menÃ¼ ile uyumlu', 'success');
                } else {
                    updateStatus('âŒ localStorage formatÄ± uyumsuz', 'error');
                }
                
            } catch (error) {
                updateStatus(`âŒ localStorage test hatasÄ±: ${error.message}`, 'error');
            }
        }
        
        function testFirestoreConnection() {
            updateStatus('ğŸ”¥ Firestore baÄŸlantÄ± testi baÅŸlatÄ±lÄ±yor...', 'info');
            
            try {
                const db = firebase.firestore();
                
                // Test read access
                db.collection('leaderboard')
                    .where('game', '==', 'elementist')
                    .orderBy('score', 'desc')
                    .limit(5)
                    .get()
                    .then((snapshot) => {
                        updateStatus(`âœ… Firestore baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±! ${snapshot.docs.length} skor bulundu`, 'success');
                        
                        snapshot.docs.forEach((doc, index) => {
                            const data = doc.data();
                            updateStatus(`ğŸ“„ ${index + 1}. ${data.displayName}: ${data.score} (${data.game})`, 'info');
                        });
                    })
                    .catch((error) => {
                        updateStatus(`âŒ Firestore okuma hatasÄ±: ${error.message}`, 'error');
                    });
                    
            } catch (error) {
                updateStatus(`âŒ Firestore baÄŸlantÄ± hatasÄ±: ${error.message}`, 'error');
            }
        }
        
        function clearTestData() {
            updateStatus('ğŸ—‘ï¸ Test verileri temizleniyor...', 'info');
            
            try {
                localStorage.removeItem('gameist_local_scores');
                updateStatus('âœ… localStorage temizlendi', 'success');
            } catch (error) {
                updateStatus(`âŒ Temizleme hatasÄ±: ${error.message}`, 'error');
            }
        }
        
        // Initialize
        window.addEventListener('load', () => {
            updateStatus('ğŸš€ Elementist Score Fix Test baÅŸlatÄ±lÄ±yor...', 'info');
            
            // Check Firebase connection
            setTimeout(() => {
                try {
                    const db = firebase.firestore();
                    updateStatus('âœ… Firebase Firestore baÅŸlatÄ±ldÄ±', 'success');
                } catch (error) {
                    updateStatus(`âŒ Firebase baÅŸlatma hatasÄ±: ${error.message}`, 'error');
                }
            }, 1000);
        });
    </script>
</body>
</html>
